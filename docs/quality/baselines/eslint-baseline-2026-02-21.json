[{"filePath":"/Users/eero/development/freakon/eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/admin/page.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'AdminPage' has a complexity of 28. Maximum allowed is 12.","line":52,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":52,"endColumn":34},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 21 to the 15 allowed.","line":238,"column":32,"nodeType":null,"messageId":"refactorFunction","endLine":238,"endColumn":34},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (504). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":505,"endColumn":1},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":464,"column":21,"nodeType":"JSXOpeningElement","endLine":468,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Shield, UserPlus, Trophy, ScrollText, Settings2, BarChart3 } from 'lucide-react';\nimport { trophyLocalIconUrl } from '@/lib/trophies';\nimport { Input } from '@/components/ui/Input';\nimport { Button } from '@/components/ui/button';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\nimport { EventsPanel } from '@/components/admin/EventsPanel';\nimport { UsersSection } from '@/components/admin/UsersSection';\nimport { TagsSection } from '@/components/admin/TagsSection';\nimport { TagGroupsSection } from '@/components/admin/TagGroupsSection';\nimport type { PendingUser } from '@/components/admin/types';\nimport { useAdminTagManagement } from '@/components/admin/useAdminTagManagement';\n\ninterface TrophyOverview {\n  id: number;\n  code: string;\n  name: string;\n  points: number;\n  icon_path: string | null;\n  source: string;\n  awarded_count: number;\n}\n\ntype AdminTab = 'board' | 'users' | 'tags' | 'tag_groups' | 'trophies' | 'levels' | 'events';\nconst ADMIN_TABS: AdminTab[] = ['board', 'events', 'trophies', 'users', 'tags', 'tag_groups', 'levels'];\nconst ADMIN_TAB_HASH: Record<AdminTab, string> = {\n  board: 'board',\n  events: 'events',\n  trophies: 'trophies',\n  users: 'users',\n  tags: 'tags',\n  tag_groups: 'tag-groups',\n  levels: 'levels',\n};\nconst SITE_SETTINGS_UPDATED_EVENT = 'site-settings-updated';\n\nfunction isAdminTab(value: string): value is AdminTab {\n  return ADMIN_TABS.includes(value as AdminTab);\n}\n\nfunction parseAdminHash(value: string): AdminTab | null {\n  const normalized = value.replace('#', '').toLowerCase();\n  if (normalized === 'tag-groups') return 'tag_groups';\n  if (isAdminTab(normalized)) return normalized;\n  return null;\n}\n\nexport default function AdminPage() {\n  const { profile, supabase, loading } = useAuth();\n  const [activeTab, setActiveTab] = useState<AdminTab>('board');\n  const [registrationEnabled, setRegistrationEnabled] = useState(true);\n  const [toggling, setToggling] = useState(false);\n  const [notificationEnabled, setNotificationEnabled] = useState(false);\n  const [notificationToggling, setNotificationToggling] = useState(false);\n  const [notificationMessage, setNotificationMessage] = useState('');\n  const [savingNotificationMessage, setSavingNotificationMessage] = useState(false);\n  const [settingsLoading, setSettingsLoading] = useState(true);\n  const [trophyLoading, setTrophyLoading] = useState(true);\n  const [pendingUsersLoading, setPendingUsersLoading] = useState(true);\n  const [trophyOverview, setTrophyOverview] = useState<TrophyOverview[]>([]);\n  const [pendingUsers, setPendingUsers] = useState<PendingUser[]>([]);\n  const [processingUserId, setProcessingUserId] = useState<string | null>(null);\n  const [totalAwardedTrophies, setTotalAwardedTrophies] = useState(0);\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n  const tagManagement = useAdminTagManagement(supabase);\n\n  useEffect(() => {\n    const fetchAdminData = async () => {\n      const [settingsRes, overviewRes, awardedRes] = await Promise.all([\n        supabase\n          .from('site_settings')\n          .select('key, value')\n          .in('key', ['registration_enabled', 'notification_enabled', 'notification_message']),\n        supabase\n          .from('admin_trophy_overview')\n          .select('id, code, name, points, icon_path, source, awarded_count')\n          .order('points', { ascending: false })\n          .order('name', { ascending: true }),\n        supabase\n          .from('profile_trophies')\n          .select('*', { count: 'exact', head: true }),\n      ]);\n      const pendingRes = await supabase\n        .from('profiles')\n        .select('id, username, created_at')\n        .eq('approval_status', 'pending')\n        .order('created_at', { ascending: true });\n\n      if (settingsRes.data) {\n        const settings = settingsRes.data as { key: string; value: string }[];\n        const map = new Map(settings.map((row) => [row.key, row.value]));\n        setRegistrationEnabled(map.get('registration_enabled') === 'true');\n        setNotificationEnabled(map.get('notification_enabled') === 'true');\n        setNotificationMessage(map.get('notification_message') || '');\n      }\n      if (overviewRes.data) {\n        setTrophyOverview(overviewRes.data as TrophyOverview[]);\n      }\n      if (!pendingRes.error && pendingRes.data) {\n        setPendingUsers(pendingRes.data as PendingUser[]);\n      }\n      setTotalAwardedTrophies(awardedRes.count || 0);\n\n      setSettingsLoading(false);\n      setTrophyLoading(false);\n      setPendingUsersLoading(false);\n    };\n\n    fetchAdminData();\n  }, [supabase]);\n\n  useEffect(() => {\n    const syncTabFromHash = () => {\n      const tabFromHash = parseAdminHash(window.location.hash);\n      if (tabFromHash) {\n        setActiveTab(tabFromHash);\n      } else if (window.location.hash) {\n        setActiveTab('board');\n      }\n    };\n\n    syncTabFromHash();\n    window.addEventListener('hashchange', syncTabFromHash);\n    return () => window.removeEventListener('hashchange', syncTabFromHash);\n  }, []);\n\n  useEffect(() => {\n    const nextHash = `#${ADMIN_TAB_HASH[activeTab]}`;\n    if (window.location.hash !== nextHash) {\n      window.history.replaceState(null, '', nextHash);\n    }\n  }, [activeTab]);\n\n  const handleToggleRegistration = async () => {\n    setToggling(true);\n    const newValue = !registrationEnabled;\n\n    const { error } = await supabase.rpc('update_site_setting', {\n      setting_key: 'registration_enabled',\n      setting_value: String(newValue),\n    });\n\n    if (!error) {\n      setRegistrationEnabled(newValue);\n      window.dispatchEvent(new Event(SITE_SETTINGS_UPDATED_EVENT));\n    }\n    setToggling(false);\n  };\n\n  const handleToggleNotification = async () => {\n    setNotificationToggling(true);\n    const newValue = !notificationEnabled;\n\n    const { error } = await supabase.rpc('update_site_setting', {\n      setting_key: 'notification_enabled',\n      setting_value: String(newValue),\n    });\n\n    if (!error) {\n      setNotificationEnabled(newValue);\n      window.dispatchEvent(new Event(SITE_SETTINGS_UPDATED_EVENT));\n    }\n\n    setNotificationToggling(false);\n  };\n\n  const handleSaveNotificationMessage = async () => {\n    setSavingNotificationMessage(true);\n\n    await supabase.rpc('update_site_setting', {\n      setting_key: 'notification_message',\n      setting_value: notificationMessage.trim(),\n    });\n\n    window.dispatchEvent(new Event(SITE_SETTINGS_UPDATED_EVENT));\n    setSavingNotificationMessage(false);\n  };\n\n  const refreshPendingUsers = async () => {\n    const { data } = await supabase\n      .from('profiles')\n      .select('id, username, created_at')\n      .eq('approval_status', 'pending')\n      .order('created_at', { ascending: true });\n\n    setPendingUsers((data ?? []) as PendingUser[]);\n  };\n\n  const handleSetApprovalStatus = async (userId: string, status: 'approved' | 'rejected') => {\n    setProcessingUserId(userId);\n    const { error } = await supabase.rpc('set_profile_approval_status', {\n      target_user_id: userId,\n      new_status: status,\n    });\n\n    if (!error) {\n      await refreshPendingUsers();\n    }\n    setProcessingUserId(null);\n  };\n\n  if (loading || settingsLoading || trophyLoading || pendingUsersLoading) {\n    return (\n      <div className=\"page-container\">\n        <Card>\n          <p className=\"state-empty-text\">Ladataan...</p>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!profile?.is_admin) {\n    return (\n      <div className=\"page-container\">\n        <Card>\n          <h2 className=\"card-title flex items-center gap-2\">\n            {showHeaderIcons && <Shield size={20} className=\"text-yellow-600\" />}\n            Ei k√§ytt√∂oikeutta\n          </h2>\n          <p className=\"text-gray-500 mt-2\">T√§m√§ sivu on vain yll√§pit√§jille.</p>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"page-container space-y-6\">\n      <div className=\"flex items-center gap-3\">\n        <Shield size={28} className=\"text-yellow-600\" />\n        <h1 className=\"text-3xl font-bold\">Admin</h1>\n      </div>\n\n      <div className=\"page-tabs mb-4\">\n        {(ADMIN_TABS.map((tab) => (\n          [\n            tab,\n            tab === 'board'\n              ? 'Boardi'\n              : tab === 'events'\n                ? 'Tapahtumat'\n                : tab === 'trophies'\n                  ? 'Pokaalit'\n                  : tab === 'users'\n                    ? 'K√§ytt√§j√§t'\n                    : tab === 'tags'\n                      ? 'Tagit'\n                      : tab === 'tag_groups'\n                        ? 'Tagiryhm√§t'\n                        : 'Tasot',\n          ] as [AdminTab, string]\n        ))).map(([value, label]) => (\n          <a\n            key={value}\n            href={`#${ADMIN_TAB_HASH[value]}`}\n            onClick={() => setActiveTab(value)}\n            className={`page-tab-button ${activeTab === value ? 'is-active' : ''}`}\n          >\n            {label}\n          </a>\n        ))}\n      </div>\n\n      {activeTab === 'board' && (\n        <Card>\n          <div className=\"section-head-row\">\n            {showHeaderIcons && <Settings2 size={24} className=\"text-yellow-600\" />}\n            <h2 className=\"card-title mb-0\">Boardin asetukset</h2>\n          </div>\n\n          <div className=\"flex items-center justify-between px-3\">\n            <div className=\"flex items-center gap-3\">\n              <UserPlus size={20} className=\"text-gray-600\" />\n              <div>\n                <p className=\"font-medium\">Rekister√∂ityminen</p>\n                <p className=\"text-muted-sm\">\n                  {registrationEnabled\n                    ? 'Portit auki.'\n                    : 'Portit kiinni.'}\n                </p>\n              </div>\n            </div>\n            <button\n              onClick={handleToggleRegistration}\n              disabled={toggling}\n              className={`relative inline-flex h-7 w-12 items-center rounded-full transition ${\n                registrationEnabled ? 'bg-green-500' : 'bg-gray-300'\n              } ${toggling ? 'opacity-50' : ''}`}\n            >\n              <span\n                className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${\n                  registrationEnabled ? 'translate-x-6' : 'translate-x-1'\n                }`}\n              />\n            </button>\n          </div>\n\n          <div className=\"section-block\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <ScrollText size={20} className=\"text-gray-600\" />\n                <div>\n                <p className=\"font-medium\">Ilmoitusraita</p>\n                <p className=\"text-muted-sm\">\n                  {notificationEnabled ? 'Raita n√§kyy kirjautuneille k√§ytt√§jille' : 'Raita on pois p√§√§lt√§'}\n                </p>\n                </div>\n              </div>\n              <button\n                onClick={handleToggleNotification}\n                disabled={notificationToggling}\n                className={`relative inline-flex h-7 w-12 items-center rounded-full transition ${\n                  notificationEnabled ? 'bg-green-500' : 'bg-gray-300'\n                } ${notificationToggling ? 'opacity-50' : ''}`}\n              >\n                <span\n                  className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${\n                    notificationEnabled ? 'translate-x-6' : 'translate-x-1'\n                  }`}\n                />\n              </button>\n            </div>\n\n            <div className=\"mt-4\">\n              <label htmlFor=\"notificationMessage\" className=\"block text-sm text-gray-700 mb-1\">\n                Ilmoitusviesti\n              </label>\n              <div className=\"flex items-center gap-2\">\n                <Input\n                  id=\"notificationMessage\"\n                  value={notificationMessage}\n                  onChange={(e: React.ChangeEvent<HTMLInputElement>) => setNotificationMessage(e.target.value)}\n                  placeholder=\"Kirjoita ilmoitusviesti...\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"primary\"\n                  onClick={handleSaveNotificationMessage}\n                  disabled={savingNotificationMessage}\n                >\n                  {savingNotificationMessage ? 'Tallennetaan...' : 'Tallenna'}\n                </Button>\n              </div>\n            </div>\n          </div>\n\n        </Card>\n      )}\n\n      {activeTab === 'users' && (\n        <UsersSection\n          showHeaderIcons={showHeaderIcons}\n          pendingUsers={pendingUsers}\n          processingUserId={processingUserId}\n          onSetApprovalStatus={handleSetApprovalStatus}\n        />\n      )}\n\n      {activeTab === 'tags' && (\n        <TagsSection\n          showHeaderIcons={showHeaderIcons}\n          unreviewedTags={tagManagement.unreviewedTags}\n          canonicalTags={tagManagement.canonicalTags}\n          tagGroups={tagManagement.tagGroups}\n          newTagName={tagManagement.newTagName}\n          newTagSlug={tagManagement.newTagSlug}\n          creatingTag={tagManagement.creatingTag}\n          mergeTargetByTagId={tagManagement.mergeTargetByTagId}\n          processingTagId={tagManagement.processingTagId}\n          tagActionError={tagManagement.tagActionError}\n          aliasSearch={tagManagement.aliasSearch}\n          editingTagId={tagManagement.editingTagId}\n          editingTagName={tagManagement.editingTagName}\n          editingTagSlug={tagManagement.editingTagSlug}\n          editingTagGroupIds={tagManagement.editingTagGroupIds}\n          deleteReplacementTagId={tagManagement.deleteReplacementTagId}\n          aliasInputByTagId={tagManagement.aliasInputByTagId}\n          tagAliasesByTagId={tagManagement.tagAliasesByTagId}\n          addingAliasTagId={tagManagement.addingAliasTagId}\n          processingAliasId={tagManagement.processingAliasId}\n          onModerateTag={tagManagement.handleModerateTag}\n          onMergeTargetChange={(tagId, target) =>\n            tagManagement.setMergeTargetByTagId((prev) => ({ ...prev, [tagId]: target }))\n          }\n          onMergeTag={tagManagement.handleMergeTag}\n          onAliasSearchChange={tagManagement.setAliasSearch}\n          onBeginRenameTag={tagManagement.beginRenameTag}\n          onCancelRenameTag={tagManagement.cancelRenameTag}\n          onEditingTagNameChange={tagManagement.setEditingTagName}\n          onEditingTagSlugChange={tagManagement.setEditingTagSlug}\n          onEditingTagGroupIdsChange={tagManagement.setEditingTagGroupIds}\n          onDeleteReplacementTagIdChange={tagManagement.setDeleteReplacementTagId}\n          onSaveTagCard={tagManagement.handleSaveTagCard}\n          onAliasInputChange={(tagId, value) =>\n            tagManagement.setAliasInputByTagId((prev) => ({ ...prev, [tagId]: value }))\n          }\n          onAddAlias={tagManagement.handleAddAlias}\n          onDeleteAlias={tagManagement.handleDeleteAlias}\n          onDeleteTag={tagManagement.handleDeleteTag}\n          onNewTagNameChange={tagManagement.setNewTagName}\n          onNewTagSlugChange={tagManagement.setNewTagSlug}\n          onCreateTag={tagManagement.handleCreateTag}\n        />\n      )}\n\n      {activeTab === 'tag_groups' && (\n        <TagGroupsSection\n          showHeaderIcons={showHeaderIcons}\n          tagGroupActionError={tagManagement.tagGroupActionError}\n          newGroupName={tagManagement.newGroupName}\n          newGroupSlug={tagManagement.newGroupSlug}\n          newGroupDescription={tagManagement.newGroupDescription}\n          newGroupSearchable={tagManagement.newGroupSearchable}\n          newGroupKind={tagManagement.newGroupKind}\n          processingGroupId={tagManagement.processingGroupId}\n          tagGroups={tagManagement.tagGroups}\n          groupTagQueryByGroupId={tagManagement.groupTagQueryByGroupId}\n          tagGroupAliasesByGroupId={tagManagement.tagGroupAliasesByGroupId}\n          groupAliasInputByGroupId={tagManagement.groupAliasInputByGroupId}\n          processingGroupAliasId={tagManagement.processingGroupAliasId}\n          addingAliasGroupId={tagManagement.addingAliasGroupId}\n          canonicalTagToToken={tagManagement.canonicalTagToToken}\n          buildGroupTagOptions={tagManagement.buildGroupTagOptions}\n          onNewGroupNameChange={tagManagement.setNewGroupName}\n          onNewGroupSlugChange={tagManagement.setNewGroupSlug}\n          onNewGroupDescriptionChange={tagManagement.setNewGroupDescription}\n          onNewGroupSearchableChange={tagManagement.setNewGroupSearchable}\n          onNewGroupKindChange={tagManagement.setNewGroupKind}\n          onCreateTagGroup={tagManagement.handleCreateTagGroup}\n          onTagGroupsChange={tagManagement.setTagGroups}\n          onGroupTagQueryChange={(groupId, value) =>\n            tagManagement.setGroupTagQueryByGroupId((prev) => ({ ...prev, [groupId]: value }))\n          }\n          onSaveTagGroup={tagManagement.handleSaveTagGroup}\n          onDeleteTagGroup={tagManagement.handleDeleteTagGroup}\n          onMoveArrangementGroup={tagManagement.handleMoveArrangementGroup}\n          onGroupAliasInputChange={(groupId, value) =>\n            tagManagement.setGroupAliasInputByGroupId((prev) => ({ ...prev, [groupId]: value }))\n          }\n          onAddGroupAlias={tagManagement.handleAddGroupAlias}\n          onDeleteGroupAlias={tagManagement.handleDeleteGroupAlias}\n        />\n      )}\n\n      {activeTab === 'trophies' && (\n        <Card>\n          <div className=\"section-head-row\">\n            {showHeaderIcons && <Trophy size={24} className=\"text-yellow-600\" />}\n            <h2 className=\"card-title mb-0\">Pokaalit (Legacy baseline)</h2>\n          </div>\n\n          <p className=\"text-sm text-gray-600 mb-4\">\n            Tunnistettu {trophyOverview.length} uniikkia kunniamerkki√§. Jaettuja merkkej√§ yhteens√§ {totalAwardedTrophies}.\n          </p>\n\n          <div className=\"space-y-2\">\n            {trophyOverview.slice(0, 20).map((trophy) => (\n              <div key={trophy.id} className=\"flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-3 py-2\">\n                <div className=\"min-w-0 flex items-center gap-2\">\n                  {trophyLocalIconUrl(trophy.icon_path) && (\n                    <img\n                      src={trophyLocalIconUrl(trophy.icon_path) as string}\n                      alt={trophy.name}\n                      className=\"w-4 h-5 object-contain flex-shrink-0\"\n                    />\n                  )}\n                  <div className=\"min-w-0\">\n                    <p className=\"font-semibold truncate\">{trophy.name}</p>\n                    <p className=\"text-muted-xs truncate\">{trophy.code}</p>\n                  </div>\n                </div>\n                <div className=\"text-right ml-4\">\n                  <p className=\"text-sm font-bold text-yellow-700\">{trophy.points} p</p>\n                  <p className=\"text-muted-xs\">{trophy.awarded_count} k√§ytt√§j√§ll√§</p>\n                </div>\n              </div>\n            ))}\n          </div>\n\n          {trophyOverview.length > 20 && (\n            <p className=\"mt-4 text-muted-xs\">\n              N√§ytet√§√§n 20 ensimm√§ist√§. Loput l√∂ytyv√§t taulusta `admin_trophy_overview`.\n            </p>\n          )}\n        </Card>\n      )}\n\n      {activeTab === 'levels' && (\n        <Card>\n          <h2 className=\"card-title flex items-center gap-2\">\n            {showHeaderIcons && <BarChart3 size={20} className=\"text-yellow-600\" />}\n            Tasot\n          </h2>\n          <p className=\"text-muted-sm\">Tasologiikka ja hallinta tulossa t√§h√§n korttiin.</p>\n        </Card>\n      )}\n\n      {activeTab === 'events' && <EventsPanel />}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/api/auth/login-network/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/api/events/assets/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/api/graphql/route.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async function 'POST' has a complexity of 26. Maximum allowed is 12.","line":48,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":48,"endColumn":27},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 34 to the 15 allowed.","line":48,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":48,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { UI_PAGING_SETTINGS } from '@/lib/uiSettings';\nimport { createClient } from '@/lib/supabase/server';\n\ntype GraphQLVariables = Record<string, unknown>;\n\ninterface GraphQLBody {\n  operationName?: string;\n  query?: string;\n  variables?: GraphQLVariables;\n}\n\nfunction intVar(value: unknown, fallback: number): number {\n  const parsed = Number.parseInt(String(value ?? ''), 10);\n  if (!Number.isFinite(parsed) || parsed <= 0) return fallback;\n  return parsed;\n}\n\nfunction tagIdsVar(value: unknown): number[] {\n  if (!Array.isArray(value)) return [];\n  return Array.from(\n    new Set(\n      value\n        .map((item) => Number.parseInt(String(item), 10))\n        .filter((id) => Number.isFinite(id) && id > 0)\n    )\n  );\n}\n\nfunction matchAllVar(value: unknown): boolean {\n  return value === true || String(value || '').toLowerCase() === 'all';\n}\n\nfunction textVar(value: unknown, fallback = ''): string {\n  if (typeof value !== 'string') return fallback;\n  return value.trim();\n}\n\nfunction resolveOperationName(body: GraphQLBody): string {\n  if (body.operationName) return body.operationName;\n  const query = body.query || '';\n  if (query.includes('attachTagsToTopic')) return 'attachTagsToTopic';\n  if (query.includes('topicsByTags')) return 'topicsByTags';\n  if (query.includes('tags')) return 'tags';\n  return '';\n}\n\nexport async function POST(req: NextRequest) {\n  const body = (await req.json().catch(() => null)) as GraphQLBody | null;\n  if (!body) {\n    return NextResponse.json({ errors: [{ message: 'Invalid JSON body' }] }, { status: 400 });\n  }\n\n  const supabase = await createClient();\n  const variables = body.variables || {};\n  const op = resolveOperationName(body);\n\n  if (op === 'tags') {\n    const status = textVar(variables.status, 'approved');\n    const query = textVar(variables.query);\n    const limit = Math.min(intVar(variables.limit, 20), 100);\n\n    if (status && status !== 'approved') {\n      return NextResponse.json({ data: { tags: [] } });\n    }\n\n    let qb = supabase\n      .from('tags')\n      .select('id, name, slug, icon')\n      .order('name', { ascending: true })\n      .limit(limit);\n\n    qb = qb.eq('status', 'approved').eq('featured', true).is('redirect_to_tag_id', null);\n\n    if (query) {\n      const [tagMatchRes, aliasMatchRes] = await Promise.all([\n        supabase\n          .from('tags')\n          .select('id')\n          .or(`name.ilike.%${query}%,slug.ilike.%${query}%`)\n          .is('redirect_to_tag_id', null),\n        supabase\n          .from('tag_aliases')\n          .select('tag_id')\n          .ilike('alias', `%${query}%`),\n      ]);\n\n      const directIds = (tagMatchRes.data || []).map((row) => Number((row as { id: number }).id));\n      const aliasIds = (aliasMatchRes.data || []).map((row) => Number((row as { tag_id: number }).tag_id));\n      const searchedIds = Array.from(\n        new Set([...directIds, ...aliasIds].filter((id) => Number.isFinite(id) && id > 0))\n      );\n\n      if (searchedIds.length === 0) {\n        return NextResponse.json({ data: { tags: [] } });\n      }\n      qb = qb.in('id', searchedIds);\n    }\n\n    const { data, error } = await qb;\n    if (error) return NextResponse.json({ errors: [{ message: error.message }] }, { status: 400 });\n    return NextResponse.json({ data: { tags: data || [] } });\n  }\n\n  if (op === 'attachTagsToTopic') {\n    const topicId = intVar(variables.topicId, 0);\n    const tagIds = tagIdsVar(variables.tagIds);\n    if (topicId <= 0 || tagIds.length === 0) {\n      return NextResponse.json({ errors: [{ message: 'topicId and tagIds are required' }] }, { status: 400 });\n    }\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n    if (!user) return NextResponse.json({ errors: [{ message: 'Unauthorized' }] }, { status: 401 });\n\n    const { data: canonicalIdsRaw, error: canonicalError } = await supabase.rpc('resolve_canonical_tag_ids', {\n      input_tag_ids: tagIds,\n    });\n    if (canonicalError) return NextResponse.json({ errors: [{ message: canonicalError.message }] }, { status: 400 });\n\n    const canonicalIds = Array.isArray(canonicalIdsRaw)\n      ? canonicalIdsRaw\n          .map((value) => Number.parseInt(String(value), 10))\n          .filter((id) => Number.isFinite(id) && id > 0)\n      : [];\n    if (canonicalIds.length === 0) {\n      return NextResponse.json({ errors: [{ message: 'No canonical tags found' }] }, { status: 400 });\n    }\n\n    const { error: upsertError } = await supabase\n      .from('topic_tags')\n      .upsert(\n        canonicalIds.map((tagId) => ({ topic_id: topicId, tag_id: tagId, created_by: user.id })),\n        { onConflict: 'topic_id,tag_id', ignoreDuplicates: true }\n      );\n\n    if (upsertError) return NextResponse.json({ errors: [{ message: upsertError.message }] }, { status: 400 });\n    return NextResponse.json({ data: { attachTagsToTopic: { topic_id: topicId, tag_ids: canonicalIds } } });\n  }\n\n  if (op === 'topicsByTags') {\n    const page = intVar(variables.page, 1);\n    const pageSize = Math.min(intVar(variables.pageSize, UI_PAGING_SETTINGS.forumShowMoreStep), 100);\n    const tagIds = tagIdsVar(variables.tagIds);\n    const matchAll = matchAllVar(variables.matchAll);\n\n    const [{ data: topicsData, error: topicsError }, { data: totalCountData, error: totalError }] = await Promise.all([\n      supabase.rpc('get_topic_list_state_filtered', {\n        input_page: page,\n        input_page_size: pageSize,\n        input_tag_ids: tagIds,\n        input_match_all: matchAll,\n      }),\n      supabase.rpc('get_topic_count_filtered', {\n        input_tag_ids: tagIds,\n        input_match_all: matchAll,\n      }),\n    ]);\n\n    if (topicsError) return NextResponse.json({ errors: [{ message: topicsError.message }] }, { status: 400 });\n    if (totalError) return NextResponse.json({ errors: [{ message: totalError.message }] }, { status: 400 });\n\n    return NextResponse.json({\n      data: {\n        topicsByTags: {\n          topics: topicsData || [],\n          page,\n          page_size: pageSize,\n          total_count: typeof totalCountData === 'number' ? totalCountData : 0,\n          filter: { tag_ids: tagIds, match: matchAll ? 'all' : 'any' },\n        },\n      },\n    });\n  }\n\n  return NextResponse.json(\n    {\n      errors: [\n        {\n          message:\n            'Unsupported operation. Use one of: tags, topicsByTags, attachTagsToTopic.',\n        },\n      ],\n    },\n    { status: 400 }\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/api/tags/route.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async function 'GET' has a complexity of 22. Maximum allowed is 12.","line":41,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":41,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\n\ninterface RawTagRow {\n  id: number;\n  name: string;\n  slug: string;\n  icon: string;\n  legacy_icon_path?: string | null;\n  group_label?: string;\n  group_order?: number;\n  tag_order?: number;\n}\n\nfunction parseLimit(value: string | null, fallback = 20): number {\n  const parsed = Number.parseInt(value || '', 10);\n  if (!Number.isFinite(parsed) || parsed <= 0) return fallback;\n  return Math.min(parsed, 100);\n}\n\nfunction parseIds(value: string | null): number[] {\n  if (!value) return [];\n  return Array.from(\n    new Set(\n      value\n        .split(',')\n        .map((part) => Number.parseInt(part.trim(), 10))\n        .filter((id) => Number.isFinite(id) && id > 0)\n    )\n  );\n}\n\nfunction parseBoolean(value: string | null): boolean | null {\n  if (value === null) return null;\n  const lowered = value.trim().toLowerCase();\n  if (lowered === 'true' || lowered === '1') return true;\n  if (lowered === 'false' || lowered === '0') return false;\n  return null;\n}\n\nexport async function GET(req: NextRequest) {\n  const supabase = await createClient();\n  const status = req.nextUrl.searchParams.get('status');\n  const query = (req.nextUrl.searchParams.get('query') || '').trim();\n  const limit = parseLimit(req.nextUrl.searchParams.get('limit'), 20);\n  const ids = parseIds(req.nextUrl.searchParams.get('ids'));\n  const featured = parseBoolean(req.nextUrl.searchParams.get('featured'));\n  let legacyTagIconsEnabled = true;\n\n  const { data: authData } = await supabase.auth.getUser();\n  if (authData.user?.id) {\n    const { data: profilePrefs } = await supabase\n      .from('profiles')\n      .select('legacy_tag_icons_enabled')\n      .eq('id', authData.user.id)\n      .single();\n    legacyTagIconsEnabled = profilePrefs?.legacy_tag_icons_enabled !== false;\n  }\n\n  if (status && status !== 'approved') {\n    return NextResponse.json({ tags: [] });\n  }\n\n  const { data, error } = await supabase.rpc('get_tag_picker_options', {\n    input_query: query || null,\n    input_limit: limit,\n    input_featured: featured,\n    input_ids: ids.length > 0 ? ids : null,\n  });\n\n  if (error) {\n    return NextResponse.json({ error: error.message }, { status: 400 });\n  }\n\n  const tags = ((data || []) as RawTagRow[]).map((tag) => ({ ...tag }));\n  const tagIds = tags.map((tag) => tag.id).filter((id) => Number.isFinite(id) && id > 0);\n\n  if (tagIds.length > 0) {\n    const { data: iconRows } = await supabase\n      .from('tags')\n      .select('id, icon, legacy_icon_path')\n      .in('id', tagIds);\n\n    const iconById = new Map<number, string>();\n    for (const row of (iconRows || []) as { id: number; icon: string | null; legacy_icon_path: string | null }[]) {\n      const legacyIconPath = (row.legacy_icon_path || '').trim();\n      const icon = (row.icon || '').trim();\n      iconById.set(row.id, (legacyTagIconsEnabled ? legacyIconPath : '') || icon || 'üè∑Ô∏è');\n    }\n\n    for (const tag of tags) {\n      tag.icon = iconById.get(tag.id) || tag.icon || 'üè∑Ô∏è';\n    }\n  }\n\n  return NextResponse.json({ tags });\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/api/topics/[id]/tags/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/api/topics/route.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async function 'GET' has a complexity of 35. Maximum allowed is 12.","line":50,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":50,"endColumn":26},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 34 to the 15 allowed.","line":50,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":50,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { UI_PAGING_SETTINGS } from '@/lib/uiSettings';\nimport { createClient } from '@/lib/supabase/server';\n\ninterface RawTopicRow {\n  id: number;\n  title: string;\n  views: number;\n  views_unique: number;\n  created_at: string;\n  category_name: string;\n  category_icon: string;\n  author_username: string;\n  replies_count: number;\n  last_post_id: number | null;\n  last_post_created_at: string | null;\n  jump_post_id: number | null;\n  unread_count: number;\n  has_new: boolean;\n}\n\ninterface RawTagIconRow {\n  name: string;\n  icon: string | null;\n  legacy_icon_path: string | null;\n}\n\nfunction parsePositiveInt(value: string | null, fallback: number): number {\n  const parsed = Number.parseInt(value || '', 10);\n  if (!Number.isFinite(parsed) || parsed <= 0) return fallback;\n  return parsed;\n}\n\nfunction parseTagIds(raw: string | null): number[] {\n  if (!raw) return [];\n  return Array.from(\n    new Set(\n      raw\n        .split(',')\n        .map((part) => Number.parseInt(part.trim(), 10))\n        .filter((value) => Number.isFinite(value) && value > 0)\n    )\n  );\n}\n\nfunction parseMatchMode(value: string | null): boolean {\n  return (value || '').toLowerCase() === 'all';\n}\n\nexport async function GET(req: NextRequest) {\n  const supabase = await createClient();\n  const page = parsePositiveInt(req.nextUrl.searchParams.get('page'), 1);\n  const pageSize = Math.min(parsePositiveInt(req.nextUrl.searchParams.get('page_size'), UI_PAGING_SETTINGS.forumShowMoreStep), 100);\n  const tagIds = parseTagIds(req.nextUrl.searchParams.get('tag_ids'));\n  const matchAll = parseMatchMode(req.nextUrl.searchParams.get('match'));\n  const { data: canonicalIdsRaw, error: canonicalError } = await supabase.rpc('resolve_canonical_tag_ids', {\n    input_tag_ids: tagIds,\n  });\n  if (canonicalError) {\n    return NextResponse.json({ error: canonicalError.message }, { status: 400 });\n  }\n  const canonicalTagIds = Array.isArray(canonicalIdsRaw)\n    ? canonicalIdsRaw\n        .map((value) => Number.parseInt(String(value), 10))\n        .filter((value) => Number.isFinite(value) && value > 0)\n    : [];\n\n  const { data: authData } = await supabase.auth.getUser();\n  const userId = authData.user?.id ?? null;\n  let excludedTagIds: number[] = [];\n  let legacyTagIconsEnabled = true;\n\n  if (userId) {\n    const { data: profilePrefs } = await supabase\n      .from('profiles')\n      .select('hidden_tag_ids, hidden_tag_group_ids, legacy_tag_icons_enabled')\n      .eq('id', userId)\n      .single();\n    legacyTagIconsEnabled = profilePrefs?.legacy_tag_icons_enabled !== false;\n\n    const hiddenTagIds = Array.isArray(profilePrefs?.hidden_tag_ids)\n      ? profilePrefs.hidden_tag_ids\n          .map((value) => Number.parseInt(String(value), 10))\n          .filter((value) => Number.isFinite(value) && value > 0)\n      : [];\n\n    const hiddenTagGroupIds = Array.isArray(profilePrefs?.hidden_tag_group_ids)\n      ? profilePrefs.hidden_tag_group_ids\n          .map((value) => Number.parseInt(String(value), 10))\n          .filter((value) => Number.isFinite(value) && value > 0)\n      : [];\n\n    let hiddenGroupTagIds: number[] = [];\n    if (hiddenTagGroupIds.length > 0) {\n      const { data: groupMembers } = await supabase\n        .from('tag_group_members')\n        .select('tag_id')\n        .in('group_id', hiddenTagGroupIds);\n\n      hiddenGroupTagIds = Array.isArray(groupMembers)\n        ? groupMembers\n            .map((row) => Number.parseInt(String(row.tag_id), 10))\n            .filter((value) => Number.isFinite(value) && value > 0)\n        : [];\n    }\n\n    const rawExcluded = Array.from(new Set([...hiddenTagIds, ...hiddenGroupTagIds]));\n    if (rawExcluded.length > 0) {\n      const { data: canonicalExcludedRaw } = await supabase.rpc('resolve_canonical_tag_ids', {\n        input_tag_ids: rawExcluded,\n      });\n      excludedTagIds = Array.isArray(canonicalExcludedRaw)\n        ? canonicalExcludedRaw\n            .map((value) => Number.parseInt(String(value), 10))\n            .filter((value) => Number.isFinite(value) && value > 0)\n        : [];\n    }\n  }\n\n  const [{ data: topicsData, error: topicsError }, { data: totalCountData, error: totalError }] = await Promise.all([\n    supabase.rpc('get_topic_list_state_filtered_with_exclusions', {\n      input_page: page,\n      input_page_size: pageSize,\n      input_tag_ids: canonicalTagIds,\n      input_match_all: matchAll,\n      input_excluded_tag_ids: excludedTagIds,\n    }),\n    supabase.rpc('get_topic_count_filtered_with_exclusions', {\n      input_tag_ids: canonicalTagIds,\n      input_match_all: matchAll,\n      input_excluded_tag_ids: excludedTagIds,\n    }),\n  ]);\n\n  let finalTopicsData = topicsData;\n  let finalTotalCountData = totalCountData;\n  let finalTopicsError = topicsError;\n  let finalTotalError = totalError;\n\n  const shouldFallbackToLegacyRpc = Boolean(topicsError || totalError);\n\n  if (shouldFallbackToLegacyRpc) {\n    const [{ data: legacyTopicsData, error: legacyTopicsError }, { data: legacyTotalCountData, error: legacyTotalError }] = await Promise.all([\n      supabase.rpc('get_topic_list_state_filtered', {\n        input_page: page,\n        input_page_size: pageSize,\n        input_tag_ids: canonicalTagIds,\n        input_match_all: matchAll,\n      }),\n      supabase.rpc('get_topic_count_filtered', {\n        input_tag_ids: canonicalTagIds,\n        input_match_all: matchAll,\n      }),\n    ]);\n\n    finalTopicsData = legacyTopicsData as RawTopicRow[] | null;\n    finalTotalCountData = legacyTotalCountData;\n    finalTopicsError = legacyTopicsError;\n    finalTotalError = legacyTotalError;\n  }\n\n  if (finalTopicsError) {\n    const message = shouldFallbackToLegacyRpc\n      ? `Topics query failed after legacy fallback: ${finalTopicsError.message}`\n      : finalTopicsError.message;\n    return NextResponse.json({ error: message }, { status: 400 });\n  }\n  if (finalTotalError) {\n    const message = shouldFallbackToLegacyRpc\n      ? `Topics count failed after legacy fallback: ${finalTotalError.message}`\n      : finalTotalError.message;\n    return NextResponse.json({ error: message }, { status: 400 });\n  }\n\n  const topics = ((finalTopicsData || []) as RawTopicRow[]).map((row) => ({ ...row }));\n  const categoryNames = Array.from(new Set(topics.map((row) => row.category_name).filter((name) => !!name)));\n\n  if (categoryNames.length > 0) {\n    const { data: tagRows } = await supabase\n      .from('tags')\n      .select('name, icon, legacy_icon_path')\n      .is('redirect_to_tag_id', null)\n      .in('name', categoryNames);\n\n    const iconByName = new Map<string, string>();\n    for (const row of (tagRows || []) as RawTagIconRow[]) {\n      const legacyIconPath = (row.legacy_icon_path || '').trim();\n      const icon = (row.icon || '').trim();\n      iconByName.set(row.name, (legacyTagIconsEnabled ? legacyIconPath : '') || icon || 'üè∑Ô∏è');\n    }\n\n    for (const row of topics) {\n      row.category_icon = iconByName.get(row.category_name) || row.category_icon || 'üè∑Ô∏è';\n    }\n  }\n\n  return NextResponse.json({\n    topics,\n    page,\n    page_size: pageSize,\n    total_count: typeof finalTotalCountData === 'number' ? finalTotalCountData : 0,\n    filter: {\n      tag_ids: canonicalTagIds,\n      match: matchAll ? 'all' : 'any',\n    },\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/login/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/loki/page.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 33 to the 15 allowed.","line":170,"column":34,"nodeType":null,"messageId":"refactorFunction","endLine":170,"endColumn":36},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 25. Maximum allowed is 12.","line":170,"column":34,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":170,"endColumn":36},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 25. Maximum allowed is 12.","line":350,"column":35,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":350,"endColumn":37},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (451). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":452,"endColumn":1},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":375,"column":31,"nodeType":"JSXOpeningElement","endLine":375,"endColumn":146},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":418,"column":29,"nodeType":"JSXOpeningElement","endLine":422,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState, useMemo } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { SearchInput } from '@/components/ui/SearchInput';\nimport Link from 'next/link';\nimport { ScrollText, Image as ImageIcon, Link2, User, Heart, Clapperboard } from 'lucide-react';\nimport { formatFinnishDateTime } from '@/lib/formatDate';\nimport { postThumb, profileThumb } from '@/lib/cloudinary';\n\ntype EventType = 'image' | 'video' | 'url' | 'quote';\ntype FilterType = 'all' | 'image' | 'video' | 'url' | 'quote';\nconst LOKI_FILTERS: FilterType[] = ['all', 'image', 'video', 'url', 'quote'];\n\ninterface EventItem {\n  id: string;\n  type: EventType;\n  created_at: string;\n  topic_id: number;\n  post_id?: number;\n  topic_title: string;\n  content_preview?: string;\n  author: {\n    id: string;\n    username: string;\n    profile_image_url: string | null;\n  } | null;\n  image_url?: string;\n  urls?: string[];\n  quote_preview?: string;\n}\n\ninterface RawPostRow {\n  id: number;\n  content: string;\n  created_at: string;\n  image_url: string | null;\n  topic_id: number;\n  topic: { title: string } | null;\n  author: {\n    id: string;\n    username: string;\n    profile_image_url: string | null;\n  } | null;\n}\n\ninterface RawQuoteLikeEventRow {\n  id: number;\n  created_at: string;\n  post_id: number;\n  topic_id: number;\n  topic: { title: string }[] | { title: string } | null;\n  post: { content: string }[] | { content: string } | null;\n  actor: {\n    id: string;\n    username: string;\n    profile_image_url: string | null;\n  }[] | {\n    id: string;\n    username: string;\n    profile_image_url: string | null;\n  } | null;\n}\n\nconst URL_REGEX = /https?:\\/\\/[^\\s)>\\]]+/g;\nconst IMAGE_URL_REGEX = /\\.(png|jpe?g|gif|webp|avif|svg)(\\?.*)?$/i;\nconst VIDEO_URL_REGEX = /\\.(mp4|webm|mov|m4v|ogv|ogg)(\\?.*)?$/i;\n\nfunction isLokiFilter(value: string): value is FilterType {\n  return LOKI_FILTERS.includes(value as FilterType);\n}\n\nfunction extractUrls(content: string): string[] {\n  return [...content.matchAll(URL_REGEX)].map((m) => m[0]);\n}\n\nfunction makePreview(content: string, maxLength = 220): string {\n  const trimmed = content.trim();\n  if (trimmed.length <= maxLength) return trimmed;\n  return `${trimmed.slice(0, maxLength).replace(/\\s+\\S*$/, '')}...`;\n}\n\nfunction getActionText(type: EventType): string {\n  if (type === 'image') return 'lis√§si mediaa';\n  if (type === 'video') return 'lis√§si videon';\n  if (type === 'quote') return 'tykk√§si lainauksesta';\n  return 'jakoi linkin';\n}\n\nfunction extractYoutubeId(url: string): string | null {\n  try {\n    const parsed = new URL(url);\n    const host = parsed.hostname.replace(/^www\\./, '');\n    if (host === 'youtube.com' || host === 'm.youtube.com') {\n      const v = parsed.searchParams.get('v');\n      if (v) return v;\n      if (parsed.pathname.startsWith('/shorts/')) {\n        return parsed.pathname.split('/')[2] || null;\n      }\n    }\n    if (host === 'youtu.be') {\n      return parsed.pathname.split('/').filter(Boolean)[0] || null;\n    }\n  } catch {\n    return null;\n  }\n  return null;\n}\n\nfunction getMediaForEvent(event: EventItem): { kind: 'image' | 'video'; url: string; previewImageUrl?: string } | null {\n  if (event.image_url) {\n    return { kind: 'image', url: event.image_url };\n  }\n\n  if (!event.urls || event.urls.length === 0) return null;\n  const imageUrl = event.urls.find((url) => IMAGE_URL_REGEX.test(url));\n  if (imageUrl) return { kind: 'image', url: imageUrl };\n\n  const directVideoUrl = event.urls.find((url) => VIDEO_URL_REGEX.test(url));\n  if (directVideoUrl) {\n    return { kind: 'video', url: directVideoUrl, previewImageUrl: '/window.svg' };\n  }\n\n  const youtubeUrl = event.urls.find((url) => Boolean(extractYoutubeId(url)));\n  if (youtubeUrl) {\n    const videoId = extractYoutubeId(youtubeUrl);\n    if (videoId) {\n      return {\n        kind: 'video',\n        url: youtubeUrl,\n        previewImageUrl: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,\n      };\n    }\n  }\n\n  return null;\n}\n\nexport default function LokiPage() {\n  const { supabase } = useAuth();\n  const [events, setEvents] = useState<EventItem[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [filter, setFilter] = useState<FilterType>('all');\n  const [searchQuery, setSearchQuery] = useState('');\n\n  useEffect(() => {\n    const syncFilterFromHash = () => {\n      const hash = window.location.hash.replace('#', '').toLowerCase();\n      if (isLokiFilter(hash)) {\n        setFilter(hash);\n      } else if (window.location.hash) {\n        setFilter('all');\n      }\n    };\n\n    syncFilterFromHash();\n    window.addEventListener('hashchange', syncFilterFromHash);\n    return () => window.removeEventListener('hashchange', syncFilterFromHash);\n  }, []);\n\n  useEffect(() => {\n    const nextHash = `#${filter}`;\n    if (window.location.hash !== nextHash) {\n      window.history.replaceState(null, '', nextHash);\n    }\n  }, [filter]);\n\n  useEffect(() => {\n    const fetchEvents = async () => {\n      const [imageRes, urlRes, quoteLikeRes] = await Promise.all([\n        supabase\n          .from('posts')\n          .select('id, content, created_at, image_url, topic_id, topic:topics(title), author:profiles!author_id(id, username, profile_image_url)')\n          .is('deleted_at', null)\n          .not('image_url', 'is', null)\n          .order('created_at', { ascending: false })\n          .limit(200),\n        supabase\n          .from('posts')\n          .select('id, content, created_at, image_url, topic_id, topic:topics(title), author:profiles!author_id(id, username, profile_image_url)')\n          .is('deleted_at', null)\n          .ilike('content', '%http%')\n          .order('created_at', { ascending: false })\n          .limit(200),\n        supabase\n          .from('quote_like_events')\n          .select(`\n            id, created_at, post_id, topic_id,\n            topic:topics(title),\n            post:posts(content),\n            actor:profiles!liked_by_profile_id(id, username, profile_image_url)\n          `)\n          .order('created_at', { ascending: false })\n          .limit(200),\n      ]);\n\n      const eventList: EventItem[] = [];\n      const seenIds = new Set<string>();\n\n      if (imageRes.data) {\n        for (const post of imageRes.data as unknown as RawPostRow[]) {\n          const key = `image-${post.id}`;\n          if (seenIds.has(key)) continue;\n          seenIds.add(key);\n          eventList.push({\n            id: key,\n            type: 'image',\n            created_at: post.created_at,\n            topic_id: post.topic_id,\n            post_id: post.id,\n            topic_title: post.topic?.title || '',\n            content_preview: makePreview(post.content || ''),\n            author: post.author,\n            image_url: post.image_url!,\n          });\n        }\n      }\n\n      if (urlRes.data) {\n        for (const post of urlRes.data as unknown as RawPostRow[]) {\n          const urls = extractUrls(post.content);\n          if (urls.length === 0) continue;\n          const key = `url-${post.id}`;\n          if (seenIds.has(key)) continue;\n          seenIds.add(key);\n          const hasVideoUrl = urls.some((url) => VIDEO_URL_REGEX.test(url) || Boolean(extractYoutubeId(url)));\n          eventList.push({\n            id: key,\n            type: hasVideoUrl ? 'video' : 'url',\n            created_at: post.created_at,\n            topic_id: post.topic_id,\n            post_id: post.id,\n            topic_title: post.topic?.title || '',\n            content_preview: makePreview(post.content || ''),\n            author: post.author,\n            urls,\n          });\n        }\n      }\n\n      if (quoteLikeRes.data) {\n        for (const rawEvent of quoteLikeRes.data as unknown as RawQuoteLikeEventRow[]) {\n          const topic = Array.isArray(rawEvent.topic) ? rawEvent.topic[0] : rawEvent.topic;\n          const post = Array.isArray(rawEvent.post) ? rawEvent.post[0] : rawEvent.post;\n          const actor = Array.isArray(rawEvent.actor) ? rawEvent.actor[0] : rawEvent.actor;\n\n          if (!actor) continue;\n\n          const preview = makePreview(post?.content || '', 140);\n\n          eventList.push({\n            id: `quote-${rawEvent.id}`,\n            type: 'quote',\n            created_at: rawEvent.created_at,\n            topic_id: rawEvent.topic_id,\n            post_id: rawEvent.post_id,\n            topic_title: topic?.title || '',\n            content_preview: preview,\n            author: actor,\n            quote_preview: preview,\n          });\n        }\n      }\n\n      eventList.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());\n      setEvents(eventList);\n      setLoading(false);\n    };\n\n    fetchEvents();\n  }, [supabase]);\n\n  const filtered = useMemo(() => {\n    let list = events;\n    if (filter !== 'all') {\n      list = list.filter((e) => e.type === filter);\n    }\n    if (searchQuery.trim()) {\n      const q = searchQuery.trim().toLowerCase();\n      list = list.filter((e) => {\n        if (e.author?.username.toLowerCase().includes(q)) return true;\n        if (e.topic_title.toLowerCase().includes(q)) return true;\n        if (e.urls?.some((u) => u.toLowerCase().includes(q))) return true;\n        return false;\n      });\n    }\n    return list;\n  }, [events, filter, searchQuery]);\n\n  if (loading) {\n    return (\n      <div className=\"page-container\">\n        <Card>\n          <p className=\"state-empty-text\">Ladataan...</p>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"page-container\">\n      <div className=\"mb-6\">\n        <div className=\"flex items-center gap-3\">\n          <ScrollText size={28} className=\"text-gray-800\" />\n          <h2 className=\"text-3xl font-bold\">Loki</h2>\n        </div>\n        <p className=\"text-gray-600 mt-1\">\n          Yarr! {events.length} tapahtumaa{events.length > 0 && ` ‚Äî viimeisin ${formatFinnishDateTime(events[0].created_at)}`}\n        </p>\n      </div>\n\n      <div className=\"page-tabs mb-4\">\n        <div className=\"flex gap-2 flex-wrap\">\n          {([\n            ['all', 'Kaikki'],\n            ['image', 'Kuvat'],\n            ['video', 'Videot'],\n            ['url', 'Linkit'],\n            ['quote', 'Lainaukset'],\n          ] as [FilterType, string][]).map(([value, label]) => (\n            <button\n              key={value}\n              type=\"button\"\n              onClick={() => setFilter(value)}\n              className={`page-tab-button ${filter === value ? 'is-active' : ''}`}\n            >\n              {label}\n            </button>\n          ))}\n        </div>\n\n        <SearchInput\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          placeholder=\"Hae...\"\n          inputClassName=\"w-48\"\n        />\n      </div>\n\n      {filtered.length === 0 ? (\n        <Card>\n          <p className=\"state-empty-text\">\n            Ei tapahtumia.\n          </p>\n        </Card>\n      ) : (\n        <Card className=\"overflow-hidden\">\n          <div className=\"divide-y divide-gray-200\">\n            {filtered.map((event) => {\n              const topicHref = `/topic/${event.topic_id}${event.post_id ? `#post-${event.post_id}` : ''}`;\n              const media = getMediaForEvent(event);\n              const rowAlignmentClass = media ? 'items-start' : 'items-center';\n\n              return (\n                <div key={event.id} className=\"py-3\">\n                  <div className={`flex gap-3 ${rowAlignmentClass}`}>\n                    <div className=\"flex-shrink-0 w-8 text-center\">\n                      {event.type === 'image' ? (\n                        <ImageIcon size={20} className=\"text-yellow-600 mx-auto\" />\n                      ) : event.type === 'video' ? (\n                        <Clapperboard size={20} className=\"text-yellow-600 mx-auto\" />\n                      ) : event.type === 'quote' ? (\n                        <Heart size={20} className=\"text-yellow-600 mx-auto\" />\n                      ) : (\n                        <Link2 size={20} className=\"text-yellow-600 mx-auto\" />\n                      )}\n                    </div>\n\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-base text-gray-700 inline-flex items-center gap-1 flex-wrap\">\n                        {event.author && (\n                          <Link href={`/profile/${event.author.id}`} className=\"inline-flex items-center gap-1.5 hover:opacity-80\">\n                            {event.author.profile_image_url ? (\n                              <img src={profileThumb(event.author.profile_image_url)} alt={event.author.username} className=\"avatar-inline-sm\" />\n                            ) : (\n                              <span className=\"avatar-inline-sm-fallback\">\n                                <User size={10} />\n                              </span>\n                            )}\n                            <span className=\"font-bold text-base leading-5 text-gray-800\">{event.author.username}</span>\n                          </Link>\n                        )}\n                        <span>\n                          {event.type === 'quote' ? 'tykk√§si lainauksesta ketjuun ' : `${getActionText(event.type)} ketjuun `}\n                        </span>\n                        <Link href={topicHref} className=\"content-inline-link font-medium\">\n                          {event.topic_title}\n                        </Link>\n                        {event.type === 'quote' && event.content_preview && (\n                          <span className=\"text-gray-600\">: &ldquo;{event.content_preview}&rdquo;</span>\n                        )}\n                        {(event.type === 'url' || event.type === 'video') && event.urls && event.urls.length > 0 && (\n                          <span className=\"text-gray-600\">\n                            :{' '}\n                            <a\n                              href={event.urls[0]}\n                              target=\"_blank\"\n                              rel=\"noopener noreferrer\"\n                              className=\"app-link\"\n                            >\n                              {event.urls[0]}\n                            </a>\n                            {event.urls.length > 1 && (\n                              <span className=\"text-muted-sm\"> (+{event.urls.length - 1} lis√§√§)</span>\n                            )}\n                          </span>\n                        )}\n                      </p>\n\n                      {event.content_preview && event.type !== 'quote' && event.type !== 'url' && event.type !== 'image' && event.type !== 'video' && (\n                        <p className=\"mt-1 text-base text-gray-600 break-words\">{event.content_preview}</p>\n                      )}\n\n                      {media && (\n                        <a href={media.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"mt-2 block w-fit\">\n                          {media.kind === 'image' || media.previewImageUrl ? (\n                            <img\n                              src={media.kind === 'image' ? postThumb(media.url) : media.previewImageUrl}\n                              alt=\"Media thumbnail\"\n                              className=\"h-32 rounded-lg object-cover\"\n                            />\n                          ) : (\n                            <video\n                              src={media.url}\n                              className=\"h-32 rounded-lg object-cover\"\n                              muted\n                              playsInline\n                              preload=\"metadata\"\n                            />\n                          )}\n                        </a>\n                      )}\n\n                    </div>\n\n                    <div className=\"meta-right-slot\">\n                      <Link href={topicHref} className=\"text-xs text-gray-500 hover:text-yellow-700 hover:underline\">\n                        {formatFinnishDateTime(event.created_at)}\n                      </Link>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </Card>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/members/page.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":42,"column":35,"nodeType":null,"messageId":"refactorFunction","endLine":42,"endColumn":37},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":121,"column":19,"nodeType":"JSXOpeningElement","endLine":121,"endColumn":118},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":150,"column":29,"nodeType":"JSXOpeningElement","endLine":154,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { useAuth } from '@/contexts/AuthContext';\nimport Link from 'next/link';\nimport { Users, Shield, User } from 'lucide-react';\nimport { profileThumb } from '@/lib/cloudinary';\nimport { trophyLocalIconUrl, parseTrophies } from '@/lib/trophies';\nimport type { Trophy, TrophyJoinRow } from '@/lib/trophies';\nimport { formatFinnishDate } from '@/lib/formatDate';\n\ninterface Profile {\n  id: string;\n  username: string;\n  profile_image_url: string | null;\n  created_at: string;\n  is_admin: boolean;\n}\n\ninterface InactiveMember {\n  id: string;\n  username: string;\n  profile_image_url: string | null;\n  created_at: string;\n  is_admin: boolean;\n  last_activity_at: string | null;\n}\n\ninterface RawMemberTrophyRow extends TrophyJoinRow {\n  profile_id: string;\n}\n\nexport default function MembersPage() {\n  const { supabase, profile: myProfile } = useAuth();\n  const [members, setMembers] = useState<Profile[]>([]);\n  const [inactiveMembers, setInactiveMembers] = useState<InactiveMember[]>([]);\n  const [memberTrophies, setMemberTrophies] = useState<Record<string, Trophy[]>>({});\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    const fetchMembers = async () => {\n      const [membersRes, inactiveRes, trophiesRes] = await Promise.all([\n        supabase\n          .from('profiles')\n          .select('id, username, profile_image_url, created_at, is_admin')\n          .eq('approval_status', 'approved')\n          .order('created_at', { ascending: true }),\n        supabase\n          .rpc('get_inactive_members_since', { input_days: 365 }),\n        supabase\n          .from('profile_trophies')\n          .select('profile_id, trophy:trophies(id, code, name, points, icon_path)'),\n      ]);\n\n      if (!membersRes.error && membersRes.data) {\n        setMembers(membersRes.data);\n      }\n\n      if (!inactiveRes.error && inactiveRes.data) {\n        setInactiveMembers(inactiveRes.data as InactiveMember[]);\n      }\n\n      if (!trophiesRes.error && trophiesRes.data) {\n        const grouped: Record<string, Trophy[]> = {};\n\n        for (const row of trophiesRes.data as RawMemberTrophyRow[]) {\n          const trophyList = parseTrophies([row]);\n          if (trophyList.length === 0) continue;\n\n          if (!grouped[row.profile_id]) {\n            grouped[row.profile_id] = [];\n          }\n          grouped[row.profile_id].push(...trophyList);\n        }\n\n        // parseTrophies already sorts, but re-sort grouped arrays for consistency\n        for (const profileId of Object.keys(grouped)) {\n          grouped[profileId].sort((a, b) => b.points - a.points || a.name.localeCompare(b.name));\n        }\n\n        setMemberTrophies(grouped);\n      }\n\n      setLoading(false);\n    };\n\n    fetchMembers();\n  }, [supabase]);\n\n  if (loading) {\n    return (\n      <div className=\"layout-page-shell\">\n        <Card>\n          <p className=\"state-empty-text\">Ladataan j√§seni√§...</p>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"layout-page-shell\">\n      <div className=\"mb-6\">\n        <div className=\"flex items-center gap-3\">\n          <Users size={28} className=\"text-gray-800\" />\n          <h2 className=\"text-3xl font-bold\">Membut</h2>\n        </div>\n        <p className=\"text-gray-600 mt-1\">\n          Yhteens√§ {members.length} membulia.\n        </p>\n      </div>\n\n\n\n      <div className=\"space-y-2 mb-4\">\n        {members.map((member) => (\n          <Link key={member.id} href={`/profile/${member.id}`}>\n            <Card className=\"hover:border-yellow-400 transition cursor-pointer\">\n              <div className=\"flex items-start gap-4\">\n                {member.profile_image_url ? (\n                  <img src={profileThumb(member.profile_image_url)} alt={member.username} className=\"avatar-large\" />\n                ) : (\n                  <span className=\"avatar-large-fallback\">\n                    <User size={30} />\n                  </span>\n                )}\n                <div className=\"flex-1\">\n                  <h3 className=\"text-lg font-bold text-gray-800 flex items-center gap-2\">\n                    {member.username}\n                    {myProfile?.is_admin && member.is_admin && (\n                      <span className=\"admin-badge px-1.5\">\n                        <Shield size={10} />\n                        Admin\n                      </span>\n                    )}\n                  </h3>\n                  <p className=\"text-muted-xs\">\n                    Liittynyt {formatFinnishDate(member.created_at)}\n                  </p>\n\n                  {memberTrophies[member.id]?.length ? (\n                    <div className=\"mt-2 flex flex-wrap gap-1.5\">\n                      {memberTrophies[member.id].map((trophy) => (\n                        <span\n                          key={`${member.id}-${trophy.id}`}\n                          className=\"inline-flex items-center rounded bg-yellow-100 text-yellow-800 px-1.5 py-0.5 text-[11px] font-medium\"\n                          title={`${trophy.name} (${trophy.points} p)`}\n                        >\n                          {trophyLocalIconUrl(trophy.icon_path) ? (\n                            <img\n                              src={trophyLocalIconUrl(trophy.icon_path) as string}\n                              alt={trophy.name}\n                              className=\"w-4 h-5 object-contain\"\n                            />\n                          ) : (\n                            <span>{trophy.name}</span>\n                          )}\n                        </span>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"mt-2 text-[11px] text-gray-400\">Ei kunniamerkkej√§ (viel√§)</p>\n                  )}\n                </div>\n              </div>\n            </Card>\n          </Link>\n        ))}\n\n        {members.length === 0 && (\n          <Card>\n            <p className=\"state-empty-text\">\n              Ei viel√§ j√§seni√§.\n            </p>\n          </Card>\n        )}\n      </div>\n\n      {inactiveMembers.length > 0 && (\n        <Card>\n          <h3 className=\"card-title mb-2\">Miss√§ he ovat nyt?</h3>\n          <p className=\"text-muted-sm mb-3\">\n            365 p√§iv√§√§ hiljaisuutta: {inactiveMembers.length}\n          </p>\n\n          <div className=\"space-y-2\">\n            {inactiveMembers.map((member) => (\n              <Link key={`inactive-${member.id}`} href={`/profile/${member.id}`} className=\"list-row-card hover:border-yellow-400 transition\">\n                <span className=\"font-medium truncate\">{member.username}</span>\n                <span className=\"text-muted-xs whitespace-nowrap\">\n                  {member.last_activity_at\n                    ? `Viimeksi aktiivinen ${formatFinnishDate(member.last_activity_at)}`\n                    : `Ei aktiviteettia (liittynyt ${formatFinnishDate(member.created_at)})`}\n                </span>\n              </Link>\n            ))}\n          </div>\n        </Card>\n      )}\n\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/midi/midi.js","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'parseMidi' has a complexity of 27. Maximum allowed is 12.","line":38,"column":1,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":38,"endColumn":19},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 53 to the 15 allowed.","line":38,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":38,"endColumn":19},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (401). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":402,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * ChiptunePlayer + runtime MIDI parser (no external dependencies).\n */\n\nconst WAVE_TYPES = ['square', 'triangle', 'sawtooth', 'sine'];\nconst MIDI_CACHE = new Map();\n\nfunction readUint32(view, offset) {\n  return view.getUint32(offset, false);\n}\n\nfunction readUint16(view, offset) {\n  return view.getUint16(offset, false);\n}\n\nfunction readAscii(view, offset, length) {\n  let out = '';\n  for (let i = 0; i < length; i += 1) {\n    out += String.fromCharCode(view.getUint8(offset + i));\n  }\n  return out;\n}\n\nfunction readVlq(view, offset) {\n  let value = 0;\n  let i = offset;\n  let byte = 0;\n\n  do {\n    byte = view.getUint8(i);\n    value = (value << 7) | (byte & 0x7f);\n    i += 1;\n  } while ((byte & 0x80) !== 0 && i < view.byteLength);\n\n  return { value, nextOffset: i };\n}\n\nfunction parseMidi(arrayBuffer) {\n  const view = new DataView(arrayBuffer);\n\n  if (readAscii(view, 0, 4) !== 'MThd') {\n    throw new Error('Invalid MIDI: missing MThd header');\n  }\n\n  const headerLength = readUint32(view, 4);\n  readUint16(view, 8); // MIDI format (currently not used in conversion)\n  const trackCount = readUint16(view, 10);\n  const division = readUint16(view, 12);\n\n  if ((division & 0x8000) !== 0) {\n    throw new Error('SMPTE time division is not supported');\n  }\n\n  const ticksPerBeat = division;\n  let offset = 8 + headerLength;\n  let tempoMicrosPerBeat = 500000;\n\n  const parsedTracks = [];\n\n  for (let trackIndex = 0; trackIndex < trackCount; trackIndex += 1) {\n    if (offset + 8 > view.byteLength) break;\n    const chunkType = readAscii(view, offset, 4);\n    offset += 4;\n\n    const chunkLength = readUint32(view, offset);\n    offset += 4;\n\n    if (chunkType !== 'MTrk') {\n      offset += chunkLength;\n      continue;\n    }\n\n    const trackEnd = Math.min(offset + chunkLength, view.byteLength);\n    let cursor = offset;\n    let absoluteTicks = 0;\n    let runningStatus = null;\n\n    const noteStarts = new Map();\n    const notes = [];\n\n    while (cursor < trackEnd) {\n      const deltaRead = readVlq(view, cursor);\n      absoluteTicks += deltaRead.value;\n      cursor = deltaRead.nextOffset;\n      if (cursor >= trackEnd) break;\n\n      let status = view.getUint8(cursor);\n      if ((status & 0x80) !== 0) {\n        cursor += 1;\n        runningStatus = status;\n      } else {\n        if (runningStatus === null) break;\n        status = runningStatus;\n      }\n\n      if (status === 0xff) {\n        if (cursor >= trackEnd) break;\n        const metaType = view.getUint8(cursor);\n        cursor += 1;\n        const metaLenRead = readVlq(view, cursor);\n        const metaLen = metaLenRead.value;\n        cursor = metaLenRead.nextOffset;\n\n        if (metaType === 0x51 && metaLen === 3) {\n          tempoMicrosPerBeat = (view.getUint8(cursor) << 16)\n            | (view.getUint8(cursor + 1) << 8)\n            | view.getUint8(cursor + 2);\n        }\n\n        cursor += metaLen;\n        continue;\n      }\n\n      if (status === 0xf0 || status === 0xf7) {\n        const sysexLenRead = readVlq(view, cursor);\n        cursor = sysexLenRead.nextOffset + sysexLenRead.value;\n        continue;\n      }\n\n      const eventType = status & 0xf0;\n      const channel = status & 0x0f;\n\n      if (eventType === 0xc0 || eventType === 0xd0) {\n        cursor += 1;\n        continue;\n      }\n\n      if (cursor + 1 > trackEnd) break;\n      const data1 = view.getUint8(cursor);\n      const data2 = view.getUint8(cursor + 1);\n      cursor += 2;\n\n      if (eventType === 0x90 && data2 > 0) {\n        noteStarts.set(`${channel}:${data1}`, absoluteTicks);\n      } else if (eventType === 0x80 || (eventType === 0x90 && data2 === 0)) {\n        const key = `${channel}:${data1}`;\n        const startTicks = noteStarts.get(key);\n        if (startTicks !== undefined && absoluteTicks > startTicks) {\n          notes.push({\n            pitch: data1,\n            startTicks,\n            durationTicks: absoluteTicks - startTicks,\n          });\n        }\n        noteStarts.delete(key);\n      }\n    }\n\n    notes.sort((a, b) => a.startTicks - b.startTicks || a.pitch - b.pitch);\n    parsedTracks.push(notes);\n\n    offset = trackEnd;\n  }\n\n  const bpm = Math.max(60, Math.min(220, Math.round(60000000 / tempoMicrosPerBeat)));\n\n  const tracks = parsedTracks\n    .map((notes, idx) => {\n      if (notes.length === 0) return null;\n\n      let cursorTicks = 0;\n      const outNotes = [];\n\n      for (const note of notes) {\n        const startTicks = Math.max(note.startTicks, cursorTicks);\n\n        if (startTicks > cursorTicks) {\n          const restBeats = (startTicks - cursorTicks) / ticksPerBeat;\n          outNotes.push([0, restBeats]);\n        }\n\n        const durBeats = note.durationTicks / ticksPerBeat;\n        outNotes.push([note.pitch, durBeats]);\n        cursorTicks = startTicks + note.durationTicks;\n      }\n\n      if (outNotes.length === 0) return null;\n\n      return {\n        type: WAVE_TYPES[idx % WAVE_TYPES.length],\n        volume: idx === 0 ? 0.12 : 0.08,\n        notes: outNotes,\n      };\n    })\n    .filter(Boolean);\n\n  if (tracks.length === 0) {\n    throw new Error('MIDI file does not contain playable note events');\n  }\n\n  return { bpm, tracks };\n}\n\nexport async function loadMidiSongFromUrl(url) {\n  if (MIDI_CACHE.has(url)) return MIDI_CACHE.get(url);\n\n  const res = await fetch(url, { cache: 'force-cache' });\n  if (!res.ok) {\n    throw new Error(`Failed to fetch MIDI: ${res.status}`);\n  }\n\n  const arrayBuffer = await res.arrayBuffer();\n  const song = parseMidi(arrayBuffer);\n  MIDI_CACHE.set(url, song);\n  return song;\n}\n\nexport class ChiptunePlayer {\n  constructor(song, options = {}) {\n    this.song = song;\n    this.ctx = null;\n    this.gainNode = null;\n    this.playing = false;\n    this._nodes = [];\n    this._loopTimeout = null;\n    this.volume = typeof options.volume === 'number' ? options.volume : 0.35;\n  }\n\n  // Convert MIDI note number to frequency\n  _freq(midi) {\n    return 440 * Math.pow(2, (midi - 69) / 12);\n  }\n\n  _getCtx() {\n    if (!this.ctx) {\n      this.ctx = new (window.AudioContext || window.webkitAudioContext)();\n    }\n    return this.ctx;\n  }\n\n  _playNote(freq, start, dur, type, vol) {\n    const ac = this.ctx;\n    const osc = ac.createOscillator();\n    const g = ac.createGain();\n    osc.type = type;\n    osc.frequency.setValueAtTime(freq, start);\n    g.gain.setValueAtTime(0, start);\n    g.gain.linearRampToValueAtTime(vol, start + 0.01);\n    g.gain.setValueAtTime(vol, start + dur * 0.7);\n    g.gain.linearRampToValueAtTime(0, start + dur);\n    osc.connect(g);\n    g.connect(this.gainNode);\n    osc.start(start);\n    osc.stop(start + dur + 0.05);\n    this._nodes.push(osc);\n  }\n\n  _schedule() {\n    const ac = this.ctx;\n    const beat = 60 / this.song.bpm;\n    this._nodes = [];\n\n    let maxEnd = 0;\n\n    for (const track of this.song.tracks) {\n      let t = ac.currentTime + 0.05;\n      for (const [note, beats] of track.notes) {\n        const dur = Math.max(0.01, beats * beat);\n        if (note > 0) {\n          this._playNote(this._freq(note), t, dur * 0.9, track.type, track.volume);\n        }\n        t += dur;\n      }\n      maxEnd = Math.max(maxEnd, t);\n    }\n\n    const loopIn = Math.max(50, (maxEnd - ac.currentTime - 0.1) * 1000);\n    this._loopTimeout = setTimeout(() => {\n      if (this.playing) this._schedule();\n    }, loopIn);\n  }\n\n  play() {\n    if (this.playing) return;\n    const ac = this._getCtx();\n    if (ac.state === 'suspended') {\n      ac.resume().catch(() => {\n        // Ignore autoplay resume errors; caller can retry after gesture.\n      });\n    }\n    this.gainNode = ac.createGain();\n    this.gainNode.gain.setValueAtTime(this.volume, ac.currentTime);\n    this.gainNode.connect(ac.destination);\n    this.playing = true;\n    this._schedule();\n  }\n\n  stop() {\n    if (!this.playing) return;\n    this.playing = false;\n    clearTimeout(this._loopTimeout);\n    this._nodes.forEach((n) => {\n      try {\n        n.stop();\n      } catch {\n        // Ignore nodes already stopped.\n      }\n    });\n    this._nodes = [];\n  }\n\n  toggle() {\n    if (this.playing) this.stop();\n    else this.play();\n  }\n\n  // Set master volume (0.0 - 1.0)\n  setVolume(val) {\n    this.volume = val;\n    if (this.gainNode && this.ctx) {\n      this.gainNode.gain.setValueAtTime(val, this.ctx.currentTime);\n    }\n  }\n}\n\nexport class MidiBackgroundController {\n  constructor(options = {}) {\n    this.player = null;\n    this.currentUrl = null;\n    this.volume = typeof options.volume === 'number' ? options.volume : 0.35;\n    this.unlockHandler = null;\n  }\n\n  _cleanupUnlockHandlers() {\n    if (!this.unlockHandler) return;\n    window.removeEventListener('click', this.unlockHandler);\n    window.removeEventListener('keydown', this.unlockHandler);\n    window.removeEventListener('touchstart', this.unlockHandler);\n    this.unlockHandler = null;\n  }\n\n  _armUnlockRetry() {\n    if (this.unlockHandler) return;\n    this.unlockHandler = () => {\n      if (!this.player) return;\n      this.player.play();\n      this._cleanupUnlockHandlers();\n    };\n\n    window.addEventListener('click', this.unlockHandler, { once: true });\n    window.addEventListener('keydown', this.unlockHandler, { once: true });\n    window.addEventListener('touchstart', this.unlockHandler, { once: true });\n  }\n\n  async playUrl(url) {\n    if (this.currentUrl === url && this.player?.playing) return;\n\n    const song = await loadMidiSongFromUrl(url);\n\n    this.stop();\n\n    this.player = new ChiptunePlayer(song, { volume: this.volume });\n    this.currentUrl = url;\n    this.player.play();\n\n    if (this.player.ctx?.state === 'suspended') {\n      this._armUnlockRetry();\n    }\n  }\n\n  stop() {\n    this._cleanupUnlockHandlers();\n    if (this.player) {\n      this.player.stop();\n      this.player = null;\n    }\n    this.currentUrl = null;\n  }\n}\n\n// --- Example song (remove if not needed) ---\n\nconst BPM = 140;\n\nexport const exampleSong = {\n  bpm: BPM,\n  tracks: [\n    {\n      type: 'square',\n      volume: 0.15,\n      notes: [\n        [64, 0.5], [64, 0.5], [65, 1], [67, 1],\n        [67, 1], [65, 1], [64, 0.5], [62, 0.5],\n        [60, 1], [60, 1], [62, 1], [64, 1],\n        [64, 1.5], [62, 0.5], [62, 2],\n        [64, 0.5], [64, 0.5], [65, 1], [67, 1],\n        [67, 1], [65, 1], [64, 0.5], [62, 0.5],\n        [60, 1], [60, 1], [62, 1], [64, 1],\n        [62, 1.5], [60, 0.5], [60, 2],\n      ],\n    },\n    {\n      type: 'sawtooth',\n      volume: 0.12,\n      notes: [\n        [40, 2], [43, 2], [45, 2], [47, 2],\n        [40, 2], [43, 2], [45, 2], [47, 2],\n      ],\n    },\n  ],\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/new/page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":141,"column":15,"nodeType":"JSXOpeningElement","endLine":141,"endColumn":92}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/Input';\nimport { Alert } from '@/components/ui/Alert';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { useRouter } from 'next/navigation';\nimport { CldUploadWidget } from 'next-cloudinary';\nimport Link from 'next/link';\nimport { ArrowLeft, Send, ImagePlus, X } from 'lucide-react';\nimport { extractSecureUrl, postThumb } from '@/lib/cloudinary';\nimport { getCloudinaryUploadPresetOrThrow, getPostUploadWidgetOptions } from '@/lib/cloudinaryWidget';\nimport { AddTags, type TagOption } from '@/components/forum/AddTags';\nimport { getFirstValidationError, rules, validate } from '@/lib/validation';\nimport { handleMarkdownTextareaShortcut } from '@/lib/markdownShortcuts';\n\nexport default function NewTopicPage() {\n  const { supabase } = useAuth();\n  const router = useRouter();\n  const uploadPreset = getCloudinaryUploadPresetOrThrow();\n\n  const [title, setTitle] = useState('');\n  const [content, setContent] = useState('');\n  const [selectedTags, setSelectedTags] = useState<TagOption[]>([]);\n  const [imageUrl, setImageUrl] = useState('');\n  const [error, setError] = useState('');\n  const [submitting, setSubmitting] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError('');\n\n    const validation = validate(\n      { title: title.trim(), content: content.trim() },\n      {\n        title: [\n          rules.required('Kirjoita otsikko'),\n          rules.minLength(3, 'Otsikon pit√§√§ olla v√§hint√§√§n 3 merkki√§'),\n        ],\n        content: [\n          rules.required('Kirjoita viestin sis√§lt√∂'),\n        ],\n      }\n    );\n    const firstError = getFirstValidationError(validation);\n    if (firstError) {\n      setError(firstError);\n      return;\n    }\n    setSubmitting(true);\n\n    try {\n      const { data: topicIdResult, error: createError } = await supabase.rpc('create_topic_with_post', {\n        input_title: title.trim(),\n        input_content: content.trim(),\n        input_image_url: imageUrl || null,\n        input_tag_ids: selectedTags.map((tag) => tag.id),\n      });\n\n      if (createError || typeof topicIdResult !== 'number') {\n        throw createError ?? new Error('Langan luominen feilasi');\n      }\n\n      router.push(`/topic/${topicIdResult}`);\n    } catch (err: unknown) {\n      const message = err instanceof Error ? err.message : 'Langan luominen feilasi';\n      setError(message);\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"layout-page-shell-thread max-w-4xl\">\n      <div className=\"mb-6\">\n        <Link href=\"/\" className=\"app-back-link\">\n          <ArrowLeft size={16} />\n          Takaisin lankoihin\n        </Link>\n      </div>\n\n      <Card>\n        <h1 className=\"text-3xl font-bold mb-6\">Uusi lanka</h1>\n\n        {error && <Alert variant=\"error\">{error}</Alert>}\n\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div>\n            <label htmlFor=\"title\" className=\"form-label\">\n              Otsikko\n            </label>\n            <Input\n              id=\"title\"\n              value={title}\n              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setTitle(e.target.value)}\n              placeholder=\"Langan otsikko\"\n              required\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"content\" className=\"form-label\">\n              Viesti\n            </label>\n            <textarea\n              id=\"content\"\n              value={content}\n              onChange={(e) => setContent(e.target.value)}\n              onKeyDown={(e) => {\n                handleMarkdownTextareaShortcut(e, content, setContent);\n              }}\n              className=\"field-textarea field-textarea--new-topic\"\n              placeholder=\"Kirjoita viestisi...\"\n              required\n            />\n            <p className=\"mt-2 text-muted-xs\">\n              <a\n                href=\"https://www.markdownguide.org/cheat-sheet/\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"content-inline-link\"\n              >\n                Muotoile viesti Markdownilla\n              </a>\n            </p>\n          </div>\n\n          <AddTags\n            selected={selectedTags}\n            onChange={setSelectedTags}\n            disabled={submitting}\n            maxSelected={1}\n            featuredOnly={null}\n            label=\"Tagi\"\n            placeholder=\"Valitse tagi (jos tyhj√§, k√§ytet√§√§n off-topic)\"\n          />\n\n          {imageUrl && (\n            <div className=\"relative inline-block\">\n              <img src={postThumb(imageUrl)} alt=\"Liite\" className=\"max-h-40 rounded-lg\" />\n              <button\n                type=\"button\"\n                onClick={() => setImageUrl('')}\n                className=\"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600\"\n              >\n                <X size={14} />\n              </button>\n            </div>\n          )}\n\n          <div className=\"composer-actions\">\n            <CldUploadWidget\n              uploadPreset={uploadPreset}\n              options={getPostUploadWidgetOptions()}\n              onSuccess={(result: unknown) => {\n                const secureUrl = extractSecureUrl(result);\n                if (secureUrl) {\n                  setImageUrl(secureUrl);\n                }\n              }}\n            >\n              {({ open }) => (\n                <Button type=\"button\" variant=\"outline\" className=\"flex items-center gap-2\" onClick={() => open()}>\n                  <ImagePlus size={16} />\n                  Lis√§√§ kuva\n                </Button>\n              )}\n            </CldUploadWidget>\n            <Button\n              type=\"submit\"\n              variant=\"primary\"\n              disabled={submitting}\n              className=\"composer-actions-submit flex items-center gap-2\"\n            >\n              <Send size={16} />\n              {submitting ? 'Luodaan...' : 'Luo lanka'}\n            </Button>\n          </div>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/page.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'ForumContent' has a complexity of 16. Maximum allowed is 12.","line":37,"column":1,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":37,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { Suspense, useEffect, useMemo, useState } from 'react';\nimport Link from 'next/link';\nimport { Heart } from 'lucide-react';\nimport { Card } from '@/components/ui/Card';\nimport { Alert } from '@/components/ui/Alert';\nimport { Button } from '@/components/ui/button';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { formatFinnishDateTime } from '@/lib/formatDate';\nimport { eventOccursOnDate } from '@/lib/siteEvents';\nimport { useForumTopics } from '@/hooks/useForumTopics';\nimport { useForumQuote } from '@/hooks/useForumQuote';\nimport { ForumThreadList } from '@/components/forum/ForumThreadList';\nimport { reportError } from '@/lib/reportError';\n\ninterface RawSiteEventRow {\n  id: number;\n  name: string;\n  event_date: string;\n  repeats_yearly: boolean;\n  date_range_enabled: boolean;\n  range_start_date: string | null;\n  range_end_date: string | null;\n}\n\nfunction formatEventDate(dateValue: string): string {\n  if (!dateValue) return '-';\n  const date = new Date(`${dateValue}T00:00:00`);\n  return new Intl.DateTimeFormat('fi-FI', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n  }).format(date);\n}\n\nfunction ForumContent() {\n  const { supabase, currentUser, profile } = useAuth();\n  const realtimeUpdatesEnabled =\n    (profile as { realtime_updates_enabled?: boolean } | null)?.realtime_updates_enabled === true;\n\n  const {\n    topics,\n    threadCount,\n    messageCount,\n    loading,\n    loadingMore,\n    requestedTagIds,\n    unreadOnly,\n    visibleCount,\n    handleShowMore,\n    pushUnreadOnlyUrl,\n    refreshTick,\n    dataError,\n    retryDataFetch,\n  } = useForumTopics({\n    supabase,\n    currentUser,\n    realtimeUpdatesEnabled,\n  });\n\n  const { quote, quoteLikeSaving, quoteError, handleToggleQuoteLike } = useForumQuote({\n    supabase,\n    currentUser,\n    refreshKey: refreshTick,\n  });\n\n  const [todaySingleDayEvent, setTodaySingleDayEvent] = useState<RawSiteEventRow | null>(null);\n  const [eventError, setEventError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const fetchTodaySingleDayEvent = async () => {\n      try {\n        setEventError(null);\n        const { data, error } = await supabase\n          .from('site_events')\n          .select('id, name, event_date, repeats_yearly, date_range_enabled, range_start_date, range_end_date');\n\n        if (error || !data) {\n          if (error) {\n            reportError({ scope: 'forum.fetchTodaySingleDayEvent', error });\n          }\n          setTodaySingleDayEvent(null);\n          setEventError('Tapahtumatiedon lataus ep√§onnistui.');\n          return;\n        }\n\n        const today = new Date();\n        const matches = (data as RawSiteEventRow[])\n          .filter((event) => event.date_range_enabled !== true)\n          .filter((event) => eventOccursOnDate(event, today))\n          .sort((a, b) => b.id - a.id);\n\n        setTodaySingleDayEvent(matches[0] ?? null);\n      } catch (error) {\n        reportError({ scope: 'forum.fetchTodaySingleDayEvent', error });\n        setTodaySingleDayEvent(null);\n        setEventError('Tapahtumatiedon lataus ep√§onnistui.');\n      }\n    };\n\n    void fetchTodaySingleDayEvent();\n  }, [supabase, refreshTick]);\n\n  const unreadThreadCount = useMemo(\n    () => topics.filter((topic) => topic.unread_count > 0).length,\n    [topics]\n  );\n\n  if (loading) {\n    return (\n      <div className=\"layout-page-shell\">\n        <Card>\n          <p className=\"state-empty-text\">Ladataan...</p>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"layout-page-shell\">\n      <div className=\"mb-6\">\n        {(dataError || quoteError || eventError) && (\n          <Alert variant=\"error\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <span>{dataError || quoteError || eventError}</span>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={retryDataFetch}\n                className=\"admin-compact-btn\"\n              >\n                Yrit√§ uudelleen\n              </Button>\n            </div>\n          </Alert>\n        )}\n\n        <div className=\"flex items-start justify-between gap-4\">\n          <div className=\"flex-1 min-w-0\">\n            {todaySingleDayEvent ? (\n              <div className=\"min-w-0 text-gray-500 text-xs italic leading-relaxed\">\n                üéÇ T√§n√§√§n on {todaySingleDayEvent.name} ({formatEventDate(todaySingleDayEvent.event_date)} -)\n              </div>\n            ) : quote ? (\n              <div className=\"min-w-0 text-gray-500 text-xs italic leading-relaxed flex items-center gap-2\">\n                <button\n                  type=\"button\"\n                  onClick={handleToggleQuoteLike}\n                  disabled={quoteLikeSaving}\n                  className={`inline-flex h-5 items-center gap-1 rounded px-1.5 not-italic leading-none transition ${\n                    quote.liked_by_me\n                      ? 'text-red-600 bg-red-50 hover:bg-red-100'\n                      : 'text-gray-500 hover:text-red-600 hover:bg-gray-100'\n                  }`}\n                  title={quote.liked_by_me ? 'Poista tykk√§ys lainaukselta' : 'Tykk√§√§ lainauksesta'}\n                >\n                  <Heart size={12} className={`h-3 w-3 shrink-0 ${quote.liked_by_me ? 'fill-current' : ''}`} />\n                  <span className=\"inline-flex items-center leading-none tabular-nums\">{quote.likes_count}</span>\n                </button>\n                <span className=\"min-w-0 break-words\">\n                  &ldquo;{quote.content}&rdquo; &mdash; {quote.author_username || 'tuntematon'},{' '}\n                  <Link href={`/topic/${quote.topic_id}`} className=\"content-inline-link not-italic\">\n                    {formatFinnishDateTime(quote.created_at)}\n                  </Link>\n                </span>\n              </div>\n            ) : null}\n          </div>\n\n          <p className=\"text-muted-xs whitespace-nowrap text-right\">\n            {threadCount} lankaa, {messageCount} viesti√§\n            {unreadThreadCount > 0 && (\n              <>\n                ,{' '}\n                <button\n                  type=\"button\"\n                  onClick={() => pushUnreadOnlyUrl(!unreadOnly)}\n                  className=\"text-highlight-glimmer hover:underline\"\n                  title={unreadOnly ? 'N√§yt√§ kaikki langat' : 'N√§yt√§ vain lukemattomat langat'}\n                >\n                  {unreadThreadCount} lukematonta\n                </button>\n              </>\n            )}\n            .\n          </p>\n        </div>\n\n      </div>\n\n      <ForumThreadList\n        topics={topics}\n        threadCount={threadCount}\n        visibleCount={visibleCount}\n        loadingMore={loadingMore}\n        unreadOnly={unreadOnly}\n        requestedTagIds={requestedTagIds}\n        onShowMore={handleShowMore}\n      />\n    </div>\n  );\n}\n\nexport default function ForumPage() {\n  return (\n    <Suspense\n      fallback={\n        <div className=\"layout-page-shell\">\n          <Card>\n            <p className=\"state-empty-text\">Ladataan...</p>\n          </Card>\n        </div>\n      }\n    >\n      <ForumContent />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/pending-approval/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/profile/[id]/page.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'PublicProfilePage' has a complexity of 25. Maximum allowed is 12.","line":41,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":41,"endColumn":42},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":141,"column":13,"nodeType":"JSXOpeningElement","endLine":141,"endColumn":115}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { useParams, useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, Calendar, Shield, Link as LinkIcon, User } from 'lucide-react';\nimport { profileMedium } from '@/lib/cloudinary';\nimport { TopFiveCard } from '@/components/profile/TopFiveCard';\nimport { ProfileStats } from '@/components/profile/ProfileStats';\nimport { TrophiesCard } from '@/components/profile/TrophiesCard';\nimport { useProfileStats } from '@/hooks/useProfileStats';\nimport { formatFinnishDate } from '@/lib/formatDate';\n\ninterface UserProfile {\n  id: string;\n  username: string;\n  display_name: string | null;\n  profile_image_url: string | null;\n  created_at: string;\n  is_admin: boolean;\n  signature: string | null;\n  show_signature: boolean;\n  link_url: string | null;\n  link_description: string | null;\n  login_count: number;\n  login_network_count: number;\n}\n\nfunction safeHttpUrl(rawUrl: string | null): string | null {\n  if (!rawUrl) return null;\n  try {\n    const parsed = new URL(rawUrl);\n    return parsed.protocol === 'http:' || parsed.protocol === 'https:' ? parsed.toString() : null;\n  } catch {\n    return null;\n  }\n}\n\nexport default function PublicProfilePage() {\n  const params = useParams();\n  const router = useRouter();\n  const { currentUser, profile: myProfile, supabase } = useAuth();\n  const userId = params.id as string;\n\n  const [profile, setProfile] = useState<UserProfile | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [adminCount, setAdminCount] = useState(0);\n  const [togglingAdmin, setTogglingAdmin] = useState(false);\n\n  const { postCount, topicCount, trophies, mostPopularTopic, mostActiveTopic } = useProfileStats(userId);\n\n  // Redirect to own profile page if viewing self\n  useEffect(() => {\n    if (currentUser && userId === currentUser.id) {\n      router.replace('/profile');\n    }\n  }, [currentUser, userId, router]);\n\n  useEffect(() => {\n    const fetchProfile = async () => {\n      const [profileRes, adminRes] = await Promise.all([\n        supabase\n          .from('profiles')\n          .select('id, username, display_name, profile_image_url, created_at, is_admin, signature, show_signature, link_url, link_description, login_count, login_network_count')\n          .eq('id', userId)\n          .single(),\n        supabase\n          .from('profiles')\n          .select('*', { count: 'exact', head: true })\n          .eq('is_admin', true),\n      ]);\n\n      if (profileRes.data) setProfile(profileRes.data as UserProfile);\n      setAdminCount(adminRes.count || 0);\n      setLoading(false);\n    };\n\n    fetchProfile();\n  }, [supabase, userId]);\n\n  const handleToggleAdmin = async () => {\n    if (!profile) return;\n    setTogglingAdmin(true);\n\n    const newValue = !profile.is_admin;\n    const { error } = await supabase.rpc('set_user_admin', {\n      target_user_id: profile.id,\n      make_admin: newValue,\n    });\n\n    if (!error) {\n      setProfile({ ...profile, is_admin: newValue });\n      setAdminCount((prev) => prev + (newValue ? 1 : -1));\n    }\n    setTogglingAdmin(false);\n  };\n\n  const isCurrentUserAdmin = myProfile?.is_admin;\n  const isLastAdmin = profile?.is_admin && adminCount <= 1;\n  const profileLink = safeHttpUrl(profile?.link_url ?? null);\n\n  if (loading) {\n    return (\n      <div className=\"page-container\">\n        <Card>\n          <p className=\"state-empty-text\">Ladataan...</p>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!profile) {\n    return (\n      <div className=\"page-container\">\n        <Card>\n          <h2 className=\"text-2xl font-bold\">K√§ytt√§j√§√§ ei l√∂ytynyt</h2>\n          <Link href=\"/\" className=\"app-back-link mt-4\">\n            <ArrowLeft size={16} />\n            Takaisin foorumille\n          </Link>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"page-container\">\n      <div className=\"mb-6\">\n        <Link href=\"/\" className=\"app-back-link\">\n          <ArrowLeft size={16} />\n          Takaisin foorumille\n        </Link>\n      </div>\n\n      {/* Profile Header + Stats */}\n      <Card className=\"mb-6\">\n        <div className=\"flex items-center gap-4\">\n          {profile.profile_image_url ? (\n            <img src={profileMedium(profile.profile_image_url)} alt={profile.username} className=\"avatar-large\" />\n          ) : (\n            <span className=\"avatar-large-fallback\">\n              <User size={30} />\n            </span>\n          )}\n          <div className=\"flex-1\">\n            <h1 className=\"text-3xl font-bold\">{profile.username}</h1>\n            {profile.display_name && (\n              <p className=\"text-sm text-gray-600\">{profile.display_name}</p>\n            )}\n            <p className=\"flex items-center gap-1 text-muted-sm mt-1\">\n              <Calendar size={14} />\n              J√§sen {formatFinnishDate(profile.created_at)} alkaen\n            </p>\n            <div className=\"flex items-center gap-2 mt-2\">\n              {isCurrentUserAdmin && profile.is_admin && (\n                <span className=\"admin-badge\">\n                  <Shield size={12} />\n                  Admin\n                </span>\n              )}\n              {profileLink && (\n                <a\n                  href={profileLink}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"inline-flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-800\"\n                >\n                  <LinkIcon size={12} />\n                  {profile.link_description || profileLink}\n                </a>\n              )}\n            </div>\n          </div>\n          {isCurrentUserAdmin && (\n            <div className=\"flex-shrink-0\">\n              <button\n                onClick={handleToggleAdmin}\n                disabled={togglingAdmin || (isLastAdmin ?? false)}\n                className={`flex items-center gap-2 px-3 py-2 rounded text-sm font-medium transition ${\n                  profile.is_admin\n                    ? 'bg-red-100 text-red-700 hover:bg-red-200'\n                    : 'bg-green-100 text-green-700 hover:bg-green-200'\n                } ${(togglingAdmin || isLastAdmin) ? 'opacity-50 cursor-not-allowed' : ''}`}\n                title={isLastAdmin ? 'V√§hint√§√§n yksi admin tarvitaan' : ''}\n              >\n                <Shield size={16} />\n                {profile.is_admin ? 'Poista admin' : 'Tee admin'}\n              </button>\n            </div>\n          )}\n        </div>\n\n        <hr className=\"border-gray-200 my-4\" />\n\n        <ProfileStats\n          postCount={postCount}\n          topicCount={topicCount}\n          loginCount={profile.login_count}\n          loginNetworkCount={profile.login_network_count || 0}\n          mostPopularTopic={mostPopularTopic}\n          mostActiveTopic={mostActiveTopic}\n        />\n      </Card>\n\n      {/* Signature */}\n      {profile.signature && profile.show_signature && (\n        <Card className=\"mb-6\">\n          <p className=\"text-sm text-gray-600 italic whitespace-pre-wrap\">{profile.signature}</p>\n        </Card>\n      )}\n\n      <TrophiesCard trophies={trophies} />\n\n      <TopFiveCard profileId={userId} />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/profile/page.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'ProfilePage' has a complexity of 22. Maximum allowed is 12.","line":25,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":25,"endColumn":36},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":81,"column":11,"nodeType":"JSXOpeningElement","endLine":85,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { profileMedium } from '@/lib/cloudinary';\nimport { User, BarChart3 } from 'lucide-react';\nimport { formatFinnishDate } from '@/lib/formatDate';\nimport { TopFiveCard } from '@/components/profile/TopFiveCard';\nimport { ProfileStats } from '@/components/profile/ProfileStats';\nimport { TrophiesCard } from '@/components/profile/TrophiesCard';\nimport { EditProfileForm } from '@/components/profile/EditProfileForm';\nimport { SettingsPanel } from '@/components/profile/SettingsPanel';\nimport { HdSettingsPanel } from '@/components/profile/HdSettingsPanel';\nimport { useProfileStats } from '@/hooks/useProfileStats';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\n\ntype ProfileTab = 'profile' | 'edit' | 'settings' | 'chick';\nconst PROFILE_TABS: ProfileTab[] = ['profile', 'edit', 'settings', 'chick'];\n\nfunction isProfileTab(value: string): value is ProfileTab {\n  return PROFILE_TABS.includes(value as ProfileTab);\n}\n\nexport default function ProfilePage() {\n  const { currentUser, profile, loading } = useAuth();\n  const typedProfile = profile as {\n    username?: string;\n    profile_image_url?: string;\n    created_at?: string;\n    login_count?: number;\n    login_network_count?: number;\n    realtime_updates_enabled?: boolean;\n    retro_enabled?: boolean;\n    midi_enabled?: boolean;\n    hidden_tag_ids?: number[];\n    hidden_tag_group_ids?: number[];\n    legacy_tag_icons_enabled?: boolean;\n  } | null;\n\n  const [activeTab, setActiveTab] = useState<ProfileTab>('profile');\n  const { postCount, topicCount, trophies, mostPopularTopic, mostActiveTopic } = useProfileStats(currentUser?.id ?? null);\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n\n  useEffect(() => {\n    const syncTabFromHash = () => {\n      const hash = window.location.hash.replace('#', '').toLowerCase();\n      if (isProfileTab(hash)) {\n        setActiveTab(hash);\n      } else if (window.location.hash) {\n        setActiveTab('profile');\n      }\n    };\n\n    syncTabFromHash();\n    window.addEventListener('hashchange', syncTabFromHash);\n    return () => window.removeEventListener('hashchange', syncTabFromHash);\n  }, []);\n\n  useEffect(() => {\n    const nextHash = `#${activeTab}`;\n    if (window.location.hash !== nextHash) {\n      window.history.replaceState(null, '', nextHash);\n    }\n  }, [activeTab]);\n\n  if (loading || !typedProfile) {\n    return (\n      <div className=\"page-container\">\n        <Card>\n          <p className=\"state-empty-text\">Ladataan...</p>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"page-container\">\n      <div className=\"mb-6 flex items-center gap-4\">\n        {typedProfile.profile_image_url ? (\n          <img\n            src={profileMedium(typedProfile.profile_image_url)}\n            alt={typedProfile.username || 'Profiili'}\n            className=\"avatar-large\"\n          />\n        ) : (\n          <span className=\"avatar-large-fallback\">\n            <User size={30} />\n          </span>\n        )}\n        <div className=\"min-w-0\">\n          <h1 className=\"text-3xl font-bold truncate font-mono\">{typedProfile.username}</h1>\n          <p className=\"text-muted-sm\">\n            Liittymisp√§iv√§ {typedProfile.created_at ? formatFinnishDate(typedProfile.created_at) : ''}\n          </p>\n        </div>\n      </div>\n\n      <div className=\"page-tabs mb-6\">\n        {(['profile', 'edit', 'settings', 'chick'] as const).map((tab) => (\n          <button\n            key={tab}\n            type=\"button\"\n            onClick={() => setActiveTab(tab)}\n            className={`page-tab-button ${activeTab === tab ? 'is-active' : ''}`}\n          >\n            {tab === 'profile' ? 'Profiili' : tab === 'edit' ? 'Muokkaa' : tab === 'settings' ? 'Asetukset' : 'üê£'}\n          </button>\n        ))}\n      </div>\n\n      {activeTab === 'profile' && (\n        <>\n          <Card className=\"mb-6\">\n            <h2 className=\"card-title flex items-center gap-2\">\n              {showHeaderIcons && <BarChart3 size={20} className=\"text-yellow-600\" />}\n              Tilastot\n            </h2>\n\n            <ProfileStats\n              postCount={postCount}\n              topicCount={topicCount}\n              loginCount={typedProfile.login_count || 0}\n              loginNetworkCount={typedProfile.login_network_count || 0}\n              mostPopularTopic={mostPopularTopic}\n              mostActiveTopic={mostActiveTopic}\n            />\n          </Card>\n\n          <TrophiesCard trophies={trophies} />\n\n          {currentUser && <TopFiveCard profileId={currentUser.id} className=\"mb-6\" />}\n        </>\n      )}\n\n      {activeTab === 'edit' && <EditProfileForm />}\n\n      {activeTab === 'settings' && (\n        <SettingsPanel\n          initialRealtimeEnabled={typedProfile.realtime_updates_enabled ?? false}\n          initialLegacyTagIconsEnabled={typedProfile.legacy_tag_icons_enabled ?? true}\n          initialHiddenTagIds={Array.isArray(typedProfile.hidden_tag_ids) ? typedProfile.hidden_tag_ids : []}\n          initialHiddenTagGroupIds={Array.isArray(typedProfile.hidden_tag_group_ids) ? typedProfile.hidden_tag_group_ids : []}\n        />\n      )}\n\n      {activeTab === 'chick' && (\n        <HdSettingsPanel\n          initialRetroEnabled={typedProfile.retro_enabled ?? false}\n          initialMidiEnabled={typedProfile.midi_enabled ?? false}\n        />\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/register/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/search/page.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'SearchContent' has a complexity of 29. Maximum allowed is 12.","line":47,"column":1,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":47,"endColumn":23},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 31 to the 15 allowed.","line":47,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":47,"endColumn":23},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 23 to the 15 allowed.","line":86,"column":58,"nodeType":null,"messageId":"refactorFunction","endLine":86,"endColumn":60},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 22. Maximum allowed is 12.","line":86,"column":58,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":86,"endColumn":60},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (431). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":432,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState, useCallback, Suspense } from 'react';\nimport { useSearchParams, useRouter } from 'next/navigation';\nimport { Card } from '@/components/ui/Card';\nimport { SearchInput } from '@/components/ui/SearchInput';\nimport { useAuth } from '@/contexts/AuthContext';\nimport Link from 'next/link';\nimport { Search, MessageSquare, FileText, ArrowLeft } from 'lucide-react';\nimport { formatFinnishRelative } from '@/lib/formatDate';\nimport type { ReactNode } from 'react';\nimport { TagChipLink } from '@/components/ui/TagChipLink';\nimport { TagIcon } from '@/components/ui/TagIcon';\n\ninterface SearchResult {\n  result_type: 'topic' | 'post';\n  topic_id: number;\n  topic_title: string;\n  content_snippet: string | null;\n  category_name: string;\n  category_icon: string;\n  author_username: string;\n  author_profile_image_url: string | null;\n  similarity_score: number;\n  created_at: string;\n  last_post_created_at: string | null;\n}\n\ninterface TagHit {\n  id: number;\n  name: string;\n  slug: string;\n  icon?: string;\n}\n\ninterface TagGroupHit {\n  group_id: number;\n  group_name: string;\n  group_slug: string;\n  member_count: number;\n  member_tag_ids: number[];\n}\n\ntype SearchFilter = 'all' | 'topics' | 'posts' | 'tags' | 'groups';\ntype SearchSortMode = 'latest' | 'best';\n\nfunction SearchContent() {\n  const searchParams = useSearchParams();\n  const router = useRouter();\n  const { supabase, profile } = useAuth();\n\n  const query = searchParams.get('q') || '';\n  const [results, setResults] = useState<SearchResult[]>([]);\n  const [tagHits, setTagHits] = useState<TagHit[]>([]);\n  const [groupHits, setGroupHits] = useState<TagGroupHit[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [searchInput, setSearchInput] = useState(query);\n  const [searchError, setSearchError] = useState('');\n  const [activeFilter, setActiveFilter] = useState<SearchFilter>('all');\n  const [sortMode, setSortMode] = useState<SearchSortMode>(() => {\n    if (typeof window === 'undefined') return 'latest';\n    const saved = window.localStorage.getItem('search.sortMode');\n    return saved === 'best' ? 'best' : 'latest';\n  });\n\n  const highlightMatch = (text: string, needle: string): ReactNode => {\n    const trimmedNeedle = needle.trim();\n    if (!trimmedNeedle) return text;\n\n    const escaped = trimmedNeedle.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n    const regex = new RegExp(`(${escaped})`, 'gi');\n    const parts = text.split(regex);\n\n    const lowerNeedle = trimmedNeedle.toLocaleLowerCase();\n    return parts.map((part, index) =>\n      part.toLocaleLowerCase() === lowerNeedle ? (\n        <mark key={`${part}-${index}`} className=\"bg-yellow-100 text-inherit rounded px-0.5\">\n          {part}\n        </mark>\n      ) : (\n        <span key={`${part}-${index}`}>{part}</span>\n      )\n    );\n  };\n\n  const performSearch = useCallback(async (term: string) => {\n    if (term.trim().length < 2) {\n      setResults([]);\n      setTagHits([]);\n      setGroupHits([]);\n      setSearchError('');\n      return;\n    }\n    setLoading(true);\n    setSearchError('');\n    const trimmedTerm = term.trim();\n\n    const [contentRes, tagRes, groupRes] = await Promise.all([\n      supabase.rpc('search_forum', {\n        search_term: trimmedTerm,\n        result_limit: 30,\n      }),\n      fetch(`/api/tags?status=approved&query=${encodeURIComponent(trimmedTerm)}&limit=8`, {\n        cache: 'no-store',\n      }),\n      supabase.rpc('search_tag_groups', {\n        input_query: trimmedTerm,\n        input_limit: 6,\n      }),\n    ]);\n\n    const { data, error } = contentRes;\n    if (!error && data) {\n      const rawResults = data as SearchResult[];\n      const categoryNames = Array.from(\n        new Set(rawResults.map((row) => row.category_name).filter((name) => !!name))\n      );\n\n      if (categoryNames.length > 0) {\n        const legacyTagIconsEnabled =\n          (profile as { legacy_tag_icons_enabled?: boolean } | null)?.legacy_tag_icons_enabled !== false;\n        const { data: tagRows } = await supabase\n          .from('tags')\n          .select('name, icon, legacy_icon_path')\n          .in('name', categoryNames)\n          .is('redirect_to_tag_id', null);\n\n        const iconByName = new Map<string, string>();\n        for (const row of (tagRows || []) as Record<string, unknown>[]) {\n          const name = String(row.name || '');\n          const legacyIconPath = String(row.legacy_icon_path || '').trim();\n          const icon = String(row.icon || '').trim();\n          if (!name) continue;\n          iconByName.set(name, (legacyTagIconsEnabled ? legacyIconPath : '') || icon || 'üè∑Ô∏è');\n        }\n\n        setResults(\n          rawResults.map((row) => ({\n            ...row,\n            category_icon: iconByName.get(row.category_name) || row.category_icon || 'üè∑Ô∏è',\n          }))\n        );\n      } else {\n        setResults(rawResults);\n      }\n    } else {\n      setResults([]);\n      setSearchError(error?.message || 'Haku ep√§onnistui');\n    }\n\n    if (tagRes.ok) {\n      const payload = (await tagRes.json()) as { tags?: TagHit[] };\n      setTagHits(payload.tags || []);\n    } else {\n      setTagHits([]);\n    }\n\n    if (!groupRes.error && groupRes.data) {\n      const normalizedGroups = ((groupRes.data || []) as Record<string, unknown>[]).map((row) => ({\n        group_id: Number(row.group_id),\n        group_name: String(row.group_name ?? ''),\n        group_slug: String(row.group_slug ?? ''),\n        member_count: Number(row.member_count ?? 0),\n        member_tag_ids: Array.isArray(row.member_tag_ids)\n          ? row.member_tag_ids\n              .map((value) => Number.parseInt(String(value), 10))\n              .filter((value) => Number.isFinite(value) && value > 0)\n          : [],\n      })) as TagGroupHit[];\n      setGroupHits(normalizedGroups);\n    } else {\n      setGroupHits([]);\n    }\n    setLoading(false);\n  }, [profile, supabase]);\n\n  useEffect(() => {\n    const timer = window.setTimeout(() => {\n      void performSearch(query);\n    }, 0);\n    return () => window.clearTimeout(timer);\n  }, [query, performSearch]);\n\n  useEffect(() => {\n    window.localStorage.setItem('search.sortMode', sortMode);\n  }, [sortMode]);\n\n  const handleSearch = (e: React.FormEvent) => {\n    e.preventDefault();\n    const trimmed = searchInput.trim();\n    if (trimmed.length >= 2) {\n      setActiveFilter('all');\n      router.push(`/search?q=${encodeURIComponent(trimmed)}`);\n    }\n  };\n\n  const sortByLastActivity = (a: SearchResult, b: SearchResult) => {\n    const aTime = new Date(a.last_post_created_at || a.created_at).getTime();\n    const bTime = new Date(b.last_post_created_at || b.created_at).getTime();\n    return bTime - aTime;\n  };\n  const sortByBest = (a: SearchResult, b: SearchResult) => {\n    if (b.similarity_score !== a.similarity_score) {\n      return b.similarity_score - a.similarity_score;\n    }\n    return sortByLastActivity(a, b);\n  };\n  const resultSorter = sortMode === 'best' ? sortByBest : sortByLastActivity;\n\n  const topicResults = results.filter((result) => result.result_type === 'topic').sort(resultSorter);\n  const postResults = results.filter((result) => result.result_type === 'post').sort(resultSorter);\n  const allContentResults = [...topicResults, ...postResults].sort(resultSorter);\n\n  const visibleContentResults = activeFilter === 'topics'\n    ? topicResults\n    : activeFilter === 'posts'\n      ? postResults\n      : allContentResults;\n\n  const visibleTags = activeFilter === 'groups' ? [] : tagHits;\n  const visibleGroups = activeFilter === 'tags' ? [] : groupHits;\n  const showsTagSection = activeFilter === 'all' || activeFilter === 'tags' || activeFilter === 'groups';\n  const showsContentSection = activeFilter === 'all' || activeFilter === 'topics' || activeFilter === 'posts';\n\n  const filterButtonClass = (filter: SearchFilter) =>\n    `text-sm underline underline-offset-2 ${activeFilter === filter ? 'text-yellow-700 font-semibold' : 'text-gray-600 hover:text-yellow-700'}`;\n\n  return (\n    <div className=\"layout-page-shell\">\n      <div className=\"mb-6\">\n        <div className=\"section-head-row\">\n          <Search size={28} className=\"text-gray-800\" />\n          <h2 className=\"text-3xl font-bold\">Haku</h2>\n        </div>\n\n        <form onSubmit={handleSearch} className=\"flex gap-2\">\n          <SearchInput\n            value={searchInput}\n            onChange={(e) => setSearchInput(e.target.value)}\n            placeholder=\"Hae aiheista ja viesteist√§...\"\n            wrapperClassName=\"flex-1\"\n          />\n          <button\n            type=\"submit\"\n            className=\"px-6 py-2 bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold rounded transition\"\n          >\n            Hae\n          </button>\n        </form>\n\n        {query && loading && <p className=\"mt-3 text-sm text-gray-600\">Haetaan...</p>}\n      </div>\n\n      <div className=\"mb-4\">\n        <Link href=\"/\" className=\"app-back-link\">\n          <ArrowLeft size={16} />\n          Takaisin foorumille\n        </Link>\n      </div>\n\n      {loading ? (\n        <Card>\n          <p className=\"state-empty-text\">Haetaan tuloksia...</p>\n        </Card>\n      ) : searchError ? (\n        <Card>\n          <p className=\"state-empty-text text-red-600\">\n            Haku ep√§onnistui: {searchError}\n          </p>\n        </Card>\n      ) : (\n        <Card>\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <h3 className=\"text-lg font-semibold text-gray-800\">Hakutulokset</h3>\n              <div className=\"inline-flex items-center rounded-md border border-gray-300 overflow-hidden\">\n                <button\n                  type=\"button\"\n                  onClick={() => setSortMode('latest')}\n                  className={`px-3 py-1 text-xs font-medium transition ${\n                    sortMode === 'latest' ? 'bg-yellow-100 text-yellow-800' : 'bg-white text-gray-600 hover:bg-gray-50'\n                  }`}\n                >\n                  Uusimmat\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => setSortMode('best')}\n                  className={`px-3 py-1 text-xs font-medium transition border-l border-gray-300 ${\n                    sortMode === 'best' ? 'bg-yellow-100 text-yellow-800' : 'bg-white text-gray-600 hover:bg-gray-50'\n                  }`}\n                >\n                  Parhaat\n                </button>\n              </div>\n            </div>\n\n            {query && (\n              <div className=\"flex flex-wrap items-center gap-x-3 gap-y-1\">\n<button type=\"button\" className={filterButtonClass('all')} onClick={() => setActiveFilter('all')}>\n                  Kaikki:\n                </button>\n                <button type=\"button\" className={filterButtonClass('topics')} onClick={() => setActiveFilter('topics')}>\n                  {topicResults.length} lankaa\n                </button>\n                <button type=\"button\" className={filterButtonClass('posts')} onClick={() => setActiveFilter('posts')}>\n                  {postResults.length} viesti√§\n                </button>\n                <button type=\"button\" className={filterButtonClass('tags')} onClick={() => setActiveFilter('tags')}>\n                  {tagHits.length} aihetta\n                </button>\n                <button type=\"button\" className={filterButtonClass('groups')} onClick={() => setActiveFilter('groups')}>\n                  {groupHits.length} ryhm√§√§\n                </button>\n\n              </div>\n            )}\n\n            {showsTagSection && (visibleGroups.length > 0 || visibleTags.length > 0) && (\n              <div className=\"flex flex-wrap gap-2\">\n                {visibleGroups.map((group) => {\n                  const tagParams = group.member_tag_ids.join(',');\n                  if (!tagParams) return null;\n                  return (\n                    <TagChipLink\n                      key={`group-${group.group_id}`}\n                      href={`/?tags=${tagParams}`}\n                      variant=\"group\"\n                      size=\"md\"\n                      icon=\"üìö\"\n                    >\n                      <span>{highlightMatch(group.group_name, query)}</span>\n                      <span className=\"text-xs text-blue-700\">({group.member_count})</span>\n                    </TagChipLink>\n                  );\n                })}\n                {visibleTags.map((tag) => (\n                  <TagChipLink\n                    key={`tag-${tag.id}`}\n                    href={`/?tags=${tag.id}`}\n                    size=\"md\"\n                    icon={tag.icon || 'üè∑Ô∏è'}\n                  >\n                    <span>{highlightMatch(tag.name, query)}</span>\n                  </TagChipLink>\n                ))}\n              </div>\n            )}\n\n            {showsContentSection && visibleContentResults.length === 0 && query ? (\n              <p className=\"state-empty-text\">\n                Ei sis√§lt√∂osumia haulle &quot;{query}&quot;. Kokeile eri hakusanoja.\n              </p>\n            ) : showsContentSection ? (\n              <div className=\"list-surface\">\n                {visibleContentResults.map((result, index) => (\n                  <Link\n                    key={`${result.topic_id}-${result.result_type}-${index}`}\n                    href={`/topic/${result.topic_id}`}\n                    className=\"block hover:bg-yellow-50 transition\"\n                  >\n                    <div className=\"flex items-center gap-3 px-4 py-3\">\n                      <div className=\"flex-shrink-0 w-8 text-center\">\n                        <TagIcon\n                          icon={result.category_icon}\n                          alt={`${result.category_name} icon`}\n                          className=\"tag-icon-sm text-2xl\"\n                        />\n                      </div>\n\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          {result.result_type === 'topic' ? (\n                            <FileText size={14} className=\"text-yellow-600 flex-shrink-0\" />\n                          ) : (\n                            <MessageSquare size={14} className=\"text-blue-500 flex-shrink-0\" />\n                          )}\n                          <h3 className=\"text-lg font-bold text-gray-800 truncate\">\n                            {highlightMatch(result.topic_title, query)}\n                          </h3>\n                        </div>\n\n                        {result.content_snippet && (\n                          <p className=\"text-sm text-gray-600 truncate mb-1\">\n                            {highlightMatch(result.content_snippet, query)}\n                          </p>\n                        )}\n\n                        <div className=\"flex items-center gap-3 text-muted-xs\">\n                          <span className=\"text-yellow-600 font-medium\">{result.category_name}</span>\n                          <span>{result.author_username}</span>\n                          <span className={result.result_type === 'topic' ? 'text-yellow-700' : 'text-blue-600'}>\n                            {result.result_type === 'topic' ? 'Aihe' : 'Viesti'}\n                          </span>\n                        </div>\n                      </div>\n\n                      <div className=\"meta-right-slot\">\n                        <p className=\"text-xs font-semibold text-gray-700\">\n                          {formatFinnishRelative(result.last_post_created_at || result.created_at)}\n                        </p>\n                      </div>\n                    </div>\n                  </Link>\n                ))}\n              </div>\n            ) : showsTagSection && visibleGroups.length === 0 && visibleTags.length === 0 && query ? (\n              <p className=\"state-empty-text\">\n                Ei osumia valitulle suodattimelle.\n              </p>\n            ) : null}\n          </div>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nexport default function SearchPage() {\n  return (\n    <Suspense fallback={\n      <div className=\"layout-page-shell\">\n        <Card>\n          <p className=\"state-empty-text\">Ladataan...</p>\n        </Card>\n      </div>\n    }>\n      <SearchContent />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/tags/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/topic/[id]/error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/app/topic/[id]/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/AdminActionError.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/AliasManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/EventsPanel.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":90,"column":41,"nodeType":null,"messageId":"refactorFunction","endLine":90,"endColumn":43},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 16. Maximum allowed is 12.","line":169,"column":31,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":169,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { Button } from '@/components/ui/button';\nimport { Alert } from '@/components/ui/Alert';\nimport { CalendarDays } from 'lucide-react';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { EventEditorModal } from '@/components/admin/events/EventEditorModal';\nimport { EventsTable } from '@/components/admin/events/EventsTable';\nimport { EMPTY_FORM, type EventFormState, type SiteEvent } from '@/components/admin/events/types';\n\nfunction formatEventDate(dateValue: string): string {\n  if (!dateValue) return '-';\n  const date = new Date(`${dateValue}T00:00:00`);\n  return new Intl.DateTimeFormat('fi-FI', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n  }).format(date);\n}\n\nfunction formatMidiName(fileName: string | null): string {\n  if (!fileName) return 'No midi file';\n  return fileName.replace(/\\.(mid|midi)$/i, '');\n}\n\nfunction formatDateCell(event: SiteEvent): string {\n  if (event.date_range_enabled && event.range_start_date && event.range_end_date) {\n    return `${formatEventDate(event.range_start_date)} - ${formatEventDate(event.range_end_date)}`;\n  }\n  return formatEventDate(event.event_date);\n}\n\nfunction formatDbError(error: unknown, fallback: string): string {\n  if (!error || typeof error !== 'object') return fallback;\n\n  const maybe = error as {\n    message?: string;\n    code?: string;\n    details?: string;\n    hint?: string;\n  };\n\n  if (maybe.code === '42P01') {\n    return 'Tietokantataulu `site_events` puuttuu. Aja migraatio `024_site_events.sql`.';\n  }\n\n  if (maybe.code === '42703') {\n    return 'Taulusta puuttuu uusia tapahtumakentti√§. Aja migraatiot `025_site_events_logo_toggle.sql` ja `026_site_events_date_range.sql`.';\n  }\n\n  if (maybe.code === '42501') {\n    return 'Ei oikeuksia tallentaa tapahtumaa (RLS/politiikka).';\n  }\n\n  if (maybe.code === '23502') {\n    return `Pakollinen kentt√§ puuttuu (${maybe.details || maybe.message || 'NOT NULL'}).`;\n  }\n\n  const extra = [maybe.details, maybe.hint].filter(Boolean).join(' ');\n  return [maybe.message || fallback, extra].filter(Boolean).join(' ');\n}\n\nexport function EventsPanel() {\n  const { supabase } = useAuth();\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n\n  const [events, setEvents] = useState<SiteEvent[]>([]);\n  const [midiSongs, setMidiSongs] = useState<string[]>([]);\n  const [logos, setLogos] = useState<string[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [deleting, setDeleting] = useState(false);\n  const [errorMessage, setErrorMessage] = useState('');\n  const [successMessage, setSuccessMessage] = useState('');\n\n  const [isModalOpen, setIsModalOpen] = useState(false);\n  const [editingEventId, setEditingEventId] = useState<number | null>(null);\n  const [formState, setFormState] = useState<EventFormState>(EMPTY_FORM);\n\n  const midiSet = useMemo(() => new Set(midiSongs), [midiSongs]);\n  const logoSet = useMemo(() => new Set(logos), [logos]);\n  const editingEvent = useMemo(\n    () => events.find((event) => event.id === editingEventId) ?? null,\n    [editingEventId, events]\n  );\n\n  const loadData = useCallback(async () => {\n    setLoading(true);\n    setErrorMessage('');\n    const [eventsRes, assetsRes] = await Promise.allSettled([\n      supabase\n        .from('site_events')\n        .select('id, name, event_date, repeats_yearly, date_range_enabled, range_start_date, range_end_date, music_enabled, music_file, logo_enabled, logo_file')\n        .order('event_date', { ascending: false })\n        .order('name', { ascending: true }),\n      fetch('/api/events/assets', { cache: 'no-store' }),\n    ]);\n\n    if (eventsRes.status === 'fulfilled') {\n      if (eventsRes.value.error) {\n        setEvents([]);\n        setErrorMessage(eventsRes.value.error.message || 'Tapahtumien lataus ep√§onnistui');\n      } else {\n        setEvents((eventsRes.value.data ?? []) as SiteEvent[]);\n      }\n    } else {\n      setEvents([]);\n      setErrorMessage(eventsRes.reason instanceof Error ? eventsRes.reason.message : 'Tapahtumien lataus ep√§onnistui');\n    }\n\n    if (assetsRes.status === 'fulfilled') {\n      if (assetsRes.value.ok) {\n        const assetsData = (await assetsRes.value.json()) as { midiSongs?: string[]; logos?: string[] };\n        setMidiSongs(Array.isArray(assetsData.midiSongs) ? assetsData.midiSongs : []);\n        setLogos(Array.isArray(assetsData.logos) ? assetsData.logos : []);\n      } else {\n        setMidiSongs([]);\n        setLogos([]);\n        setErrorMessage((prev) => prev || 'Tiedostolistojen haku ep√§onnistui.');\n      }\n    } else {\n      setMidiSongs([]);\n      setLogos([]);\n      setErrorMessage((prev) => prev || 'Tiedostolistojen haku ep√§onnistui.');\n    }\n\n    setLoading(false);\n  }, [supabase]);\n\n  useEffect(() => {\n    loadData();\n  }, [loadData]);\n\n  const openCreateModal = () => {\n    setEditingEventId(null);\n    setFormState(EMPTY_FORM);\n    setIsModalOpen(true);\n    setErrorMessage('');\n    setSuccessMessage('');\n  };\n\n  const openEditModal = (event: SiteEvent) => {\n    setEditingEventId(event.id);\n    setFormState({\n      name: event.name,\n      eventDate: event.event_date,\n      repeatsYearly: event.repeats_yearly !== false,\n      dateRangeEnabled: event.date_range_enabled,\n      rangeStartDate: event.range_start_date ?? '',\n      rangeEndDate: event.range_end_date ?? '',\n      musicEnabled: event.music_enabled,\n      musicFile: event.music_file ?? '',\n      logoEnabled: event.logo_enabled,\n      logoFile: event.logo_file ?? '',\n    });\n    setIsModalOpen(true);\n    setErrorMessage('');\n    setSuccessMessage('');\n  };\n\n  const closeModal = () => {\n    if (saving || deleting) return;\n    setIsModalOpen(false);\n  };\n\n  const handleSave = async () => {\n    const trimmedName = formState.name.trim();\n    if (!trimmedName) {\n      setErrorMessage('Tapahtuman nimi on pakollinen.');\n      return;\n    }\n    if (!formState.dateRangeEnabled && !formState.eventDate) {\n      setErrorMessage('P√§iv√§m√§√§r√§ on pakollinen.');\n      return;\n    }\n    if (formState.dateRangeEnabled && (!formState.rangeStartDate || !formState.rangeEndDate)) {\n      setErrorMessage('Valitse alku- ja loppup√§iv√§m√§√§r√§.');\n      return;\n    }\n\n    setSaving(true);\n    setErrorMessage('');\n    setSuccessMessage('');\n\n    const normalizedMusicFile = formState.musicFile.trim();\n    const normalizedLogoFile = formState.logoFile.trim();\n    const normalizedRangeStart = formState.rangeStartDate.trim();\n    const normalizedRangeEnd = formState.rangeEndDate.trim();\n    const effectiveEventDate = formState.dateRangeEnabled ? normalizedRangeStart : formState.eventDate;\n\n    const payload = {\n      name: trimmedName,\n      event_date: effectiveEventDate,\n      repeats_yearly: formState.repeatsYearly,\n      date_range_enabled: formState.dateRangeEnabled,\n      range_start_date: formState.dateRangeEnabled ? normalizedRangeStart : null,\n      range_end_date: formState.dateRangeEnabled ? normalizedRangeEnd : null,\n      music_enabled: formState.musicEnabled,\n      music_file: normalizedMusicFile || null,\n      logo_enabled: formState.logoEnabled,\n      logo_file: normalizedLogoFile || null,\n    };\n\n    try {\n      if (editingEventId === null) {\n        const { error } = await supabase.from('site_events').insert(payload);\n        if (error) throw error;\n        setSuccessMessage('Tapahtuma lis√§tty.');\n      } else {\n        const { error } = await supabase.from('site_events').update(payload).eq('id', editingEventId);\n        if (error) throw error;\n        setSuccessMessage('Tapahtuma p√§ivitetty.');\n      }\n\n      setIsModalOpen(false);\n      await loadData();\n    } catch (error: unknown) {\n      const message = formatDbError(error, 'Tallennus ep√§onnistui');\n      setErrorMessage(message);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleDelete = async () => {\n    if (!editingEventId) return;\n    const confirmed = window.confirm('Poistetaanko tapahtuma pysyv√§sti?');\n    if (!confirmed) return;\n\n    setDeleting(true);\n    setErrorMessage('');\n    setSuccessMessage('');\n\n    try {\n      const { error } = await supabase.from('site_events').delete().eq('id', editingEventId);\n      if (error) throw error;\n\n      setIsModalOpen(false);\n      setSuccessMessage('Tapahtuma poistettu.');\n      await loadData();\n    } catch (error: unknown) {\n      const message = formatDbError(error, 'Poisto ep√§onnistui');\n      setErrorMessage(message);\n    } finally {\n      setDeleting(false);\n    }\n  };\n\n  return (\n    <Card>\n      <div className=\"flex items-center justify-between gap-3 mb-4\">\n        <h2 className=\"card-title mb-0 flex items-center gap-2\">\n          {showHeaderIcons && <CalendarDays size={20} className=\"text-yellow-600\" />}\n          Tapahtumat\n        </h2>\n        <Button type=\"button\" variant=\"primary\" onClick={openCreateModal}>\n          Lis√§√§ tapahtuma\n        </Button>\n      </div>\n\n      {errorMessage && <Alert variant=\"error\">{errorMessage}</Alert>}\n      {successMessage && <Alert variant=\"success\">{successMessage}</Alert>}\n\n      {loading ? (\n        <p className=\"text-muted-sm\">Ladataan tapahtumia...</p>\n      ) : events.length === 0 ? (\n        <p className=\"text-muted-sm\">Ei tapahtumia viel√§.</p>\n      ) : (\n        <EventsTable\n          events={events}\n          midiSet={midiSet}\n          logoSet={logoSet}\n          onEdit={openEditModal}\n          formatDateCell={formatDateCell}\n          formatMidiName={formatMidiName}\n        />\n      )}\n      <EventEditorModal\n        isOpen={isModalOpen}\n        isEditing={editingEvent !== null}\n        errorMessage={errorMessage}\n        saving={saving}\n        deleting={deleting}\n        formState={formState}\n        setFormState={setFormState}\n        midiSongs={midiSongs}\n        logos={logos}\n        midiSet={midiSet}\n        logoSet={logoSet}\n        onClose={closeModal}\n        onSave={handleSave}\n        onDelete={handleDelete}\n      />\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/TagGroupsSection.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 19. Maximum allowed is 12.","line":201,"column":44,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":201,"endColumn":46},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (460). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":461,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\nimport { BarChart3 } from 'lucide-react';\nimport { Card } from '@/components/ui/Card';\nimport { Input } from '@/components/ui/Input';\nimport { Button } from '@/components/ui/button';\nimport { AddItemPanel } from '@/components/ui/AddItemPanel';\nimport { TokenInput, type TokenItem, type TokenOption } from '@/components/ui/TokenInput';\nimport { AliasManager } from '@/components/admin/AliasManager';\nimport { AdminActionError } from '@/components/admin/AdminActionError';\nimport type { AdminTagGroup, TagGroupAliasRow } from '@/components/admin/types';\n\ninterface TagGroupsSectionProps {\n  showHeaderIcons: boolean;\n  tagGroupActionError: string;\n  newGroupName: string;\n  newGroupSlug: string;\n  newGroupDescription: string;\n  newGroupSearchable: boolean;\n  newGroupKind: 'search' | 'arrangement' | 'both';\n  processingGroupId: number | null;\n  tagGroups: AdminTagGroup[];\n  groupTagQueryByGroupId: Record<number, string>;\n  tagGroupAliasesByGroupId: Record<number, TagGroupAliasRow[]>;\n  groupAliasInputByGroupId: Record<number, string>;\n  processingGroupAliasId: number | null;\n  addingAliasGroupId: number | null;\n  canonicalTagToToken: (tagId: number) => TokenItem | null;\n  buildGroupTagOptions: (group: AdminTagGroup) => TokenOption[];\n  onNewGroupNameChange: (value: string) => void;\n  onNewGroupSlugChange: (value: string) => void;\n  onNewGroupDescriptionChange: (value: string) => void;\n  onNewGroupSearchableChange: (value: boolean) => void;\n  onNewGroupKindChange: (value: 'search' | 'arrangement' | 'both') => void;\n  onCreateTagGroup: () => void;\n  onTagGroupsChange: (updater: (prev: AdminTagGroup[]) => AdminTagGroup[]) => void;\n  onGroupTagQueryChange: (groupId: number, value: string) => void;\n  onSaveTagGroup: (group: AdminTagGroup) => void;\n  onDeleteTagGroup: (groupId: number) => void;\n  onMoveArrangementGroup: (groupId: number, direction: 'up' | 'down') => void;\n  onGroupAliasInputChange: (groupId: number, value: string) => void;\n  onAddGroupAlias: (groupId: number, value: string) => void;\n  onDeleteGroupAlias: (aliasId: number) => void;\n}\n\nexport function TagGroupsSection({\n  showHeaderIcons,\n  tagGroupActionError,\n  newGroupName,\n  newGroupSlug,\n  newGroupDescription,\n  newGroupSearchable,\n  newGroupKind,\n  processingGroupId,\n  tagGroups,\n  groupTagQueryByGroupId,\n  tagGroupAliasesByGroupId,\n  groupAliasInputByGroupId,\n  processingGroupAliasId,\n  addingAliasGroupId,\n  canonicalTagToToken,\n  buildGroupTagOptions,\n  onNewGroupNameChange,\n  onNewGroupSlugChange,\n  onNewGroupDescriptionChange,\n  onNewGroupSearchableChange,\n  onNewGroupKindChange,\n  onCreateTagGroup,\n  onTagGroupsChange,\n  onGroupTagQueryChange,\n  onSaveTagGroup,\n  onDeleteTagGroup,\n  onMoveArrangementGroup,\n  onGroupAliasInputChange,\n  onAddGroupAlias,\n  onDeleteGroupAlias,\n}: TagGroupsSectionProps) {\n  const [editingGroupId, setEditingGroupId] = useState<number | null>(null);\n\n  const moveMemberTag = (\n    groupId: number,\n    tagId: number,\n    direction: 'up' | 'down'\n  ) => {\n    onTagGroupsChange((prev) =>\n      prev.map((entry) => {\n        if (entry.group_id !== groupId) return entry;\n        const currentIndex = entry.member_tag_ids.findIndex((id) => id === tagId);\n        if (currentIndex < 0) return entry;\n        const nextIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;\n        if (nextIndex < 0 || nextIndex >= entry.member_tag_ids.length) return entry;\n        const nextMemberIds = [...entry.member_tag_ids];\n        const [moved] = nextMemberIds.splice(currentIndex, 1);\n        nextMemberIds.splice(nextIndex, 0, moved);\n        return { ...entry, member_tag_ids: nextMemberIds };\n      })\n    );\n  };\n\n  const formatGroupKind = (groupKind: 'search' | 'arrangement' | 'both') => {\n    if (groupKind === 'search') return 'vain haku';\n    if (groupKind === 'arrangement') return 'vain j√§rjestely';\n    return 'haku + j√§rjestely';\n  };\n\n  const searchOnlyGroups = tagGroups\n    .filter((group) => group.group_kind === 'search')\n    .sort((a, b) => a.group_name.localeCompare(b.group_name, 'fi'));\n\n  const arrangementGroups = tagGroups\n    .filter((group) => group.group_kind === 'arrangement' || group.group_kind === 'both')\n    .sort((a, b) => a.arrangement_order - b.arrangement_order || a.group_name.localeCompare(b.group_name, 'fi'));\n\n  return (\n    <Card>\n      <h2 className=\"card-title flex items-center gap-2\">\n        {showHeaderIcons && <BarChart3 size={20} className=\"text-yellow-600\" />}\n        Tagiryhm√§t\n      </h2>\n      <p className=\"text-sm text-gray-600 mb-4\">\n        Ryhm√§t auttavat selaamaan tageja (esim. 8-bit, 16-bit), mutta ryhmi√§ ei voi valita keskustelun tageiksi.\n      </p>\n      <p className=\"text-muted-xs mb-4\">\n        Sama tagi voi kuulua useaan ryhm√§√§n. Ryhm√§n nimi ei voi olla sama kuin olemassa olevan tagin nimi.\n      </p>\n      <AdminActionError message={tagGroupActionError} className=\"mb-4\" />\n\n      <div className=\"mb-4\">\n        <AddItemPanel\n          triggerLabel=\"Lis√§√§ tagiryhm√§\"\n          title=\"Luo uusi ryhm√§\"\n          disableClose={processingGroupId === -1}\n          onCancel={() => {\n            onNewGroupNameChange('');\n            onNewGroupSlugChange('');\n            onNewGroupDescriptionChange('');\n            onNewGroupSearchableChange(true);\n            onNewGroupKindChange('both');\n          }}\n        >\n            <div className=\"grid gap-2 md:grid-cols-2\">\n              <Input\n                value={newGroupName}\n                onChange={(e) => onNewGroupNameChange(e.target.value)}\n                placeholder=\"Ryhm√§n nimi (esim. 8-bit)\"\n              />\n              <Input\n                value={newGroupSlug}\n                onChange={(e) => onNewGroupSlugChange(e.target.value)}\n                placeholder=\"ryhman-slug (valinnainen)\"\n              />\n            </div>\n            <Input\n              value={newGroupDescription}\n              onChange={(e) => onNewGroupDescriptionChange(e.target.value)}\n              placeholder=\"Kuvaus (valinnainen)\"\n            />\n            <label className=\"inline-flex items-center gap-2 text-sm text-gray-700\">\n              <input\n                type=\"checkbox\"\n                checked={newGroupSearchable}\n                onChange={(e) => onNewGroupSearchableChange(e.target.checked)}\n              />\n              N√§yt√§ ryhm√§ hakutuloksissa\n            </label>\n            <label className=\"block text-sm text-gray-700\">\n              Ryhm√§n k√§ytt√∂\n              <select\n                value={newGroupKind}\n                onChange={(e) => onNewGroupKindChange(e.target.value as 'search' | 'arrangement' | 'both')}\n                className=\"mt-1 w-full max-w-xs rounded-lg border-2 border-gray-300 bg-white px-2 py-1 text-sm focus:border-yellow-400 focus:outline-none\"\n              >\n                <option value=\"both\">Haku + j√§rjestely</option>\n                <option value=\"search\">Vain haku</option>\n                <option value=\"arrangement\">Vain j√§rjestely</option>\n              </select>\n            </label>\n            <Button\n              type=\"button\"\n              onClick={onCreateTagGroup}\n              disabled={processingGroupId === -1 || !newGroupName.trim()}\n            >\n              {processingGroupId === -1 ? 'Luodaan...' : 'Luo ryhm√§'}\n            </Button>\n        </AddItemPanel>\n      </div>\n\n      {tagGroups.length === 0 ? (\n        <p className=\"text-muted-sm\">Ei ryhmi√§ viel√§.</p>\n      ) : (\n        <div className=\"space-y-8\">\n          {[\n            { key: 'arrangement', title: 'Haku ja j√§rjestely', groups: arrangementGroups },\n            { key: 'search-only', title: 'Vain haku', groups: searchOnlyGroups },\n\n          ].map((section) => (\n            <div key={section.key} className=\"space-y-2\">\n              <h3 className=\"text-sm font-semibold text-gray-800\">{section.title}</h3>\n              {section.groups.length === 0 ? (\n                <p className=\"text-muted-xs\">Ei ryhmi√§ t√§ss√§ osiossa.</p>\n              ) : (\n                section.groups.map((group) => {\n                  const aliases = tagGroupAliasesByGroupId[group.group_id] || [];\n                  const isEditing = editingGroupId === group.group_id;\n                  const arrangementIndex = arrangementGroups.findIndex((entry) => entry.group_id === group.group_id);\n\n                  return (\n                    <div key={group.group_id} className=\"rounded border border-gray-200 bg-white p-3\">\n                      <div className=\"flex items-start justify-between gap-3\">\n                        <div className=\"min-w-0 space-y-1\">\n                          <p className=\"font-medium truncate\">{group.group_name}</p>\n                          <p className=\"text-muted-xs truncate\">\n                            Slug: {group.group_slug}\n                            {' ‚Ä¢ '}K√§ytt√∂: {formatGroupKind(group.group_kind)}\n                            {(group.group_kind === 'arrangement' || group.group_kind === 'both') ? ` ‚Ä¢ j√§rjestys: ${group.arrangement_order}` : ''}\n                            {' ‚Ä¢ '}Haku: {group.searchable ? 'kyll√§' : 'ei'}\n                            {' ‚Ä¢ '}Tageja: {group.member_count}\n                            {' ‚Ä¢ '}Aliakset: {aliases.length > 0 ? aliases.map((alias) => alias.alias).join(', ') : 'ei'}\n                          </p>\n                        </div>\n                        {!isEditing && (\n                          <div className=\"flex items-center gap-2\">\n                            {(group.group_kind === 'arrangement' || group.group_kind === 'both') && (\n                              <>\n                                <button\n                                  type=\"button\"\n                                  className=\"admin-compact-btn bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50\"\n                                  disabled={arrangementIndex <= 0 || processingGroupId === group.group_id}\n                                  onClick={() => onMoveArrangementGroup(group.group_id, 'up')}\n                                  title=\"Siirr√§ yl√∂sp√§in\"\n                                >\n                                  ‚Üë\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  className=\"admin-compact-btn bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50\"\n                                  disabled={arrangementIndex < 0 || arrangementIndex >= arrangementGroups.length - 1 || processingGroupId === group.group_id}\n                                  onClick={() => onMoveArrangementGroup(group.group_id, 'down')}\n                                  title=\"Siirr√§ alasp√§in\"\n                                >\n                                  ‚Üì\n                                </button>\n                              </>\n                            )}\n                            <button\n                              type=\"button\"\n                              className=\"admin-compact-btn inline-flex items-center gap-1 bg-gray-200 text-gray-700 hover:bg-gray-300\"\n                              onClick={() => setEditingGroupId(group.group_id)}\n                            >\n                              Muokkaa\n                            </button>\n                          </div>\n                        )}\n                      </div>\n\n                      {isEditing && (\n                        <div className=\"mt-3 space-y-2 border-t border-gray-100 pt-3\">\n                    <div className=\"grid gap-2 md:grid-cols-2\">\n                      <Input\n                        value={group.group_name}\n                        onChange={(e) =>\n                          onTagGroupsChange((prev) =>\n                            prev.map((entry) =>\n                              entry.group_id === group.group_id ? { ...entry, group_name: e.target.value } : entry\n                            )\n                          )\n                        }\n                        placeholder=\"Ryhm√§n nimi\"\n                      />\n                      <Input\n                        value={group.group_slug}\n                        onChange={(e) =>\n                          onTagGroupsChange((prev) =>\n                            prev.map((entry) =>\n                              entry.group_id === group.group_id ? { ...entry, group_slug: e.target.value } : entry\n                            )\n                          )\n                        }\n                        placeholder=\"Ryhm√§n slug\"\n                      />\n                    </div>\n                    <Input\n                      value={group.description || ''}\n                      onChange={(e) =>\n                        onTagGroupsChange((prev) =>\n                          prev.map((entry) =>\n                            entry.group_id === group.group_id ? { ...entry, description: e.target.value } : entry\n                          )\n                        )\n                      }\n                      placeholder=\"Kuvaus\"\n                    />\n                    <div className=\"flex flex-wrap items-center gap-3 text-sm text-gray-700\">\n                      <label className=\"inline-flex items-center gap-2\">\n                        <input\n                          type=\"checkbox\"\n                          checked={group.searchable}\n                          onChange={(e) =>\n                            onTagGroupsChange((prev) =>\n                              prev.map((entry) =>\n                                entry.group_id === group.group_id ? { ...entry, searchable: e.target.checked } : entry\n                              )\n                            )\n                          }\n                        />\n                        Hakukelpoinen\n                      </label>\n                      <label className=\"inline-flex items-center gap-2\">\n                        <span className=\"text-xs text-gray-600\">K√§ytt√∂</span>\n                        <select\n                          value={group.group_kind}\n                          onChange={(e) =>\n                            onTagGroupsChange((prev) =>\n                              prev.map((entry) =>\n                                entry.group_id === group.group_id\n                                  ? { ...entry, group_kind: e.target.value as 'search' | 'arrangement' | 'both' }\n                                  : entry\n                              )\n                            )\n                          }\n                          className=\"rounded-lg border-2 border-gray-300 bg-white px-2 py-1 text-xs focus:border-yellow-400 focus:outline-none\"\n                        >\n                          <option value=\"both\">Haku + j√§rjestely</option>\n                          <option value=\"search\">Vain haku</option>\n                          <option value=\"arrangement\">Vain j√§rjestely</option>\n                        </select>\n                      </label>\n                    </div>\n                    <TokenInput\n                      label=\"Ryhm√§n tagit\"\n                      placeholder=\"Hae ja lis√§√§ tageja...\"\n                      tokens={group.member_tag_ids\n                        .map(canonicalTagToToken)\n                        .filter((token): token is TokenItem => token !== null)}\n                      query={groupTagQueryByGroupId[group.group_id] || ''}\n                      onQueryChange={(value) => onGroupTagQueryChange(group.group_id, value)}\n                      options={buildGroupTagOptions(group)}\n                      onSelectOption={(option) => {\n                        const tagId = Number(option.id);\n                        if (!Number.isFinite(tagId) || tagId <= 0) return;\n                        onTagGroupsChange((prev) =>\n                          prev.map((entry) =>\n                            entry.group_id === group.group_id && !entry.member_tag_ids.includes(tagId)\n                              ? { ...entry, member_tag_ids: [...entry.member_tag_ids, tagId] }\n                              : entry\n                          )\n                        );\n                        onGroupTagQueryChange(group.group_id, '');\n                      }}\n                      onRemoveToken={(id) => {\n                        const tagId = Number(id);\n                        if (!Number.isFinite(tagId) || tagId <= 0) return;\n                        onTagGroupsChange((prev) =>\n                          prev.map((entry) =>\n                            entry.group_id === group.group_id\n                              ? { ...entry, member_tag_ids: entry.member_tag_ids.filter((entryId) => entryId !== tagId) }\n                              : entry\n                          )\n                        );\n                      }}\n                      emptyMessage=\"Ei osumia\"\n                      disabled={processingGroupId === group.group_id}\n                    />\n                    {group.member_tag_ids.length > 0 && (\n                      <div className=\"space-y-1\">\n                        <p className=\"text-muted-xs\">Tagien j√§rjestys haussa</p>\n                        <div className=\"space-y-1\">\n                          {group.member_tag_ids.map((tagId, index) => {\n                            const token = canonicalTagToToken(tagId);\n                            const label = token?.label || `#${tagId}`;\n                            return (\n                              <div\n                                key={`${group.group_id}-${tagId}`}\n                                className=\"flex items-center justify-between rounded border border-gray-200 bg-gray-50 px-2 py-1 text-sm\"\n                              >\n                                <span className=\"truncate\">{label}</span>\n                                <div className=\"flex items-center gap-1\">\n                                  <button\n                                    type=\"button\"\n                                    className=\"admin-compact-btn bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50\"\n                                    disabled={index === 0 || processingGroupId === group.group_id}\n                                    onClick={() => moveMemberTag(group.group_id, tagId, 'up')}\n                                    title=\"Siirr√§ yl√∂sp√§in\"\n                                  >\n                                    ‚Üë\n                                  </button>\n                                  <button\n                                    type=\"button\"\n                                    className=\"admin-compact-btn bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50\"\n                                    disabled={index === group.member_tag_ids.length - 1 || processingGroupId === group.group_id}\n                                    onClick={() => moveMemberTag(group.group_id, tagId, 'down')}\n                                    title=\"Siirr√§ alasp√§in\"\n                                  >\n                                    ‚Üì\n                                  </button>\n                                </div>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      </div>\n                    )}\n                    <AliasManager\n                      label=\"Ryhm√§n aliakset\"\n                      placeholder=\"Lis√§√§ ryhm√§alias...\"\n                      aliases={aliases.map((aliasRow) => ({\n                        id: aliasRow.alias_id,\n                        label: aliasRow.alias,\n                      }))}\n                      query={groupAliasInputByGroupId[group.group_id] || ''}\n                      onQueryChange={(value) => onGroupAliasInputChange(group.group_id, value)}\n                      onAddAlias={(value) => onAddGroupAlias(group.group_id, value)}\n                      onDeleteAlias={(id) => {\n                        const aliasId = Number(id);\n                        if (!Number.isFinite(aliasId) || aliasId <= 0) return;\n                        onDeleteGroupAlias(aliasId);\n                      }}\n                      disabled={processingGroupAliasId !== null || addingAliasGroupId === group.group_id}\n                    />\n                    <div className=\"flex items-center gap-2\">\n                      <button\n                        type=\"button\"\n                        className=\"admin-compact-btn inline-flex items-center gap-1 bg-green-600 text-white hover:bg-green-700 disabled:opacity-50\"\n                        disabled={processingGroupId === group.group_id || !group.group_name.trim()}\n                        onClick={() => {\n                          onSaveTagGroup(group);\n                          setEditingGroupId(null);\n                        }}\n                      >\n                        Tallenna\n                      </button>\n                      <button\n                        type=\"button\"\n                        className=\"admin-compact-btn inline-flex items-center gap-1 bg-gray-200 text-gray-700 hover:bg-gray-300\"\n                        disabled={processingGroupId === group.group_id}\n                        onClick={() => setEditingGroupId(null)}\n                      >\n                        Peruuta\n                      </button>\n                      <button\n                        type=\"button\"\n                        className=\"admin-compact-btn inline-flex items-center gap-1 bg-red-600 text-white hover:bg-red-700 disabled:opacity-50\"\n                        disabled={processingGroupId === group.group_id}\n                        onClick={() => onDeleteTagGroup(group.group_id)}\n                      >\n                        Poista ryhm√§\n                      </button>\n                    </div>\n                        </div>\n                      )}\n                    </div>\n                  );\n                })\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/TagsSection.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":96,"column":7,"nodeType":"JSXOpeningElement","endLine":100,"endColumn":9},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 13. Maximum allowed is 12.","line":244,"column":24,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":244,"endColumn":26},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (454). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":455,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Check, Star, Tags as TagsIcon, X } from 'lucide-react';\nimport { useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { Input } from '@/components/ui/Input';\nimport { Button } from '@/components/ui/button';\nimport { AddItemPanel } from '@/components/ui/AddItemPanel';\nimport { AdminActionError } from '@/components/admin/AdminActionError';\nimport { AliasManager } from '@/components/admin/AliasManager';\nimport type { AdminTagGroup, CanonicalTagOption, TagAliasRow, TagModerationAction, UnreviewedTag } from '@/components/admin/types';\n\ninterface TagsSectionProps {\n  showHeaderIcons: boolean;\n  unreviewedTags: UnreviewedTag[];\n  canonicalTags: CanonicalTagOption[];\n  tagGroups: AdminTagGroup[];\n  newTagName: string;\n  newTagSlug: string;\n  creatingTag: boolean;\n  mergeTargetByTagId: Record<number, number | ''>;\n  processingTagId: number | null;\n  tagActionError: string;\n  aliasSearch: string;\n  editingTagId: number | null;\n  editingTagName: string;\n  editingTagSlug: string;\n  editingTagGroupIds: number[];\n  deleteReplacementTagId: number | '';\n  aliasInputByTagId: Record<number, string>;\n  tagAliasesByTagId: Record<number, TagAliasRow[]>;\n  addingAliasTagId: number | null;\n  processingAliasId: number | null;\n  onModerateTag: (tagId: number, action: TagModerationAction) => void;\n  onMergeTargetChange: (tagId: number, target: number | '') => void;\n  onMergeTag: (sourceTagId: number) => void;\n  onNewTagNameChange: (value: string) => void;\n  onNewTagSlugChange: (value: string) => void;\n  onCreateTag: () => void;\n  onAliasSearchChange: (value: string) => void;\n  onBeginRenameTag: (tag: CanonicalTagOption) => void;\n  onCancelRenameTag: () => void;\n  onEditingTagNameChange: (value: string) => void;\n  onEditingTagSlugChange: (value: string) => void;\n  onEditingTagGroupIdsChange: (next: number[]) => void;\n  onDeleteReplacementTagIdChange: (next: number | '') => void;\n  onSaveTagCard: (tagId: number) => void;\n  onAliasInputChange: (tagId: number, value: string) => void;\n  onAddAlias: (tagId: number, value: string) => void;\n  onDeleteAlias: (aliasId: number) => void;\n  onDeleteTag: (tag: CanonicalTagOption, replacementTagId: number | '') => void;\n}\n\nexport function TagsSection({\n  showHeaderIcons,\n  unreviewedTags,\n  canonicalTags,\n  tagGroups,\n  newTagName,\n  newTagSlug,\n  creatingTag,\n  mergeTargetByTagId,\n  processingTagId,\n  tagActionError,\n  aliasSearch,\n  editingTagId,\n  editingTagName,\n  editingTagSlug,\n  editingTagGroupIds,\n  deleteReplacementTagId,\n  aliasInputByTagId,\n  tagAliasesByTagId,\n  addingAliasTagId,\n  processingAliasId,\n  onModerateTag,\n  onMergeTargetChange,\n  onMergeTag,\n  onNewTagNameChange,\n  onNewTagSlugChange,\n  onCreateTag,\n  onAliasSearchChange,\n  onBeginRenameTag,\n  onCancelRenameTag,\n  onEditingTagNameChange,\n  onEditingTagSlugChange,\n  onEditingTagGroupIdsChange,\n  onDeleteReplacementTagIdChange,\n  onSaveTagCard,\n  onAliasInputChange,\n  onAddAlias,\n  onDeleteAlias,\n  onDeleteTag,\n}: TagsSectionProps) {\n  const [pendingDeleteTagId, setPendingDeleteTagId] = useState<number | null>(null);\n\n  const renderLegacyIcon = (path: string | null, alt: string) => (\n    path ? (\n      <img\n        src={path}\n        alt={alt}\n        className=\"h-4 w-4 flex-shrink-0 object-contain\"\n      />\n    ) : (\n      <span className=\"inline-flex h-4 w-4 items-center justify-center text-xs leading-none\">üè∑Ô∏è</span>\n    )\n  );\n\n  const toggleGroupMembership = (groupId: number) => {\n    if (editingTagGroupIds.includes(groupId)) {\n      onEditingTagGroupIdsChange(editingTagGroupIds.filter((id) => id !== groupId));\n      return;\n    }\n    onEditingTagGroupIdsChange([...editingTagGroupIds, groupId]);\n  };\n\n  return (\n    <Card>\n      <h2 className=\"card-title flex items-center gap-2\">\n        {showHeaderIcons && <TagsIcon size={20} className=\"text-yellow-600\" />}\n        Tagit\n      </h2>\n      <div className=\"mb-3 space-y-2 text-sm text-gray-600\">\n        <p>\n          Tagit kuvaavat keskustelun aihetta. Uudet keskustelut ovat tagipohjaisia, ja jokaisella keskustelulla on yksi p√§√§tagi.\n        </p>\n      </div>\n\n      {unreviewedTags.length > 0 && (\n        <div className=\"space-y-2\">\n          {unreviewedTags.map((tag) => (\n            <div key={tag.id} className=\"list-row-card\">\n              <div className=\"min-w-0\">\n                <p className=\"font-medium truncate\">{tag.name}</p>\n                <p className=\"text-muted-xs truncate\">\n                  {tag.slug} ‚Ä¢ {tag.usage_count} k√§ytt√∂√§ ‚Ä¢ {new Date(tag.created_at).toLocaleString('fi-FI')}\n                </p>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <button\n                  type=\"button\"\n                  disabled={processingTagId === tag.id}\n                  onClick={() => onModerateTag(tag.id, 'approve')}\n                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-green-600 text-white hover:bg-green-700 disabled:opacity-50\"\n                >\n                  <Check size={14} />\n                  Approve\n                </button>\n                <button\n                  type=\"button\"\n                  disabled={processingTagId === tag.id}\n                  onClick={() => onModerateTag(tag.id, 'feature')}\n                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-yellow-500 text-white hover:bg-yellow-600 disabled:opacity-50\"\n                >\n                  <Star size={14} />\n                  Feature\n                </button>\n                <button\n                  type=\"button\"\n                  disabled={processingTagId === tag.id}\n                  onClick={() => onModerateTag(tag.id, 'hide')}\n                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-gray-700 text-white hover:bg-gray-800 disabled:opacity-50\"\n                >\n                  <X size={14} />\n                  Hide\n                </button>\n                <select\n                  value={mergeTargetByTagId[tag.id] ?? ''}\n                  onChange={(e) => onMergeTargetChange(tag.id, e.target.value ? Number(e.target.value) : '')}\n                  className=\"max-w-48 rounded-lg border-2 border-gray-300 bg-white px-2 py-1 text-xs focus:border-yellow-400 focus:outline-none\"\n                  disabled={processingTagId === tag.id}\n                >\n                  <option value=\"\">Merge target...</option>\n                  {canonicalTags\n                    .filter((candidate) => candidate.id !== tag.id)\n                    .map((candidate) => (\n                      <option key={candidate.id} value={candidate.id}>\n                        {candidate.name}\n                      </option>\n                    ))}\n                </select>\n                <button\n                  type=\"button\"\n                  disabled={processingTagId === tag.id || !mergeTargetByTagId[tag.id]}\n                  onClick={() => onMergeTag(tag.id)}\n                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50\"\n                >\n                  Merge\n                </button>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      <div className=\"mt-6 border-t border-gray-200 pt-4\">\n        <h3 className=\"font-semibold text-gray-800 mb-2\">Kanoniset tagit ja aliakset</h3>\n        <p className=\"text-muted-xs mb-3\">\n          Aliakset toimivat hakusynonyymein√§ (esim. &quot;pleikka&quot; -&gt; PlayStation 5). Merge siirt√§√§ aliakset my√∂s kohdetagille.\n        </p>\n        <AdminActionError message={tagActionError} className=\"mb-3\" />\n        <div className=\"mb-3\">\n          <AddItemPanel\n            triggerLabel=\"Lis√§√§ tagi\"\n            title=\"Lis√§√§ uusi tagi\"\n            disableClose={creatingTag}\n            onCancel={() => {\n              onNewTagNameChange('');\n              onNewTagSlugChange('');\n            }}\n          >\n            <div className=\"grid gap-2 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto]\">\n              <Input\n                value={newTagName}\n                onChange={(e) => onNewTagNameChange(e.target.value)}\n                placeholder=\"Tagin nimi\"\n              />\n              <Input\n                value={newTagSlug}\n                onChange={(e) => onNewTagSlugChange(e.target.value)}\n                placeholder=\"Slug (valinnainen)\"\n              />\n              <Button\n                type=\"button\"\n                onClick={onCreateTag}\n                disabled={creatingTag || !newTagName.trim()}\n              >\n                {creatingTag ? 'Luodaan...' : 'Lis√§√§ tagi'}\n              </Button>\n            </div>\n          </AddItemPanel>\n        </div>\n        <div className=\"mb-3\">\n          <Input\n            value={aliasSearch}\n            onChange={(e) => onAliasSearchChange(e.target.value)}\n            placeholder=\"Suodata tageja nimell√§ tai slugilla...\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          {canonicalTags\n            .filter((tag) => {\n              const q = aliasSearch.trim().toLowerCase();\n              if (!q) return true;\n              return tag.name.toLowerCase().includes(q) || tag.slug.toLowerCase().includes(q);\n            })\n            .map((tag) => {\n              const aliases = tagAliasesByTagId[tag.id] || [];\n              const groupsForTag = tagGroups.filter((group) => group.member_tag_ids.includes(tag.id));\n              const isEditing = editingTagId === tag.id;\n              const isInUse = tag.usage_count > 0;\n              const showDeleteControls = pendingDeleteTagId === tag.id;\n              return (\n                <div key={tag.id} className=\"rounded border border-gray-200 bg-white px-3 py-3\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"min-w-0 space-y-1\">\n                      <p className=\"font-medium truncate inline-flex items-center gap-1.5\">\n                        {renderLegacyIcon(tag.legacy_icon_path, `${tag.name} legacy icon`)}\n                        <span>{tag.name}</span>\n                      </p>\n                      <p className=\"text-muted-xs truncate\">\n                        Slug: {tag.slug} ‚Ä¢ K√§yt√∂ss√§: {tag.usage_count} ketjussa ‚Ä¢ aliakset:{' '}\n                        {aliases.length > 0 ? aliases.map((a) => a.alias).join(', ') : 'ei'} ‚Ä¢ Ryhmiss√§:{' '}\n                        {groupsForTag.length > 0 ? groupsForTag.map((g) => g.group_name).join(', ') : 'ei'}\n                      </p>\n                    </div>\n                    {!isEditing && (\n                      <button\n                        type=\"button\"\n                        className=\"admin-compact-btn inline-flex items-center gap-1 bg-gray-200 text-gray-700 hover:bg-gray-300\"\n                        onClick={() => onBeginRenameTag(tag)}\n                      >\n                        Muokkaa\n                      </button>\n                    )}\n                  </div>\n\n                  {isEditing && (\n                    <div className=\"mt-3 space-y-3 border-t border-gray-100 pt-3\">\n                      <div className=\"inline-flex items-center gap-1.5 rounded border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-gray-600\">\n                        {renderLegacyIcon(tag.legacy_icon_path, `${tag.name} legacy icon`)}\n                        <span>Legacy-kuvake</span>\n                      </div>\n\n                      <div className=\"flex flex-wrap items-end gap-2\">\n                        <label className=\"block w-full max-w-xs text-xs text-gray-600\">\n                          <span className=\"inline-flex items-center gap-1.5\">\n                            {renderLegacyIcon(tag.legacy_icon_path, `${tag.name} legacy icon`)}\n                            <span>Tagin nimi</span>\n                          </span>\n                          <input\n                            value={editingTagName}\n                            onChange={(e) => onEditingTagNameChange(e.target.value)}\n                            className=\"mt-1 w-full rounded-lg border-2 border-gray-300 bg-white px-2 py-1 text-sm focus:border-yellow-400 focus:outline-none\"\n                            placeholder=\"Esim. PlayStation 5\"\n                          />\n                        </label>\n                        <label className=\"block w-full max-w-xs text-xs text-gray-600\">\n                          Slug\n                          <input\n                            value={editingTagSlug}\n                            onChange={(e) => onEditingTagSlugChange(e.target.value)}\n                            className=\"mt-1 w-full rounded-lg border-2 border-gray-300 bg-white px-2 py-1 text-sm font-mono focus:border-yellow-400 focus:outline-none\"\n                            placeholder=\"esim-playstation-5\"\n                          />\n                        </label>\n                      </div>\n\n                      <AliasManager\n                        label=\"Tagin aliakset\"\n                        placeholder=\"Lis√§√§ alias...\"\n                        aliases={aliases.map((aliasRow) => ({ id: aliasRow.alias_id, label: aliasRow.alias }))}\n                        query={aliasInputByTagId[tag.id] || ''}\n                        onQueryChange={(value) => onAliasInputChange(tag.id, value)}\n                        onAddAlias={(value) => onAddAlias(tag.id, value)}\n                        onDeleteAlias={(id) => {\n                          const aliasId = Number(id);\n                          if (!Number.isFinite(aliasId) || aliasId <= 0) return;\n                          onDeleteAlias(aliasId);\n                        }}\n                        disabled={addingAliasTagId === tag.id || processingAliasId !== null}\n                      />\n\n                      <div>\n                        <p className=\"mb-1 text-xs font-semibold text-gray-600\">Tagiryhm√§t</p>\n                        <div className=\"flex flex-wrap gap-2\">\n                          {tagGroups.map((group) => {\n                            const checked = editingTagGroupIds.includes(group.group_id);\n                            return (\n                              <label key={group.group_id} className=\"inline-flex items-center gap-1 rounded border border-gray-200 px-2 py-1 text-xs\">\n                                <input\n                                  type=\"checkbox\"\n                                  checked={checked}\n                                  onChange={() => toggleGroupMembership(group.group_id)}\n                                />\n                                <span>{group.group_name}</span>\n                              </label>\n                            );\n                          })}\n                        </div>\n                      </div>\n\n                      <div className=\"flex flex-wrap items-center gap-2\">\n                        <button\n                          type=\"button\"\n                          className=\"admin-compact-btn inline-flex items-center gap-1 bg-green-600 text-white hover:bg-green-700 disabled:opacity-50\"\n                          disabled={processingTagId === tag.id || !editingTagName.trim()}\n                          onClick={() => onSaveTagCard(tag.id)}\n                        >\n                          Tallenna\n                        </button>\n                        <button\n                          type=\"button\"\n                          className=\"admin-compact-btn inline-flex items-center gap-1 bg-gray-200 text-gray-700 hover:bg-gray-300\"\n                          onClick={onCancelRenameTag}\n                          disabled={processingTagId === tag.id}\n                        >\n                          Peruuta\n                        </button>\n                        <button\n                          type=\"button\"\n                          className={`${isInUse ? 'bg-orange-600 hover:bg-orange-700' : 'bg-red-600 hover:bg-red-700'} admin-compact-btn inline-flex items-center gap-1 text-white disabled:opacity-50`}\n                          disabled={processingTagId === tag.id}\n                          onClick={() => {\n                            setPendingDeleteTagId(tag.id);\n                            if (!isInUse) {\n                              onDeleteReplacementTagIdChange('');\n                            }\n                          }}\n                        >\n                          {isInUse ? 'Yhdist√§' : 'Poista'}\n                        </button>\n                      </div>\n                      {showDeleteControls && (\n                        <div className=\"rounded border border-orange-200 bg-orange-50 p-2\">\n                          {isInUse ? (\n                            <div className=\"space-y-2\">\n                              <p className=\"text-xs font-semibold text-orange-800\">\n                                Valitse kohdetagi. T√§m√§ tagi yhdistet√§√§n siihen ja poistetaan.\n                              </p>\n                              <select\n                                value={deleteReplacementTagId}\n                                onChange={(e) => onDeleteReplacementTagIdChange(e.target.value ? Number(e.target.value) : '')}\n                                className=\"max-w-72 rounded-lg border-2 border-gray-300 bg-white px-2 py-1 text-sm focus:border-yellow-400 focus:outline-none\"\n                              >\n                                <option value=\"\">K√§yt√§ off-topic tagia</option>\n                                {canonicalTags\n                                  .filter((candidate) => candidate.id !== tag.id)\n                                  .map((candidate) => (\n                                    <option key={candidate.id} value={candidate.id}>\n                                      {candidate.name}\n                                    </option>\n                                  ))}\n                              </select>\n                              <div className=\"flex flex-wrap items-center gap-2\">\n                                <button\n                                  type=\"button\"\n                                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-orange-600 text-white hover:bg-orange-700 disabled:opacity-50\"\n                                  disabled={processingTagId === tag.id}\n                                  onClick={() => {\n                                    onDeleteTag(tag, deleteReplacementTagId);\n                                    setPendingDeleteTagId(null);\n                                  }}\n                                >\n                                  Yhdist√§\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-gray-200 text-gray-700 hover:bg-gray-300\"\n                                  disabled={processingTagId === tag.id}\n                                  onClick={() => setPendingDeleteTagId(null)}\n                                >\n                                  Peruuta\n                                </button>\n                              </div>\n                            </div>\n                          ) : (\n                            <div className=\"space-y-2\">\n                              <p className=\"text-xs font-semibold text-red-700\">\n                                Tagi ei ole k√§yt√∂ss√§ viesteiss√§. Voit poistaa sen pysyv√§sti.\n                              </p>\n                              <div className=\"flex flex-wrap items-center gap-2\">\n                                <button\n                                  type=\"button\"\n                                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-red-600 text-white hover:bg-red-700 disabled:opacity-50\"\n                                  disabled={processingTagId === tag.id}\n                                  onClick={() => {\n                                    onDeleteTag(tag, '');\n                                    setPendingDeleteTagId(null);\n                                  }}\n                                >\n                                  Poista tagi\n                                </button>\n                                <button\n                                  type=\"button\"\n                                  className=\"admin-compact-btn inline-flex items-center gap-1 bg-gray-200 text-gray-700 hover:bg-gray-300\"\n                                  disabled={processingTagId === tag.id}\n                                  onClick={() => setPendingDeleteTagId(null)}\n                                >\n                                  Peruuta\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      )}\n                      <p className=\"text-muted-xs\">Vanha nimi/slug lis√§t√§√§n automaattisesti aliakseksi.</p>\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n        </div>\n      </div>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/UsersSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/events/EventEditorModal.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'EventEditorModal' has a complexity of 22. Maximum allowed is 12.","line":60,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":60,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Dispatch, SetStateAction } from 'react';\nimport { Image as ImageIcon, Music2 } from 'lucide-react';\nimport { Alert } from '@/components/ui/Alert';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/Input';\nimport type { EventFormState } from '@/components/admin/events/types';\n\ninterface EventEditorModalProps {\n  isOpen: boolean;\n  isEditing: boolean;\n  errorMessage: string;\n  saving: boolean;\n  deleting: boolean;\n  formState: EventFormState;\n  setFormState: Dispatch<SetStateAction<EventFormState>>;\n  midiSongs: string[];\n  logos: string[];\n  midiSet: Set<string>;\n  logoSet: Set<string>;\n  onClose: () => void;\n  onSave: () => void;\n  onDelete: () => void;\n}\n\nfunction ToggleSwitch({\n  checked,\n  onClick,\n  disabled,\n  id,\n  label,\n}: {\n  checked: boolean;\n  onClick: () => void;\n  disabled: boolean;\n  id: string;\n  label: string;\n}) {\n  return (\n    <button\n      id={id}\n      type=\"button\"\n      role=\"switch\"\n      aria-checked={checked}\n      aria-label={label}\n      disabled={disabled}\n      onClick={onClick}\n      className={`relative inline-flex h-7 w-12 items-center rounded-full transition ${\n        checked ? 'bg-green-500' : 'bg-gray-300'\n      } ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}\n    >\n      <span\n        className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${\n          checked ? 'translate-x-6' : 'translate-x-1'\n        }`}\n      />\n    </button>\n  );\n}\n\nexport function EventEditorModal({\n  isOpen,\n  isEditing,\n  errorMessage,\n  saving,\n  deleting,\n  formState,\n  setFormState,\n  midiSongs,\n  logos,\n  midiSet,\n  logoSet,\n  onClose,\n  onSave,\n  onDelete,\n}: EventEditorModalProps) {\n  if (!isOpen) return null;\n\n  const blocked = saving || deleting;\n\n  return (\n    <div className=\"modal-overlay\">\n      <div className=\"modal-panel modal-panel-xl\">\n        <h3 className=\"text-lg font-bold mb-4\">\n          {isEditing ? 'Muokkaa tapahtumaa' : 'Lis√§√§ tapahtuma'}\n        </h3>\n        {errorMessage && <Alert variant=\"error\">{errorMessage}</Alert>}\n\n        <div className=\"space-y-4\">\n          <div>\n            <label htmlFor=\"eventName\" className=\"form-label\">\n              Nimi\n            </label>\n            <Input\n              id=\"eventName\"\n              value={formState.name}\n              onChange={(event) =>\n                setFormState((prev) => ({ ...prev, name: event.target.value }))\n              }\n              placeholder=\"esim. Joulu 2026\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between gap-3 px-1 py-1\">\n            <div>\n              <p className=\"font-medium text-gray-800\">Ajanjakso</p>\n              <p className=\"text-muted-sm\">\n                {formState.dateRangeEnabled ? 'Alku- ja loppup√§iv√§ k√§yt√∂ss√§' : 'Yksitt√§inen p√§iv√§ k√§yt√∂ss√§'}\n              </p>\n            </div>\n            <ToggleSwitch\n              id=\"eventDateRangeEnabled\"\n              checked={formState.dateRangeEnabled}\n              onClick={() =>\n                setFormState((prev) => ({\n                  ...prev,\n                  dateRangeEnabled: !prev.dateRangeEnabled,\n                }))\n              }\n              disabled={blocked}\n              label=\"Date range\"\n            />\n          </div>\n\n          {!formState.dateRangeEnabled && (\n            <div>\n              <label htmlFor=\"eventDate\" className=\"form-label\">\n                P√§iv√§\n              </label>\n              <Input\n                id=\"eventDate\"\n                type=\"date\"\n                value={formState.eventDate}\n                onChange={(event) =>\n                  setFormState((prev) => ({ ...prev, eventDate: event.target.value }))\n                }\n              />\n            </div>\n          )}\n\n          {formState.dateRangeEnabled && (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n              <div>\n                <label htmlFor=\"eventRangeStartDate\" className=\"form-label\">\n                  Alkaa\n                </label>\n                <Input\n                  id=\"eventRangeStartDate\"\n                  type=\"date\"\n                  value={formState.rangeStartDate}\n                  onChange={(event) =>\n                    setFormState((prev) => ({ ...prev, rangeStartDate: event.target.value }))\n                  }\n                />\n              </div>\n              <div>\n                <label htmlFor=\"eventRangeEndDate\" className=\"form-label\">\n                  P√§√§ttyy\n                </label>\n                <Input\n                  id=\"eventRangeEndDate\"\n                  type=\"date\"\n                  value={formState.rangeEndDate}\n                  onChange={(event) =>\n                    setFormState((prev) => ({ ...prev, rangeEndDate: event.target.value }))\n                  }\n                />\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex items-center justify-between gap-3 px-1 py-1\">\n            <div>\n              <p className=\"font-medium text-gray-800\">Toistuu vuosittain</p>\n              <p className=\"text-muted-sm\">\n                {formState.repeatsYearly ? 'Tapahtuma toistuu joka vuosi' : 'Tapahtuma on kertaluonteinen'}\n              </p>\n            </div>\n            <ToggleSwitch\n              id=\"eventRepeatsYearly\"\n              checked={formState.repeatsYearly}\n              onClick={() =>\n                setFormState((prev) => ({\n                  ...prev,\n                  repeatsYearly: !prev.repeatsYearly,\n                }))\n              }\n              disabled={blocked}\n              label=\"Toistuu vuosittain\"\n            />\n          </div>\n\n          <section className=\"section-block\">\n            <h4 className=\"section-header\">Tiedostot</h4>\n\n            <div>\n              <label htmlFor=\"eventMusicFile\" className=\"form-label\">\n                <span className=\"inline-flex items-center gap-1\">\n                  <Music2 size={16} />\n                  MIDI-tiedosto\n                </span>\n              </label>\n              <select\n                id=\"eventMusicFile\"\n                value={formState.musicFile}\n                disabled={blocked}\n                onChange={(event) => setFormState((prev) => ({ ...prev, musicFile: event.target.value }))}\n                className=\"w-full px-4 py-2 border-2 border-gray-300 rounded focus:border-yellow-400 focus:outline-none disabled:bg-gray-100 disabled:text-gray-500\"\n              >\n                <option value=\"\">Ei midi-tiedostoa</option>\n                {midiSongs.map((song) => (\n                  <option key={song} value={song}>\n                    {song}\n                  </option>\n                ))}\n              </select>\n              <p className=\"text-muted-xs mt-1\">\n                L√∂ydetty {midiSongs.length} MIDI-tiedostoa kansiosta `public/midi`.\n              </p>\n              {!formState.musicEnabled && (\n                <p className=\"text-muted-xs mt-1\">\n                  Tiedosto tallennetaan valmiiksi, mutta sit√§ k√§ytet√§√§n vain jos musiikki on p√§√§ll√§.\n                </p>\n              )}\n              {midiSongs.length === 0 && (\n                <p className=\"text-error-xs\">\n                  MIDI-tiedostoja ei l√∂ytynyt kansiosta `public/midi`.\n                </p>\n              )}\n              {formState.musicEnabled && formState.musicFile && !midiSet.has(formState.musicFile) && (\n                <p className=\"text-error-xs\">Valittu MIDI puuttuu kansiosta `public/midi`.</p>\n              )}\n            </div>\n\n            <div className=\"mt-4 flex items-center justify-between gap-3 px-1 py-1\">\n              <div>\n                <p className=\"font-medium text-gray-800\">Midin soittaminen</p>\n                <p className=\"text-muted-sm\">\n                  {formState.musicEnabled ? 'MIDI soi tapahtuman aikana' : 'MIDI ei soi tapahtuman aikana'}\n                </p>\n              </div>\n              <ToggleSwitch\n                id=\"eventMusicEnabled\"\n                checked={formState.musicEnabled}\n                onClick={() =>\n                  setFormState((prev) => ({\n                    ...prev,\n                    musicEnabled: !prev.musicEnabled,\n                  }))\n                }\n                disabled={blocked}\n                label=\"Tapahtuman musiikki\"\n              />\n            </div>\n\n            <div className=\"mt-4\">\n              <label htmlFor=\"eventLogoFile\" className=\"form-label\">\n                <span className=\"inline-flex items-center gap-1\">\n                  <ImageIcon size={16} />\n                  Logo\n                </span>\n              </label>\n              <select\n                id=\"eventLogoFile\"\n                value={formState.logoFile}\n                disabled={blocked}\n                onChange={(event) => setFormState((prev) => ({ ...prev, logoFile: event.target.value }))}\n                className=\"w-full px-4 py-2 border-2 border-gray-300 rounded focus:border-yellow-400 focus:outline-none disabled:bg-gray-100 disabled:text-gray-500\"\n              >\n                <option value=\"\">Ei logoa</option>\n                {logos.map((logo) => (\n                  <option key={logo} value={logo}>\n                    {logo}\n                  </option>\n                ))}\n              </select>\n              <p className=\"text-muted-xs mt-1\">\n                L√∂ydetty {logos.length} logotiedostoa kansiosta `public/logo`.\n              </p>\n              {formState.logoEnabled && formState.logoFile && !logoSet.has(formState.logoFile) && (\n                <p className=\"text-error-xs\">Valittu logo puuttuu kansiosta `public/logo`.</p>\n              )}\n            </div>\n\n            <div className=\"mt-4 flex items-center justify-between gap-3 px-1 py-1\">\n              <div>\n                <p className=\"font-medium text-gray-800\">Logon n√§ytt√§minen</p>\n                <p className=\"text-muted-sm\">\n                  {formState.logoEnabled ? 'Logo n√§ytet√§√§n tapahtuman aikana' : 'Logoa ei n√§ytet√§ tapahtuman aikana'}\n                </p>\n              </div>\n              <ToggleSwitch\n                id=\"eventLogoEnabled\"\n                checked={formState.logoEnabled}\n                onClick={() =>\n                  setFormState((prev) => ({\n                    ...prev,\n                    logoEnabled: !prev.logoEnabled,\n                  }))\n                }\n                disabled={blocked}\n                label=\"Tapahtuman logo\"\n              />\n            </div>\n          </section>\n        </div>\n\n        <div className=\"mt-6 flex items-center justify-between gap-2\">\n          <div>\n            {isEditing && (\n              <Button\n                type=\"button\"\n                variant=\"danger\"\n                onClick={onDelete}\n                disabled={blocked}\n              >\n                {deleting ? 'Poistetaan...' : 'Poista'}\n              </Button>\n            )}\n          </div>\n          <div className=\"flex gap-2\">\n            <Button type=\"button\" variant=\"outline\" onClick={onClose} disabled={blocked}>\n              Peruuta\n            </Button>\n            <Button type=\"button\" variant=\"primary\" onClick={onSave} disabled={blocked}>\n              {saving ? 'Tallennetaan...' : 'Tallenna'}\n            </Button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/events/EventsTable.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 13. Maximum allowed is 12.","line":32,"column":31,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":32,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { SiteEvent } from '@/components/admin/events/types';\n\ninterface EventsTableProps {\n  events: SiteEvent[];\n  midiSet: Set<string>;\n  logoSet: Set<string>;\n  onEdit: (event: SiteEvent) => void;\n  formatDateCell: (event: SiteEvent) => string;\n  formatMidiName: (fileName: string | null) => string;\n}\n\nexport function EventsTable({\n  events,\n  midiSet,\n  logoSet,\n  onEdit,\n  formatDateCell,\n  formatMidiName,\n}: EventsTableProps) {\n  return (\n    <div className=\"overflow-x-auto border border-gray-200 rounded-lg\">\n      <table className=\"w-full text-sm\">\n        <thead className=\"bg-gray-50 text-left\">\n          <tr>\n            <th className=\"px-3 py-2 font-semibold\">Nimi</th>\n            <th className=\"px-3 py-2 font-semibold\">P√§iv√§</th>\n            <th className=\"px-3 py-2 font-semibold\">MIDI</th>\n            <th className=\"px-3 py-2 font-semibold\">Logo</th>\n          </tr>\n        </thead>\n        <tbody>\n          {events.map((event) => {\n            const musicMissing = !!event.music_enabled && !!event.music_file && !midiSet.has(event.music_file);\n            const logoMissing = !!event.logo_enabled && !!event.logo_file && !logoSet.has(event.logo_file);\n\n            return (\n              <tr\n                key={event.id}\n                className=\"border-t border-gray-100 hover:bg-yellow-50/40 cursor-pointer\"\n                onClick={() => onEdit(event)}\n              >\n                <td className=\"px-3 py-2 font-medium\">{event.name}</td>\n                <td className=\"px-3 py-2\">\n                  {formatDateCell(event)}\n                  {event.date_range_enabled && (\n                    <span className=\"ml-2 text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700\">Jakso</span>\n                  )}\n                </td>\n                <td className=\"px-3 py-2\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <span className={`text-xs px-2 py-1 rounded ${event.music_enabled ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700'}`}>\n                      {event.music_enabled ? 'On' : 'Off'}\n                    </span>\n                    <span>{formatMidiName(event.music_file)}</span>\n                    {musicMissing && <span className=\"text-xs px-2 py-1 rounded bg-red-100 text-red-700\">Puuttuu</span>}\n                  </div>\n                </td>\n                <td className=\"px-3 py-2\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <span className={`text-xs px-2 py-1 rounded ${event.logo_enabled ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700'}`}>\n                      {event.logo_enabled ? 'On' : 'Off'}\n                    </span>\n                    <span>{event.logo_file || 'No logo file'}</span>\n                    {logoMissing && <span className=\"text-xs px-2 py-1 rounded bg-red-100 text-red-700\">Puuttuu</span>}\n                  </div>\n                </td>\n              </tr>\n            );\n          })}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/events/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/admin/useAdminTagManagement.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 15. Maximum allowed is 12.","line":123,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":123,"endColumn":44},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (569). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":570,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\nimport { createClient } from '@/lib/supabase/client';\nimport type { TokenOption } from '@/components/ui/TokenInput';\nimport type {\n  AdminTagGroup,\n  CanonicalTagOption,\n  TagAliasRow,\n  TagGroupAliasRow,\n  TagModerationAction,\n  UnreviewedTag,\n} from '@/components/admin/types';\n\nfunction groupAliasesByTagId(rows: TagAliasRow[]) {\n  return rows.reduce<Record<number, TagAliasRow[]>>((acc, row) => {\n    if (!acc[row.tag_id]) {\n      acc[row.tag_id] = [];\n    }\n    acc[row.tag_id].push(row);\n    return acc;\n  }, {});\n}\n\nfunction groupAliasesByGroupId(rows: TagGroupAliasRow[]) {\n  return rows.reduce<Record<number, TagGroupAliasRow[]>>((acc, row) => {\n    if (!acc[row.group_id]) {\n      acc[row.group_id] = [];\n    }\n    acc[row.group_id].push(row);\n    return acc;\n  }, {});\n}\n\nfunction normalizeMemberTagIds(value: unknown): number[] {\n  if (!Array.isArray(value)) return [];\n  return value\n    .map((entry) => Number.parseInt(String(entry), 10))\n    .filter((entry) => Number.isFinite(entry) && entry > 0);\n}\n\nfunction normalizeCanonicalTags(rows: Record<string, unknown>[]): CanonicalTagOption[] {\n  return rows.map((row) => ({\n    id: Number(row.id),\n    name: String(row.name ?? ''),\n    slug: String(row.slug ?? ''),\n    legacy_icon_path: row.legacy_icon_path ? String(row.legacy_icon_path) : null,\n    usage_count: Number(row.usage_count ?? 0),\n    alias_count: Number(row.alias_count ?? 0),\n    group_membership_count: Number(row.group_membership_count ?? 0),\n    redirect_reference_count: Number(row.redirect_reference_count ?? 0),\n  }));\n}\n\nexport function useAdminTagManagement(supabase: ReturnType<typeof createClient>) {\n  const [unreviewedTags, setUnreviewedTags] = useState<UnreviewedTag[]>([]);\n  const [canonicalTags, setCanonicalTags] = useState<CanonicalTagOption[]>([]);\n  const [tagAliasesByTagId, setTagAliasesByTagId] = useState<Record<number, TagAliasRow[]>>({});\n  const [tagGroupAliasesByGroupId, setTagGroupAliasesByGroupId] = useState<Record<number, TagGroupAliasRow[]>>({});\n  const [tagGroups, setTagGroups] = useState<AdminTagGroup[]>([]);\n  const [aliasInputByTagId, setAliasInputByTagId] = useState<Record<number, string>>({});\n  const [groupAliasInputByGroupId, setGroupAliasInputByGroupId] = useState<Record<number, string>>({});\n  const [aliasSearch, setAliasSearch] = useState('');\n  const [newTagName, setNewTagName] = useState('');\n  const [newTagSlug, setNewTagSlug] = useState('');\n  const [editingTagId, setEditingTagId] = useState<number | null>(null);\n  const [editingTagName, setEditingTagName] = useState('');\n  const [editingTagSlug, setEditingTagSlug] = useState('');\n  const [editingTagGroupIds, setEditingTagGroupIds] = useState<number[]>([]);\n  const [deleteReplacementTagId, setDeleteReplacementTagId] = useState<number | ''>('');\n  const [mergeTargetByTagId, setMergeTargetByTagId] = useState<Record<number, number | ''>>({});\n  const [processingTagId, setProcessingTagId] = useState<number | null>(null);\n  const [creatingTag, setCreatingTag] = useState(false);\n  const [processingGroupId, setProcessingGroupId] = useState<number | null>(null);\n  const [processingAliasId, setProcessingAliasId] = useState<number | null>(null);\n  const [processingGroupAliasId, setProcessingGroupAliasId] = useState<number | null>(null);\n  const [addingAliasTagId, setAddingAliasTagId] = useState<number | null>(null);\n  const [addingAliasGroupId, setAddingAliasGroupId] = useState<number | null>(null);\n  const [tagActionError, setTagActionError] = useState('');\n  const [tagGroupActionError, setTagGroupActionError] = useState('');\n  const [newGroupName, setNewGroupName] = useState('');\n  const [newGroupSlug, setNewGroupSlug] = useState('');\n  const [newGroupDescription, setNewGroupDescription] = useState('');\n  const [newGroupSearchable, setNewGroupSearchable] = useState(true);\n  const [newGroupKind, setNewGroupKind] = useState<'search' | 'arrangement' | 'both'>('both');\n  const [groupTagQueryByGroupId, setGroupTagQueryByGroupId] = useState<Record<number, string>>({});\n\n  const refreshUnreviewedTags = async () => {\n    const { data } = await supabase.rpc('get_unreviewed_tags_with_usage');\n    setUnreviewedTags((data ?? []) as UnreviewedTag[]);\n  };\n\n  const refreshCanonicalTags = async () => {\n    const { data } = await supabase.rpc('get_admin_canonical_tags_with_usage');\n    setCanonicalTags(normalizeCanonicalTags((data ?? []) as Record<string, unknown>[]));\n  };\n\n  const refreshTagAliases = async () => {\n    const { data } = await supabase.rpc('get_tag_aliases');\n    setTagAliasesByTagId(groupAliasesByTagId((data ?? []) as TagAliasRow[]));\n  };\n\n  const refreshTagGroups = async () => {\n    const { data } = await supabase.rpc('get_tag_groups_with_members');\n    const normalized = ((data ?? []) as Record<string, unknown>[]).map((row) => ({\n      group_id: Number(row.group_id),\n      group_name: String(row.group_name ?? ''),\n      group_slug: String(row.group_slug ?? ''),\n      description: row.description ? String(row.description) : null,\n      searchable: row.searchable === true,\n      group_kind: (String(row.group_kind ?? 'both') as 'search' | 'arrangement' | 'both'),\n      arrangement_order: Number(row.arrangement_order ?? 0),\n      member_count: Number(row.member_count ?? 0),\n      member_tag_ids: normalizeMemberTagIds(row.member_tag_ids),\n    })) as AdminTagGroup[];\n    setTagGroups(normalized);\n  };\n\n  const refreshTagGroupAliases = async () => {\n    const { data } = await supabase.rpc('get_tag_group_aliases');\n    setTagGroupAliasesByGroupId(groupAliasesByGroupId((data ?? []) as TagGroupAliasRow[]));\n  };\n\n  useEffect(() => {\n    const fetchTagsDomainData = async () => {\n      const [unreviewedTagsRes, canonicalTagsRes, aliasesRes, groupsRes, groupAliasesRes] = await Promise.all([\n        supabase.rpc('get_unreviewed_tags_with_usage'),\n        supabase.rpc('get_admin_canonical_tags_with_usage'),\n        supabase.rpc('get_tag_aliases'),\n        supabase.rpc('get_tag_groups_with_members'),\n        supabase.rpc('get_tag_group_aliases'),\n      ]);\n\n      if (!unreviewedTagsRes.error && unreviewedTagsRes.data) {\n        setUnreviewedTags((unreviewedTagsRes.data ?? []) as UnreviewedTag[]);\n      }\n      if (!canonicalTagsRes.error && canonicalTagsRes.data) {\n        setCanonicalTags(normalizeCanonicalTags((canonicalTagsRes.data ?? []) as Record<string, unknown>[]));\n      }\n      if (!aliasesRes.error && aliasesRes.data) {\n        setTagAliasesByTagId(groupAliasesByTagId((aliasesRes.data ?? []) as TagAliasRow[]));\n      }\n      if (!groupsRes.error && groupsRes.data) {\n        const normalized = (groupsRes.data as Record<string, unknown>[]).map((row) => ({\n          group_id: Number(row.group_id),\n          group_name: String(row.group_name ?? ''),\n          group_slug: String(row.group_slug ?? ''),\n          description: row.description ? String(row.description) : null,\n          searchable: row.searchable === true,\n          group_kind: (String(row.group_kind ?? 'both') as 'search' | 'arrangement' | 'both'),\n          arrangement_order: Number(row.arrangement_order ?? 0),\n          member_count: Number(row.member_count ?? 0),\n          member_tag_ids: normalizeMemberTagIds(row.member_tag_ids),\n        })) as AdminTagGroup[];\n        setTagGroups(normalized);\n      }\n      if (!groupAliasesRes.error && groupAliasesRes.data) {\n        setTagGroupAliasesByGroupId(groupAliasesByGroupId((groupAliasesRes.data ?? []) as TagGroupAliasRow[]));\n      }\n    };\n\n    fetchTagsDomainData();\n  }, [supabase]);\n\n  const handleModerateTag = async (tagId: number, action: TagModerationAction) => {\n    setProcessingTagId(tagId);\n    const { error } = await supabase.rpc('moderate_tag', {\n      input_tag_id: tagId,\n      input_action: action,\n    });\n\n    if (!error) {\n      await refreshUnreviewedTags();\n      await refreshCanonicalTags();\n    }\n    setProcessingTagId(null);\n  };\n\n  const handleMergeTag = async (sourceTagId: number) => {\n    const targetTagId = mergeTargetByTagId[sourceTagId];\n    if (!targetTagId) return;\n\n    setProcessingTagId(sourceTagId);\n    const { error } = await supabase.rpc('merge_tags', {\n      source_tag_id: sourceTagId,\n      target_tag_id: targetTagId,\n    });\n\n    if (!error) {\n      await refreshUnreviewedTags();\n      await refreshCanonicalTags();\n      await refreshTagAliases();\n      setMergeTargetByTagId((prev) => ({ ...prev, [sourceTagId]: '' }));\n    }\n\n    setProcessingTagId(null);\n  };\n\n  const handleCreateTag = async () => {\n    const normalizedName = newTagName.trim();\n    if (!normalizedName) return;\n\n    setTagActionError('');\n    setCreatingTag(true);\n    const { error } = await supabase.rpc('create_admin_tag', {\n      input_name: normalizedName,\n      input_slug: newTagSlug.trim() || null,\n    });\n\n    if (!error) {\n      setNewTagName('');\n      setNewTagSlug('');\n      await refreshCanonicalTags();\n    } else {\n      setTagActionError(error.message || 'Tagin luonti ep√§onnistui');\n    }\n    setCreatingTag(false);\n  };\n\n  const handleAddAlias = async (tagId: number, explicitValue?: string) => {\n    const aliasValue = (explicitValue ?? aliasInputByTagId[tagId] ?? '').trim();\n    if (!aliasValue) return;\n    setTagActionError('');\n\n    setAddingAliasTagId(tagId);\n    const { error } = await supabase.rpc('add_tag_alias', {\n      input_tag_id: tagId,\n      input_alias: aliasValue,\n    });\n\n    if (!error) {\n      setAliasInputByTagId((prev) => ({ ...prev, [tagId]: '' }));\n      await refreshTagAliases();\n    } else {\n      setTagActionError(error.message || 'Aliaksen lis√§ys ep√§onnistui');\n    }\n    setAddingAliasTagId(null);\n  };\n\n  const handleDeleteAlias = async (aliasId: number) => {\n    setTagActionError('');\n    setProcessingAliasId(aliasId);\n    const { error } = await supabase.rpc('delete_tag_alias', {\n      input_alias_id: aliasId,\n    });\n\n    if (!error) {\n      await refreshTagAliases();\n    } else {\n      setTagActionError(error.message || 'Aliaksen poisto ep√§onnistui');\n    }\n    setProcessingAliasId(null);\n  };\n\n  const cancelRenameTag = () => {\n    setEditingTagId(null);\n    setEditingTagName('');\n    setEditingTagSlug('');\n    setEditingTagGroupIds([]);\n    setDeleteReplacementTagId('');\n  };\n\n  const handleDeleteTag = async (tag: CanonicalTagOption, replacementTagId: number | '') => {\n    const replacementLabel =\n      replacementTagId === ''\n        ? 'off-topic'\n        : (canonicalTags.find((candidate) => candidate.id === replacementTagId)?.name || String(replacementTagId));\n    const confirmed = window.confirm(\n      `Poistetaanko tagi ${tag.name}?\\n\\n` +\n      `Tagin k√§yt√∂t siirret√§√§n tagille: ${replacementLabel}.\\n` +\n      `Toimintoa ei voi perua.`\n    );\n    if (!confirmed) return;\n\n    setTagActionError('');\n    setProcessingTagId(tag.id);\n    const { error } = await supabase.rpc('delete_tag_with_reassignment', {\n      input_tag_id: tag.id,\n      input_replacement_tag_id: replacementTagId === '' ? null : replacementTagId,\n    });\n\n    if (!error) {\n      await refreshCanonicalTags();\n      await refreshTagAliases();\n      await refreshTagGroups();\n      await refreshTagGroupAliases();\n      if (editingTagId === tag.id) {\n        cancelRenameTag();\n      }\n    } else {\n      setTagActionError(error.message || 'Tagin poisto ep√§onnistui');\n    }\n    setProcessingTagId(null);\n  };\n\n  const beginRenameTag = (tag: CanonicalTagOption) => {\n    setEditingTagId(tag.id);\n    setEditingTagName(tag.name);\n    setEditingTagSlug(tag.slug);\n    setEditingTagGroupIds(\n      tagGroups\n        .filter((group) => group.member_tag_ids.includes(tag.id))\n        .map((group) => group.group_id)\n    );\n    setDeleteReplacementTagId('');\n  };\n\n  const handleSaveTagCard = async (tagId: number) => {\n    const nextName = editingTagName.trim();\n    if (!nextName) return;\n    setTagActionError('');\n\n    setProcessingTagId(tagId);\n    const { error: renameError } = await supabase.rpc('update_tag_details', {\n      input_tag_id: tagId,\n      input_name: nextName,\n      input_slug: editingTagSlug.trim() || null,\n      input_add_old_aliases: true,\n    });\n\n    if (renameError) {\n      setTagActionError(renameError.message || 'Tagin tallennus ep√§onnistui');\n      setProcessingTagId(null);\n      return;\n    }\n\n    const { error: groupsError } = await supabase.rpc('set_tag_group_memberships_for_tag', {\n      input_tag_id: tagId,\n      input_group_ids: editingTagGroupIds,\n    });\n\n    if (groupsError) {\n      setTagActionError(groupsError.message || 'Tagiryhmien tallennus ep√§onnistui');\n      setProcessingTagId(null);\n      return;\n    }\n\n    await refreshCanonicalTags();\n    await refreshTagAliases();\n    await refreshTagGroups();\n    setEditingTagId(null);\n    setEditingTagName('');\n    setEditingTagSlug('');\n    setEditingTagGroupIds([]);\n    setDeleteReplacementTagId('');\n    setProcessingTagId(null);\n  };\n\n  const handleSaveTagGroup = async (group: AdminTagGroup) => {\n    setTagGroupActionError('');\n    setProcessingGroupId(group.group_id);\n    const { error } = await supabase.rpc('upsert_tag_group', {\n      input_group_id: group.group_id,\n      input_name: group.group_name.trim(),\n      input_slug: group.group_slug.trim(),\n      input_description: (group.description || '').trim(),\n      input_searchable: group.searchable,\n      input_member_tag_ids: group.member_tag_ids,\n      input_group_kind: group.group_kind,\n      input_arrangement_order: group.arrangement_order,\n    });\n\n    if (!error) {\n      await refreshTagGroups();\n    } else {\n      setTagGroupActionError(error.message || 'Tagiryhm√§n tallennus ep√§onnistui');\n    }\n    setProcessingGroupId(null);\n  };\n\n  const handleCreateTagGroup = async () => {\n    if (!newGroupName.trim()) return;\n    setTagGroupActionError('');\n    setProcessingGroupId(-1);\n    const { error } = await supabase.rpc('upsert_tag_group', {\n      input_group_id: null,\n      input_name: newGroupName.trim(),\n      input_slug: newGroupSlug.trim() || null,\n      input_description: newGroupDescription.trim() || null,\n      input_searchable: newGroupSearchable,\n      input_member_tag_ids: [],\n      input_group_kind: newGroupKind,\n      input_arrangement_order: null,\n    });\n\n    if (!error) {\n      setNewGroupName('');\n      setNewGroupSlug('');\n      setNewGroupDescription('');\n      setNewGroupSearchable(true);\n      setNewGroupKind('both');\n      await refreshTagGroups();\n    } else {\n      setTagGroupActionError(error.message || 'Tagiryhm√§n luonti ep√§onnistui');\n    }\n    setProcessingGroupId(null);\n  };\n\n  const handleDeleteTagGroup = async (groupId: number) => {\n    setTagGroupActionError('');\n    setProcessingGroupId(groupId);\n    const { error } = await supabase.rpc('delete_tag_group', {\n      input_group_id: groupId,\n    });\n    if (!error) {\n      await refreshTagGroups();\n      await refreshTagGroupAliases();\n    } else {\n      setTagGroupActionError(error.message || 'Tagiryhm√§n poisto ep√§onnistui');\n    }\n    setProcessingGroupId(null);\n  };\n\n  const handleMoveArrangementGroup = async (groupId: number, direction: 'up' | 'down') => {\n    const arrangementGroups = [...tagGroups]\n      .filter((group) => group.group_kind === 'arrangement' || group.group_kind === 'both')\n      .sort((a, b) => a.arrangement_order - b.arrangement_order || a.group_name.localeCompare(b.group_name, 'fi'));\n\n    const currentIndex = arrangementGroups.findIndex((group) => group.group_id === groupId);\n    if (currentIndex < 0) return;\n\n    const swapIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;\n    if (swapIndex < 0 || swapIndex >= arrangementGroups.length) return;\n\n    const currentGroup = arrangementGroups[currentIndex];\n    const otherGroup = arrangementGroups[swapIndex];\n\n    setTagGroupActionError('');\n    setProcessingGroupId(groupId);\n\n    const { error } = await supabase.rpc('swap_tag_group_arrangement_order', {\n      input_first_group_id: currentGroup.group_id,\n      input_second_group_id: otherGroup.group_id,\n    });\n\n    if (error) {\n      setTagGroupActionError(error.message || 'Ryhm√§n j√§rjestyksen muutos ep√§onnistui');\n      setProcessingGroupId(null);\n      return;\n    }\n\n    await refreshTagGroups();\n    setProcessingGroupId(null);\n  };\n\n  const handleAddGroupAlias = async (groupId: number, explicitValue?: string) => {\n    const value = (explicitValue ?? groupAliasInputByGroupId[groupId] ?? '').trim();\n    if (!value) return;\n\n    setTagGroupActionError('');\n    setAddingAliasGroupId(groupId);\n    const { error } = await supabase.rpc('add_tag_group_alias', {\n      input_group_id: groupId,\n      input_alias: value,\n    });\n\n    if (!error) {\n      setGroupAliasInputByGroupId((prev) => ({ ...prev, [groupId]: '' }));\n      await refreshTagGroupAliases();\n    } else {\n      setTagGroupActionError(error.message || 'Tagiryhm√§n aliaksen lis√§ys ep√§onnistui');\n    }\n    setAddingAliasGroupId(null);\n  };\n\n  const handleDeleteGroupAlias = async (aliasId: number) => {\n    setTagGroupActionError('');\n    setProcessingGroupAliasId(aliasId);\n    const { error } = await supabase.rpc('delete_tag_group_alias', {\n      input_alias_id: aliasId,\n    });\n    if (!error) {\n      await refreshTagGroupAliases();\n    } else {\n      setTagGroupActionError(error.message || 'Tagiryhm√§n aliaksen poisto ep√§onnistui');\n    }\n    setProcessingGroupAliasId(null);\n  };\n\n  const canonicalTagToToken = (tagId: number) => {\n    const tag = canonicalTags.find((entry) => entry.id === tagId);\n    if (!tag) return null;\n    return {\n      id: tag.id,\n      label: `${tag.name}`,\n    };\n  };\n\n  const buildGroupTagOptions = (group: AdminTagGroup): TokenOption[] => {\n    const query = (groupTagQueryByGroupId[group.group_id] || '').trim().toLowerCase();\n    return canonicalTags\n      .filter((tag) => !group.member_tag_ids.includes(tag.id))\n      .filter((tag) => {\n        if (!query) return true;\n        return tag.name.toLowerCase().includes(query) || tag.slug.toLowerCase().includes(query);\n      })\n      .map((tag) => ({\n        id: tag.id,\n        label: `${tag.name}`,\n        meta: `(${tag.slug})`,\n      }));\n  };\n\n  return {\n    unreviewedTags,\n    canonicalTags,\n    tagAliasesByTagId,\n    tagGroupAliasesByGroupId,\n    tagGroups,\n    aliasInputByTagId,\n    groupAliasInputByGroupId,\n    aliasSearch,\n    newTagName,\n    newTagSlug,\n    editingTagId,\n    editingTagName,\n    editingTagSlug,\n    editingTagGroupIds,\n    deleteReplacementTagId,\n    mergeTargetByTagId,\n    processingTagId,\n    creatingTag,\n    processingGroupId,\n    processingAliasId,\n    processingGroupAliasId,\n    addingAliasTagId,\n    addingAliasGroupId,\n    tagActionError,\n    tagGroupActionError,\n    newGroupName,\n    newGroupSlug,\n    newGroupDescription,\n    newGroupSearchable,\n    newGroupKind,\n    groupTagQueryByGroupId,\n    setTagGroups,\n    setAliasSearch,\n    setEditingTagName,\n    setEditingTagSlug,\n    setEditingTagGroupIds,\n    setDeleteReplacementTagId,\n    setMergeTargetByTagId,\n    setAliasInputByTagId,\n    setNewTagName,\n    setNewTagSlug,\n    setNewGroupName,\n    setNewGroupSlug,\n    setNewGroupDescription,\n    setNewGroupSearchable,\n    setNewGroupKind,\n    setGroupTagQueryByGroupId,\n    setGroupAliasInputByGroupId,\n    beginRenameTag,\n    cancelRenameTag,\n    handleModerateTag,\n    handleMergeTag,\n    handleCreateTag,\n    handleAddAlias,\n    handleDeleteAlias,\n    handleDeleteTag,\n    handleSaveTagCard,\n    handleSaveTagGroup,\n    handleCreateTagGroup,\n    handleDeleteTagGroup,\n    handleMoveArrangementGroup,\n    handleAddGroupAlias,\n    handleDeleteGroupAlias,\n    canonicalTagToToken,\n    buildGroupTagOptions,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/effects/RetroFilter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/AddTags.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/ForumThreadList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/ReplyForm.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":51,"column":11,"nodeType":"JSXOpeningElement","endLine":51,"endColumn":88}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { MessageSquare, ImagePlus, X } from 'lucide-react';\nimport { CldUploadWidget } from 'next-cloudinary';\nimport { extractSecureUrl, postThumb } from '@/lib/cloudinary';\nimport { getCloudinaryUploadPresetOrThrow, getPostUploadWidgetOptions } from '@/lib/cloudinaryWidget';\nimport { handleMarkdownTextareaShortcut } from '@/lib/markdownShortcuts';\n\ninterface ReplyFormProps {\n  onSubmit: (content: string, imageUrl: string) => Promise<void>;\n  submitting: boolean;\n}\n\nexport function ReplyForm({ onSubmit, submitting }: ReplyFormProps) {\n  const [content, setContent] = useState('');\n  const [imageUrl, setImageUrl] = useState('');\n  const uploadPreset = getCloudinaryUploadPresetOrThrow();\n\n  const handleSubmit = async () => {\n    if (!content.trim()) return;\n    await onSubmit(content, imageUrl);\n    setContent('');\n    setImageUrl('');\n  };\n\n  return (\n    <div>\n      <textarea\n        value={content}\n        onChange={(e) => setContent(e.target.value)}\n        onKeyDown={(e) => {\n          handleMarkdownTextareaShortcut(e, content, setContent);\n        }}\n        className=\"field-textarea field-textarea--reply\"\n        placeholder=\"Kirjoita vastauksesi...\"\n      />\n      <p className=\"mb-4 -mt-2 text-muted-xs\">\n        <a\n          href=\"https://www.markdownguide.org/cheat-sheet/\"\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"content-inline-link\"\n        >\n          Muotoile viesti Markdownilla\n        </a>\n      </p>\n      {imageUrl && (\n        <div className=\"relative inline-block mb-4\">\n          <img src={postThumb(imageUrl)} alt=\"Liite\" className=\"max-h-40 rounded-lg\" />\n          <button\n            type=\"button\"\n            onClick={() => setImageUrl('')}\n            className=\"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600\"\n          >\n            <X size={14} />\n          </button>\n        </div>\n      )}\n      <div className=\"composer-actions\">\n        <CldUploadWidget\n          uploadPreset={uploadPreset}\n          options={getPostUploadWidgetOptions()}\n          onSuccess={(result: unknown) => {\n            const secureUrl = extractSecureUrl(result);\n            if (secureUrl) {\n              setImageUrl(secureUrl);\n            }\n          }}\n        >\n          {({ open }) => (\n            <Button type=\"button\" variant=\"outline\" className=\"flex items-center gap-2\" onClick={() => open()}>\n              <ImagePlus size={16} />\n              Lis√§√§ kuva\n            </Button>\n          )}\n        </CldUploadWidget>\n        <Button\n          variant=\"primary\"\n          className=\"composer-actions-submit flex items-center gap-2\"\n          onClick={handleSubmit}\n          disabled={submitting || !content.trim()}\n        >\n          <MessageSquare size={16} />\n          {submitting ? 'L√§hetet√§√§n...' : 'L√§het√§ vastaus'}\n        </Button>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/post/PostActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/post/PostContent.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'parseYouTubeVideoId' has a complexity of 17. Maximum allowed is 12.","line":36,"column":1,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":36,"endColumn":29},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 20 to the 15 allowed.","line":36,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":36,"endColumn":29},{"ruleId":"complexity","severity":1,"message":"Function 'PostContent' has a complexity of 13. Maximum allowed is 12.","line":127,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":127,"endColumn":28},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":197,"column":11,"nodeType":"JSXOpeningElement","endLine":197,"endColumn":110}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { Children, isValidElement, type ReactNode } from 'react';\nimport ReactMarkdown from 'react-markdown';\nimport rehypeSanitize, { defaultSchema } from 'rehype-sanitize';\nimport LinkifyIt from 'linkify-it';\nimport tlds from 'tlds';\nimport { postImage } from '@/lib/cloudinary';\nimport type { Post } from '@/components/forum/post/post.types';\n\nconst URL_MAX_DISPLAY_LENGTH = 60;\nconst UNDERLINE_START = 'ULSTARTTOKEN';\nconst UNDERLINE_END = 'ULENDTOKEN';\nconst linkify = new LinkifyIt();\nlinkify.set({ fuzzyLink: true, fuzzyIP: false, fuzzyEmail: false });\nlinkify.tlds(tlds as string[]);\n\nconst sanitizeSchema = {\n  ...defaultSchema,\n  attributes: {\n    ...defaultSchema.attributes,\n    a: [...(defaultSchema.attributes?.a || []), ['target', '_blank'], ['rel', 'noopener noreferrer']],\n  },\n};\n\nfunction shortenUrlDisplay(url: string): string {\n  if (url.length <= URL_MAX_DISPLAY_LENGTH) return url;\n  return `${url.slice(0, URL_MAX_DISPLAY_LENGTH - 3)}...`;\n}\n\nfunction ensureUrlProtocol(url: string): string {\n  if (/^https?:\\/\\//i.test(url)) return url;\n  return `https://${url}`;\n}\n\nfunction parseYouTubeVideoId(rawUrl: string): string | null {\n  try {\n    const normalized = ensureUrlProtocol(rawUrl);\n    const url = new URL(normalized);\n    const host = url.hostname.replace(/^www\\./i, '').toLowerCase();\n\n    if (host === 'youtu.be') {\n      const candidate = url.pathname.split('/').filter(Boolean)[0] || '';\n      return /^[A-Za-z0-9_-]{11}$/.test(candidate) ? candidate : null;\n    }\n\n    if (host === 'youtube.com' || host === 'm.youtube.com' || host === 'music.youtube.com') {\n      if (url.pathname === '/watch') {\n        const candidate = url.searchParams.get('v') || '';\n        return /^[A-Za-z0-9_-]{11}$/.test(candidate) ? candidate : null;\n      }\n      if (url.pathname.startsWith('/shorts/')) {\n        const candidate = url.pathname.split('/')[2] || '';\n        return /^[A-Za-z0-9_-]{11}$/.test(candidate) ? candidate : null;\n      }\n      if (url.pathname.startsWith('/embed/')) {\n        const candidate = url.pathname.split('/')[2] || '';\n        return /^[A-Za-z0-9_-]{11}$/.test(candidate) ? candidate : null;\n      }\n    }\n  } catch {\n    return null;\n  }\n  return null;\n}\n\nfunction extractYouTubeEmbedUrls(text: string): string[] {\n  const matches = linkify.match(text);\n  if (!matches || matches.length === 0) return [];\n\n  const videoIds = new Set<string>();\n  for (const match of matches) {\n    const videoId = parseYouTubeVideoId(match.url || match.raw);\n    if (videoId) videoIds.add(videoId);\n  }\n\n  return Array.from(videoIds).map((id) => `https://www.youtube-nocookie.com/embed/${id}`);\n}\n\nfunction autoLinkPlainUrls(markdown: string): string {\n  const matches = linkify.match(markdown);\n  if (!matches || matches.length === 0) return markdown;\n\n  let result = '';\n  let cursor = 0;\n\n  for (const match of matches) {\n    const start = match.index;\n    const end = match.lastIndex;\n    const raw = match.raw;\n    const href = ensureUrlProtocol(match.url || raw);\n\n    result += markdown.slice(cursor, start);\n    result += `[${shortenUrlDisplay(raw)}](${href})`;\n    cursor = end;\n  }\n\n  result += markdown.slice(cursor);\n  return result;\n}\n\nfunction preserveSingleLineBreaks(markdown: string): string {\n  const normalized = markdown.replace(/\\r\\n/g, '\\n');\n  return normalized.replace(/(?<!\\n)\\n(?!\\n)/g, '  \\n');\n}\n\nfunction encodeUnderlineSyntax(markdown: string): string {\n  return markdown.replace(/\\+\\+([^\\n]+?)\\+\\+/g, (_match, inner: string) => {\n    return `*${UNDERLINE_START}${inner}${UNDERLINE_END}*`;\n  });\n}\n\nfunction flattenText(node: ReactNode): string {\n  if (typeof node === 'string') return node;\n  if (typeof node === 'number') return String(node);\n  if (Array.isArray(node)) return node.map(flattenText).join('');\n  if (isValidElement<{ children?: ReactNode }>(node)) return flattenText(node.props.children);\n  return '';\n}\n\ninterface PostContentProps {\n  post: Post;\n  hasBeenEdited: boolean;\n  editedLabel: string | null;\n}\n\nexport function PostContent({ post, hasBeenEdited, editedLabel }: PostContentProps) {\n  const youtubeEmbeds = extractYouTubeEmbedUrls(post.content);\n\n  return (\n    <div className=\"flex-1\">\n      <div className=\"prose max-w-none mb-4\">\n        <ReactMarkdown\n          rehypePlugins={[[rehypeSanitize, sanitizeSchema]]}\n          components={{\n            a: ({ href, children }) => {\n              let safeHref = href;\n              try {\n                const url = new URL(href || '', 'https://placeholder.invalid');\n                if (!['http:', 'https:', 'mailto:'].includes(url.protocol)) {\n                  safeHref = undefined;\n                }\n              } catch {\n                safeHref = undefined;\n              }\n\n              const firstChild = Array.isArray(children) ? children[0] : children;\n              const label = typeof firstChild === 'string' ? firstChild : '';\n              const shouldShorten = label && /^https?:\\/\\//i.test(label);\n              const visibleText = shouldShorten ? shortenUrlDisplay(label) : children;\n\n              if (!safeHref) {\n                return <span>{visibleText}</span>;\n              }\n\n              return (\n                <a href={safeHref} target=\"_blank\" rel=\"noopener noreferrer\">\n                  {visibleText}\n                </a>\n              );\n            },\n            em: ({ children }) => {\n              const plain = Children.toArray(children).map((child) => flattenText(child)).join('');\n              if (plain.includes(UNDERLINE_START) && plain.includes(UNDERLINE_END)) {\n                const clean = plain\n                  .replaceAll(UNDERLINE_START, '')\n                  .replaceAll(UNDERLINE_END, '');\n                return <u>{clean}</u>;\n              }\n              return <em>{children}</em>;\n            },\n          }}\n        >\n          {encodeUnderlineSyntax(preserveSingleLineBreaks(autoLinkPlainUrls(post.content)))}\n        </ReactMarkdown>\n        {youtubeEmbeds.length > 0 && (\n          <div className=\"mt-4 space-y-3 not-prose\">\n            {youtubeEmbeds.map((embedUrl) => (\n              <div\n                key={`${post.id}-${embedUrl}`}\n                className=\"ratio-16-9 w-full max-w-3xl overflow-hidden rounded-lg border border-gray-200 bg-black\"\n              >\n                <iframe\n                  src={embedUrl}\n                  title=\"YouTube video\"\n                  className=\"absolute inset-0 h-full w-full\"\n                  loading=\"lazy\"\n                  referrerPolicy=\"strict-origin-when-cross-origin\"\n                  allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\"\n                  allowFullScreen\n                />\n              </div>\n            ))}\n          </div>\n        )}\n        {post.image_url && (\n          <img src={postImage(post.image_url)} alt=\"Liite\" className=\"mt-3 max-w-full max-h-96 rounded-lg\" />\n        )}\n      </div>\n\n      <div className=\"min-w-0 flex-1\">\n        {post.author?.signature && post.author?.show_signature && (\n          <p className=\"text-xs text-gray-400 italic whitespace-pre-wrap\">{post.author.signature}</p>\n        )}\n        {hasBeenEdited && editedLabel && (\n          <p className={`text-xs text-gray-400 italic ${post.author?.signature && post.author?.show_signature ? 'mt-1' : ''}`}>\n            Muokattu viimeksi {editedLabel}\n          </p>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/post/PostEditForm.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":49,"column":11,"nodeType":"JSXOpeningElement","endLine":49,"endColumn":92}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { type ReactNode } from 'react';\nimport { ImagePlus, Save, X } from 'lucide-react';\nimport { CldUploadWidget } from 'next-cloudinary';\nimport { Button } from '@/components/ui/button';\nimport { extractSecureUrl, postThumb } from '@/lib/cloudinary';\nimport { getCloudinaryUploadPresetOrThrow, getPostUploadWidgetOptions } from '@/lib/cloudinaryWidget';\nimport { handleMarkdownTextareaShortcut } from '@/lib/markdownShortcuts';\n\ninterface PostEditFormProps {\n  editTopContent?: ReactNode;\n  editContent: string;\n  onEditContentChange: (value: string) => void;\n  editImageUrl: string;\n  onEditImageUrlChange: (value: string) => void;\n  onCancelEdit: () => void;\n  onSave: () => void;\n  editSaving: boolean;\n  saveLabel: string;\n}\n\nexport function PostEditForm({\n  editTopContent,\n  editContent,\n  onEditContentChange,\n  editImageUrl,\n  onEditImageUrlChange,\n  onCancelEdit,\n  onSave,\n  editSaving,\n  saveLabel,\n}: PostEditFormProps) {\n  const uploadPreset = getCloudinaryUploadPresetOrThrow();\n\n  return (\n    <div className=\"flex-1\">\n      {editTopContent ? <div className=\"mb-3\">{editTopContent}</div> : null}\n      <textarea\n        value={editContent}\n        onChange={(e) => onEditContentChange(e.target.value)}\n        onKeyDown={(e) => {\n          handleMarkdownTextareaShortcut(e, editContent, onEditContentChange);\n        }}\n        className=\"field-textarea field-textarea--edit\"\n      />\n      {editImageUrl && (\n        <div className=\"relative inline-block mb-3\">\n          <img src={postThumb(editImageUrl)} alt=\"Liite\" className=\"max-h-40 rounded-lg\" />\n          <button\n            type=\"button\"\n            onClick={() => onEditImageUrlChange('')}\n            className=\"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600\"\n          >\n            <X size={14} />\n          </button>\n        </div>\n      )}\n      <div className=\"flex items-center gap-2\">\n        <CldUploadWidget\n          uploadPreset={uploadPreset}\n          options={getPostUploadWidgetOptions()}\n          onSuccess={(result: unknown) => {\n            const secureUrl = extractSecureUrl(result);\n            if (secureUrl) onEditImageUrlChange(secureUrl);\n          }}\n        >\n          {({ open }) => (\n            <Button type=\"button\" variant=\"outline\" className=\"flex items-center gap-2\" onClick={() => open()}>\n              <ImagePlus size={16} />\n              {editImageUrl ? 'Vaihda kuva' : 'Lis√§√§ kuva'}\n            </Button>\n          )}\n        </CldUploadWidget>\n        <Button variant=\"outline\" onClick={onCancelEdit}>\n          Peruuta\n        </Button>\n        <Button\n          variant=\"success\"\n          className=\"flex items-center gap-2\"\n          onClick={onSave}\n          disabled={editSaving || !editContent.trim()}\n        >\n          <Save size={16} />\n          {editSaving ? 'Tallennetaan...' : saveLabel}\n        </Button>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/post/PostItem.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":93,"column":13,"nodeType":"JSXOpeningElement","endLine":93,"endColumn":132}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { type ReactNode, useState } from 'react';\nimport Link from 'next/link';\nimport { User } from 'lucide-react';\nimport { formatPostDateTime } from '@/lib/formatDate';\nimport { profileThumb } from '@/lib/cloudinary';\nimport { PostActions } from '@/components/forum/post/PostActions';\nimport { PostContent } from '@/components/forum/post/PostContent';\nimport { PostEditForm } from '@/components/forum/post/PostEditForm';\nimport type { PostLikeState } from '@/hooks/usePostLikes';\nimport type { Post } from '@/components/forum/post/post.types';\n\nexport type { Post } from '@/components/forum/post/post.types';\n\ninterface PostItemProps {\n  post: Post;\n  isOriginalPost: boolean;\n  isHighlighted: boolean;\n  canEdit: boolean;\n  canDelete: boolean;\n  isEditing: boolean;\n  onStartEdit: () => void;\n  onCancelEdit: () => void;\n  onSave: (postId: number, content: string, imageUrl: string) => Promise<void>;\n  editSaving: boolean;\n  editTopContent?: ReactNode;\n  saveLabel?: string;\n  isConfirmingDelete: boolean;\n  onRequestDelete: () => void;\n  onConfirmDelete: () => void;\n  onCancelDelete: () => void;\n  likeState: PostLikeState;\n  likeSaving: boolean;\n  onToggleLike: () => void;\n  isCopied: boolean;\n  onCopyLink: () => void;\n}\n\nfunction hasBeenEdited(post: Post) {\n  if (!post.updated_at) return false;\n  const updatedAt = new Date(post.updated_at).getTime();\n  const createdAt = new Date(post.created_at).getTime();\n  if (Number.isNaN(updatedAt) || Number.isNaN(createdAt)) return false;\n  return updatedAt - createdAt > 1000;\n}\n\nexport function PostItem({\n  post,\n  isOriginalPost,\n  isHighlighted,\n  canEdit,\n  canDelete,\n  isEditing,\n  onStartEdit,\n  onCancelEdit,\n  onSave,\n  editSaving,\n  editTopContent,\n  saveLabel = 'Tallenna',\n  isConfirmingDelete,\n  onRequestDelete,\n  onConfirmDelete,\n  onCancelDelete,\n  likeState,\n  likeSaving,\n  onToggleLike,\n  isCopied,\n  onCopyLink,\n}: PostItemProps) {\n  const [editContent, setEditContent] = useState(post.content);\n  const [editImageUrl, setEditImageUrl] = useState(post.image_url || '');\n\n  const handleStartEdit = () => {\n    setEditContent(post.content);\n    setEditImageUrl(post.image_url || '');\n    onStartEdit();\n  };\n\n  const handleSave = () => onSave(post.id, editContent.trim(), editImageUrl);\n  const edited = hasBeenEdited(post);\n\n  return (\n    <div\n      id={`post-${post.id}`}\n      className={`py-6 border-b border-gray-200 last:border-b-0 scroll-mt-24 transition-colors ${\n        isHighlighted ? 'bg-yellow-50' : ''\n      }`}\n    >\n      <div className=\"flex gap-4\">\n        <Link href={`/profile/${post.author?.id}`} className=\"w-32 flex-shrink-0 text-center border-r-2 border-gray-200 pr-4 hover:opacity-80\">\n          {post.author?.profile_image_url ? (\n            <img src={profileThumb(post.author.profile_image_url)} alt={post.author.username} className=\"avatar-md mx-auto mb-2\" />\n          ) : (\n            <div className=\"avatar-md-fallback mx-auto mb-2\">\n              <User size={18} />\n            </div>\n          )}\n          <p className=\"font-bold text-sm mb-1 font-mono\">{post.author?.username}</p>\n          <p className=\"text-xs text-gray-400\">{formatPostDateTime(post.created_at)}</p>\n        </Link>\n\n        {post.deleted_at ? (\n          <div className=\"flex-1 flex items-center\">\n            <p className=\"text-gray-400 italic py-4\">T√§m√§ viesti on poistettu.</p>\n          </div>\n        ) : isEditing ? (\n          <PostEditForm\n            editTopContent={editTopContent}\n            editContent={editContent}\n            onEditContentChange={setEditContent}\n            editImageUrl={editImageUrl}\n            onEditImageUrlChange={setEditImageUrl}\n            onCancelEdit={onCancelEdit}\n            onSave={handleSave}\n            editSaving={editSaving}\n            saveLabel={saveLabel}\n          />\n        ) : (\n          <div className=\"flex-1\">\n            <PostContent\n              post={post}\n              hasBeenEdited={edited}\n              editedLabel={edited && post.updated_at ? formatPostDateTime(post.updated_at) : null}\n            />\n            <div className=\"mt-3 flex items-start justify-end gap-3\">\n              <PostActions\n                canEdit={canEdit}\n                canDelete={canDelete}\n                isOriginalPost={isOriginalPost}\n                isConfirmingDelete={isConfirmingDelete}\n                onStartEdit={handleStartEdit}\n                onRequestDelete={onRequestDelete}\n                onConfirmDelete={onConfirmDelete}\n                onCancelDelete={onCancelDelete}\n                likeState={likeState}\n                likeSaving={likeSaving}\n                onToggleLike={onToggleLike}\n                isCopied={isCopied}\n                onCopyLink={onCopyLink}\n              />\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/post/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/post/post.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/topic/TopicEditMetaFields.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/topic/TopicPageView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/topic/TopicPostsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/topic/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/forum/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/layout/AppShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/layout/Footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/layout/Navigation.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":74,"column":17,"nodeType":"JSXOpeningElement","endLine":74,"endColumn":122}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport Link from 'next/link';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { Users, Shield, ScrollText, User } from 'lucide-react';\nimport { profileThumb } from '@/lib/cloudinary';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\nimport { SearchInput } from '@/components/ui/SearchInput';\nimport type { FormEvent, JSX } from 'react';\n\nexport const Navigation = (): JSX.Element | null => {\n  const { currentUser, profile, logout } = useAuth();\n  const [searchQuery, setSearchQuery] = useState('');\n  const router = useRouter();\n  const showNavLinkIcons = UI_ICON_SETTINGS.showNavigationLinkIcons;\n\n  if (!currentUser || !profile) return null;\n\n  const handleSearch = (e: FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const trimmed = searchQuery.trim();\n    if (trimmed.length >= 2) {\n      router.push(`/search?q=${encodeURIComponent(trimmed)}`);\n      setSearchQuery('');\n    }\n  };\n\n  return (\n    <nav className=\"app-header app-nav p-4 border-b-1 border-gray-200\">\n      <div className=\"app-header-inner app-nav-inner flex items-center gap-4\">\n        <div className=\"app-nav-left flex items-center gap-8 flex-shrink-0\">\n          <Link href=\"/\" className=\"app-nav-logo hover:opacity-80\" aria-label=\"Freak On home\">\n            <picture>\n              <source media=\"(max-width: 480px)\" srcSet=\"/logo32-sm.gif\" />\n              <img src=\"/logo32.gif\" alt=\"Freak On logo\" className=\"app-nav-logo-image\" />\n            </picture>\n          </Link>\n\n          <div className=\"app-nav-links flex gap-2\">\n            <Link href=\"/members\" className=\"flex items-center gap-2 px-4 py-2 max-h-10 hover:bg-yellow-300 rounded\">\n              {showNavLinkIcons && <Users size={20} />}\n              Membut\n            </Link>\n            <Link href=\"/loki\" className=\"flex items-center gap-2 px-4 py-2 max-h-10 hover:bg-yellow-300 rounded\">\n              {showNavLinkIcons && <ScrollText size={20} />}\n              Loki\n            </Link>\n            {profile?.is_admin && (\n              <Link href=\"/admin\" className=\"flex items-center gap-2 px-4 py-2 max-h-10 hover:bg-yellow-300 rounded\">\n                {showNavLinkIcons && <Shield size={20} />}\n                Admin\n              </Link>\n            )}\n          </div>\n        </div>\n\n        <div className=\"app-nav-right flex items-center gap-2 flex-1 min-w-0 ml-4\">\n          <form onSubmit={handleSearch} className=\"app-nav-search flex-1 min-w-0\">\n            <SearchInput\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              placeholder=\"Hae...\"\n              inputClassName=\"w-full\"\n            />\n          </form>\n          <Link\n            href=\"/profile\"\n            className=\"flex items-center gap-2 px-4 py-2 max-h-10 bg-transparent text-gray-800 rounded hover:bg-yellow-300 flex-shrink-0\"\n          >\n            {showNavLinkIcons && (\n              profile.profile_image_url ? (\n                <img src={profileThumb(profile.profile_image_url)} alt={profile.username} className=\"avatar-inline-sm\" />\n              ) : (\n                <span className=\"avatar-inline-sm-fallback\">\n                  <User size={12} />\n                </span>\n              )\n            )}\n            <span className=\"bp-hide-sm\">{profile.username}</span>\n          </Link>\n          <button\n            onClick={logout}\n            className=\"flex items-center gap-2 px-4 py-2 text-md text-gray-600 rounded hover:bg-red-700 hover:text-white transition flex-shrink-0\"\n          >\n            Ulos\n          </button>\n        </div>\n      </div>\n    </nav>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/profile/EditProfileForm.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'EditProfileForm' has a complexity of 19. Maximum allowed is 12.","line":16,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":16,"endColumn":32},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 16. Maximum allowed is 12.","line":100,"column":60,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":100,"endColumn":62},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":292,"column":19,"nodeType":"JSXOpeningElement","endLine":292,"endColumn":129},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (462). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":463,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/Input';\nimport { Alert } from '@/components/ui/Alert';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { CldUploadWidget } from 'next-cloudinary';\nimport { Save, Camera, X, Link as LinkIcon, User, Lock, Pencil } from 'lucide-react';\nimport { extractSecureUrl, profileThumb } from '@/lib/cloudinary';\nimport { getCloudinaryUploadPresetOrThrow, getProfileUploadWidgetOptions } from '@/lib/cloudinaryWidget';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\nimport { getFirstValidationError, rules, validate } from '@/lib/validation';\n\nexport function EditProfileForm() {\n  const { currentUser, profile, supabase, refreshProfile } = useAuth();\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n  const uploadPreset = getCloudinaryUploadPresetOrThrow();\n  const typedProfile = profile as {\n    username?: string;\n    display_name?: string;\n    profile_image_url?: string;\n    signature?: string;\n    show_signature?: boolean;\n    link_url?: string;\n    link_description?: string;\n    is_admin?: boolean;\n    realtime_updates_enabled?: boolean;\n  } | null;\n\n  const [username, setUsername] = useState('');\n  const [displayName, setDisplayName] = useState('');\n  const [email, setEmail] = useState('');\n  const [profileImageUrl, setProfileImageUrl] = useState('');\n  const [signature, setSignature] = useState('');\n  const [showSignature, setShowSignature] = useState(true);\n  const [linkUrl, setLinkUrl] = useState('');\n  const [linkDescription, setLinkDescription] = useState('');\n  const [success, setSuccess] = useState('');\n  const [error, setError] = useState('');\n  const [saving, setSaving] = useState(false);\n  const [showUsernameConfirm, setShowUsernameConfirm] = useState(false);\n  const [newPassword, setNewPassword] = useState('');\n  const [confirmPassword, setConfirmPassword] = useState('');\n  const [passwordError, setPasswordError] = useState('');\n  const [passwordSuccess, setPasswordSuccess] = useState('');\n  const [savingPassword, setSavingPassword] = useState(false);\n\n  const isAdmin = typedProfile?.is_admin === true;\n  const usernameChanged = username.trim() !== (typedProfile?.username || '').trim();\n\n  useEffect(() => {\n    if (typedProfile) {\n      setUsername(typedProfile.username || '');\n      setDisplayName(typedProfile.display_name || '');\n      setProfileImageUrl(typedProfile.profile_image_url || '');\n      setSignature(typedProfile.signature || '');\n      setShowSignature(typedProfile.show_signature ?? true);\n      setLinkUrl(typedProfile.link_url || '');\n      setLinkDescription(typedProfile.link_description || '');\n    }\n  }, [typedProfile]);\n\n  useEffect(() => {\n    if (currentUser) {\n      setEmail(currentUser.email || '');\n    }\n  }, [currentUser]);\n\n  const validateProfileForm = () => {\n    setError('');\n    setSuccess('');\n\n    const validation = validate(\n      { username: username.trim(), linkUrl: linkUrl.trim() },\n      {\n        username: [\n          rules.custom(\n            (value: unknown) => {\n              const v = typeof value === 'string' ? value : '';\n              return !isAdmin || v.length >= 3;\n            },\n            'K√§ytt√§j√§tunnuksen tulee olla v√§hint√§√§n 3 merkki√§'\n          ),\n        ],\n        linkUrl: [\n          rules.httpUrlOptional('Linkin pit√§√§ alkaa http:// tai https://'),\n        ],\n      }\n    );\n    const firstError = getFirstValidationError(validation);\n    if (firstError) {\n      setError(firstError);\n      return false;\n    }\n    return true;\n  };\n\n  const saveProfile = async (allowUsernameChange: boolean) => {\n    if (!currentUser) return;\n    setSaving(true);\n\n    try {\n      const updates: {\n        username?: string;\n        display_name: string | null;\n        profile_image_url: string | null;\n        signature: string | null;\n        show_signature: boolean;\n        realtime_updates_enabled: boolean;\n        link_url: string | null;\n        link_description: string | null;\n      } = {\n        display_name: displayName.trim() || null,\n        profile_image_url: profileImageUrl || null,\n        signature: signature.trim() || null,\n        show_signature: showSignature,\n        realtime_updates_enabled: typedProfile?.realtime_updates_enabled ?? false,\n        link_url: linkUrl.trim() || null,\n        link_description: linkDescription.trim() || null,\n      };\n\n      if (allowUsernameChange && isAdmin) {\n        updates.username = username.trim();\n      }\n\n      const { error: profileError } = await supabase\n        .from('profiles')\n        .update(updates)\n        .eq('id', currentUser.id);\n\n      if (profileError) throw profileError;\n\n      if (email !== currentUser.email) {\n        const { error: emailError } = await supabase.auth.updateUser({ email });\n        if (emailError) throw emailError;\n      }\n\n      await refreshProfile();\n      setSuccess('Profiili p√§ivitetty!');\n    } catch (err: unknown) {\n      const message = err instanceof Error ? err.message : 'Profiilin p√§ivitys ep√§onnistui';\n      setError(message);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleSaveProfile = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!validateProfileForm()) return;\n\n    if (isAdmin && usernameChanged) {\n      setShowUsernameConfirm(true);\n      return;\n    }\n\n    await saveProfile(false);\n  };\n\n  const handleConfirmUsernameChange = async () => {\n    setShowUsernameConfirm(false);\n    if (!validateProfileForm()) return;\n    await saveProfile(true);\n  };\n\n  const handleChangePassword = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setPasswordError('');\n    setPasswordSuccess('');\n\n    const validation = validate(\n      { newPassword, confirmPassword },\n      {\n        newPassword: [\n          rules.minLength(8, 'Salasanan tulee olla v√§hint√§√§n 8 merkki√§'),\n          rules.passwordStrong('Salasanassa tulee olla isoja ja pieni√§ kirjaimia sek√§ numeroita'),\n        ],\n        confirmPassword: [\n          rules.equalsField('newPassword', 'Salasanat eiv√§t t√§sm√§√§'),\n        ],\n      }\n    );\n    const firstError = getFirstValidationError(validation);\n    if (firstError) {\n      setPasswordError(firstError);\n      return;\n    }\n\n    setSavingPassword(true);\n\n    try {\n      const { error: passwordUpdateError } = await supabase.auth.updateUser({ password: newPassword });\n      if (passwordUpdateError) throw passwordUpdateError;\n\n      setPasswordSuccess('Salasana vaihdettu!');\n      setNewPassword('');\n      setConfirmPassword('');\n    } catch (err: unknown) {\n      const message = err instanceof Error ? err.message : 'Salasanan vaihto ep√§onnistui';\n      setPasswordError(message);\n    } finally {\n      setSavingPassword(false);\n    }\n  };\n\n  return (\n    <>\n      <Card className=\"mb-6\">\n        <h2 className=\"card-title flex items-center gap-2\">\n          {showHeaderIcons && <Pencil size={20} className=\"text-yellow-600\" />}\n          Muokkaa profiilia\n        </h2>\n\n        {error && <Alert variant=\"error\">{error}</Alert>}\n        {success && <Alert variant=\"success\">{success}</Alert>}\n\n        <form onSubmit={handleSaveProfile} className=\"space-y-4\">\n          <div>\n            <label htmlFor=\"username\" className=\"flex items-center gap-2 text-sm font-medium mb-1\">\n              <span>K√§ytt√§j√§tunnus</span>\n              {isAdmin && (\n                <span className=\"inline-flex items-center rounded bg-gray-200 text-gray-700 px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide\">\n                  Vain admin\n                </span>\n              )}\n            </label>\n            <Input\n              id=\"username\"\n              value={username}\n              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setUsername(e.target.value)}\n              required\n              minLength={3}\n              maxLength={20}\n              disabled={!isAdmin}\n              className={!isAdmin ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''}\n            />\n            <p className=\"text-muted-xs mt-1\">\n              {isAdmin\n                ? 'K√§ytt√§j√§tunnuksen muutos vaatii erillisen vahvistuksen.'\n                : 'K√§ytt√§j√§tunnusta voi muuttaa vain admin.'}\n            </p>\n          </div>\n\n          <div>\n            <label htmlFor=\"displayName\" className=\"form-label\">\n              Nimi\n            </label>\n            <Input\n              id=\"displayName\"\n              value={displayName}\n              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setDisplayName(e.target.value)}\n              placeholder=\"Valinnainen n√§ytt√∂nimi\"\n              maxLength={50}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"signature\" className=\"form-label\">\n              Allekirjoitus\n            </label>\n            <textarea\n              id=\"signature\"\n              value={signature}\n              onChange={(e) => setSignature(e.target.value)}\n              className=\"field-textarea field-textarea--profile-signature\"\n              placeholder=\"N√§kyy viestien alla\"\n              maxLength={200}\n            />\n            <div className=\"flex items-center gap-2 mt-2\">\n              <input\n                type=\"checkbox\"\n                id=\"showSignature\"\n                checked={showSignature}\n                onChange={(e) => setShowSignature(e.target.checked)}\n                className=\"w-4 h-4 accent-yellow-400\"\n              />\n              <label htmlFor=\"showSignature\" className=\"text-sm text-gray-600\">\n                N√§yt√§ allekirjoitus viesteiss√§\n              </label>\n            </div>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium mb-2\">\n              Profiilikuva\n            </label>\n            <div className=\"flex items-center gap-4\">\n              {profileImageUrl ? (\n                <div className=\"relative\">\n                  <img src={profileThumb(profileImageUrl)} alt=\"Profiilikuva\" className=\"w-20 h-20 rounded-none object-cover\" />\n                  <button\n                    type=\"button\"\n                    onClick={() => setProfileImageUrl('')}\n                    className=\"absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600\"\n                  >\n                    <X size={14} />\n                  </button>\n                </div>\n              ) : (\n                <span className=\"w-20 h-20 rounded-full bg-gray-200 text-gray-500 inline-flex items-center justify-center\">\n                  <User size={40} />\n                </span>\n              )}\n              <CldUploadWidget\n                uploadPreset={uploadPreset}\n                options={getProfileUploadWidgetOptions()}\n                onSuccess={(result: unknown) => {\n                  const secureUrl = extractSecureUrl(result);\n                  if (secureUrl) setProfileImageUrl(secureUrl);\n                }}\n              >\n                {({ open }) => (\n                  <Button type=\"button\" variant=\"outline\" className=\"flex items-center gap-2\" onClick={() => open()}>\n                    <Camera size={16} />\n                    {profileImageUrl ? 'Vaihda kuva' : 'Lataa kuva'}\n                  </Button>\n                )}\n              </CldUploadWidget>\n            </div>\n            {!profileImageUrl && <p className=\"text-xs text-gray-400 mt-1\">Lis√§√§ profiilikuva n√§ky√§ksesi muille.</p>}\n          </div>\n\n          <div>\n            <label htmlFor=\"email\" className=\"form-label\">\n              S√§hk√∂posti\n            </label>\n            <Input\n              id=\"email\"\n              type=\"email\"\n              value={email}\n              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setEmail(e.target.value)}\n              required\n            />\n          </div>\n\n          <div>\n            <label className=\"form-label inline-flex items-center gap-1\">\n              <LinkIcon size={14} />\n              Linkki\n            </label>\n            <div className=\"space-y-2\">\n              <Input\n                id=\"linkUrl\"\n                type=\"url\"\n                value={linkUrl}\n                onChange={(e: React.ChangeEvent<HTMLInputElement>) => setLinkUrl(e.target.value)}\n                placeholder=\"https://...\"\n              />\n              <Input\n                id=\"linkDescription\"\n                value={linkDescription}\n                onChange={(e: React.ChangeEvent<HTMLInputElement>) => setLinkDescription(e.target.value)}\n                placeholder=\"Linkin kuvaus (esim. Oma blogi)\"\n                maxLength={50}\n              />\n            </div>\n          </div>\n\n          <Button\n            type=\"submit\"\n            variant=\"primary\"\n            disabled={saving}\n            className=\"flex items-center gap-2\"\n          >\n            <Save size={16} />\n            {saving ? 'Tallennetaan...' : 'Tallenna'}\n          </Button>\n        </form>\n      </Card>\n\n      <Card className=\"mt-6 mb-6\">\n        <h2 className=\"card-title flex items-center gap-2\">\n          {showHeaderIcons && <Lock size={20} className=\"text-yellow-600\" />}\n          Vaihda salasana\n        </h2>\n\n        {passwordError && <Alert variant=\"error\">{passwordError}</Alert>}\n        {passwordSuccess && <Alert variant=\"success\">{passwordSuccess}</Alert>}\n\n        <form onSubmit={handleChangePassword} className=\"space-y-4\">\n          <div>\n            <label htmlFor=\"newPassword\" className=\"form-label\">\n              Uusi salasana\n            </label>\n            <Input\n              id=\"newPassword\"\n              type=\"password\"\n              value={newPassword}\n              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setNewPassword(e.target.value)}\n              required\n              minLength={8}\n              placeholder=\"V√§hint√§√§n 8 merkki√§, isoja/pieni√§ kirjaimia ja numeroita\"\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"confirmPassword\" className=\"form-label\">\n              Vahvista salasana\n            </label>\n            <Input\n              id=\"confirmPassword\"\n              type=\"password\"\n              value={confirmPassword}\n              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setConfirmPassword(e.target.value)}\n              required\n              minLength={8}\n              placeholder=\"Kirjoita salasana uudelleen\"\n            />\n          </div>\n\n          <Button\n            type=\"submit\"\n            variant=\"primary\"\n            disabled={savingPassword}\n            className=\"flex items-center gap-2\"\n          >\n            <Lock size={16} />\n            {savingPassword ? 'Vaihdetaan...' : 'Vaihda salasana'}\n          </Button>\n        </form>\n      </Card>\n\n      {showUsernameConfirm && (\n        <div className=\"modal-overlay\">\n          <div className=\"modal-panel modal-panel-md\">\n            <h3 className=\"text-lg font-bold mb-2\">Vahvista k√§ytt√§j√§tunnuksen muutos</h3>\n            <p className=\"text-sm text-gray-600 mb-4\">\n              Olet muuttamassa k√§ytt√§j√§tunnusta:\n              <br />\n              <span className=\"font-semibold text-gray-800\">{typedProfile?.username}</span>\n              {' -> '}\n              <span className=\"font-semibold text-gray-800\">{username.trim()}</span>\n            </p>\n            <p className=\"text-muted-xs mb-5\">\n              T√§m√§ muutos n√§kyy kaikkialla foorumilla. Haluatko varmasti jatkaa?\n            </p>\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setShowUsernameConfirm(false)}\n                disabled={saving}\n              >\n                Peruuta\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"primary\"\n                onClick={handleConfirmUsernameChange}\n                disabled={saving}\n              >\n                Vahvista muutos\n              </Button>\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/profile/HdSettingsPanel.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'HdSettingsPanel' has a complexity of 14. Maximum allowed is 12.","line":15,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":15,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { Alert } from '@/components/ui/Alert';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Palette, Music2, Sparkles } from 'lucide-react';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\n\ninterface HdSettingsPanelProps {\n  initialRetroEnabled: boolean;\n  initialMidiEnabled: boolean;\n}\n\nexport function HdSettingsPanel({ initialRetroEnabled, initialMidiEnabled }: HdSettingsPanelProps) {\n  const { currentUser, supabase, refreshProfile } = useAuth();\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n  const showSettingActionIcons = UI_ICON_SETTINGS.showSettingActionIcons;\n\n  const [retroEnabled, setRetroEnabled] = useState(initialRetroEnabled);\n  const [midiEnabled, setMidiEnabled] = useState(initialMidiEnabled);\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n\n  const handleRetroToggle = async (nextValue: boolean) => {\n    if (!currentUser) return;\n\n    setError('');\n    setSuccess('');\n    setRetroEnabled(nextValue);\n    setSaving(true);\n\n    try {\n      const { error: updateError } = await supabase\n        .from('profiles')\n        .update({ retro_enabled: nextValue })\n        .eq('id', currentUser.id);\n\n      if (updateError) throw updateError;\n\n      await refreshProfile();\n      setSuccess('Asetukset tallennettu!');\n    } catch (err: unknown) {\n      setRetroEnabled((prev) => !prev);\n      const message = err instanceof Error ? err.message : 'Asetusten tallennus ep√§onnistui';\n      setError(message);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleMidiToggle = async (nextValue: boolean) => {\n    if (!currentUser) return;\n\n    setError('');\n    setSuccess('');\n    setMidiEnabled(nextValue);\n    setSaving(true);\n\n    try {\n      const { error: updateError } = await supabase\n        .from('profiles')\n        .update({ midi_enabled: nextValue })\n        .eq('id', currentUser.id);\n\n      if (updateError) throw updateError;\n\n      await refreshProfile();\n      setSuccess('Asetukset tallennettu!');\n    } catch (err: unknown) {\n      setMidiEnabled((prev) => !prev);\n      const message = err instanceof Error ? err.message : 'Asetusten tallennus ep√§onnistui';\n      setError(message);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  return (\n    <Card className=\"mb-6\">\n      <h2 className=\"card-title flex items-center gap-2\">\n        {showHeaderIcons && <Sparkles size={20} className=\"text-yellow-600\" />}\n        High definition graphics &amp; audio\n      </h2>\n\n      {error && <Alert variant=\"error\">{error}</Alert>}\n      {success && <Alert variant=\"success\">{success}</Alert>}\n\n      <section className=\"section-block\">\n        <div className=\"mt-4 flex items-center justify-between gap-3\">\n          <div className=\"flex items-center gap-3\">\n            {showSettingActionIcons && <Palette size={20} className=\"text-gray-600\" />}\n            <div>\n              <p className=\"font-medium\">Retrolasit p√§√§h√§n</p>\n              <p className=\"text-muted-sm\">\n                {retroEnabled ? 'CRT-suodatin k√§yt√∂ss√§' : 'Normaali n√§kym√§ k√§yt√∂ss√§'}\n              </p>\n            </div>\n          </div>\n          <button\n            id=\"retroEnabled\"\n            type=\"button\"\n            role=\"switch\"\n            aria-checked={retroEnabled}\n            aria-label=\"Retro\"\n            disabled={saving}\n            onClick={() => handleRetroToggle(!retroEnabled)}\n            className={`relative inline-flex h-7 w-12 items-center rounded-full transition ${\n              retroEnabled ? 'bg-green-500' : 'bg-gray-300'\n            } ${saving ? 'opacity-50 cursor-not-allowed' : ''}`}\n          >\n            <span\n              className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${\n                retroEnabled ? 'translate-x-6' : 'translate-x-1'\n              }`}\n            />\n          </button>\n        </div>\n\n        <div className=\"mt-4 flex items-center justify-between gap-3\">\n          <div className=\"flex items-center gap-3\">\n            {showSettingActionIcons && <Music2 size={20} className=\"text-gray-600\" />}\n            <div>\n              <p className=\"font-medium\">.mid</p>\n              <p className=\"text-muted-sm\">\n                {midiEnabled ? 'Styge soi... ep√§vireisesti' : 'You died.'}\n              </p>\n            </div>\n          </div>\n          <button\n            id=\"midiEnabled\"\n            type=\"button\"\n            role=\"switch\"\n            aria-checked={midiEnabled}\n            aria-label=\".mid\"\n            disabled={saving}\n            onClick={() => handleMidiToggle(!midiEnabled)}\n            className={`relative inline-flex h-7 w-12 items-center rounded-full transition ${\n              midiEnabled ? 'bg-green-500' : 'bg-gray-300'\n            } ${saving ? 'opacity-50 cursor-not-allowed' : ''}`}\n          >\n            <span\n              className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${\n                midiEnabled ? 'translate-x-6' : 'translate-x-1'\n              }`}\n            />\n          </button>\n        </div>\n      </section>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/profile/ProfileStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/profile/SettingsPanel.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'SettingsPanel' has a complexity of 21. Maximum allowed is 12.","line":67,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":67,"endColumn":30},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":182,"column":44,"nodeType":null,"messageId":"refactorFunction","endLine":182,"endColumn":46},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":224,"column":46,"nodeType":null,"messageId":"refactorFunction","endLine":224,"endColumn":48},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 14. Maximum allowed is 12.","line":224,"column":46,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":224,"endColumn":48},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 22 to the 15 allowed.","line":278,"column":34,"nodeType":null,"messageId":"refactorFunction","endLine":278,"endColumn":36},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 25. Maximum allowed is 12.","line":278,"column":34,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":278,"endColumn":36},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (579). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":580,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useMemo, useState } from 'react';\nimport { Card } from '@/components/ui/Card';\nimport { Alert } from '@/components/ui/Alert';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Settings2, RefreshCw, EyeOff, Images } from 'lucide-react';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\nimport { TokenInput, type TokenItem, type TokenOption } from '@/components/ui/TokenInput';\n\ninterface SettingsPanelProps {\n  initialRealtimeEnabled: boolean;\n  initialLegacyTagIconsEnabled: boolean;\n  initialHiddenTagIds: number[];\n  initialHiddenTagGroupIds: number[];\n}\n\ninterface TagHit {\n  id: number;\n  name: string;\n  slug: string;\n  icon?: string;\n}\n\ninterface TagGroupHit {\n  group_id: number;\n  group_name: string;\n  group_slug: string;\n  member_count: number;\n}\n\ninterface HiddenImpactRow {\n  hidden_topic_count: number;\n  total_topic_count: number;\n  hidden_message_count: number;\n  total_message_count: number;\n  hidden_message_percent: number;\n}\n\nfunction normalizeIds(values: number[]): number[] {\n  return Array.from(new Set(values.filter((value) => Number.isFinite(value) && value > 0)));\n}\n\nfunction toErrorMessage(err: unknown, fallback: string): string {\n  if (err instanceof Error && err.message.trim()) return err.message;\n  if (err && typeof err === 'object') {\n    const maybeMessage = (err as { message?: unknown }).message;\n    if (typeof maybeMessage === 'string' && maybeMessage.trim()) return maybeMessage;\n  }\n  return fallback;\n}\n\nfunction parseImpactRow(data: unknown): HiddenImpactRow | null {\n  const row = Array.isArray(data)\n    ? (data[0] as Record<string, unknown> | undefined)\n    : (data as Record<string, unknown> | null);\n  if (!row || typeof row !== 'object') return null;\n  return {\n    hidden_topic_count: Number(row.hidden_topic_count ?? 0),\n    total_topic_count: Number(row.total_topic_count ?? 0),\n    hidden_message_count: Number(row.hidden_message_count ?? 0),\n    total_message_count: Number(row.total_message_count ?? 0),\n    hidden_message_percent: Number(row.hidden_message_percent ?? 0),\n  };\n}\n\nexport function SettingsPanel({\n  initialRealtimeEnabled,\n  initialLegacyTagIconsEnabled,\n  initialHiddenTagIds,\n  initialHiddenTagGroupIds,\n}: SettingsPanelProps) {\n  const { currentUser, supabase, refreshProfile } = useAuth();\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n  const showSettingActionIcons = UI_ICON_SETTINGS.showSettingActionIcons;\n  const showSectionHeaderIcons = UI_ICON_SETTINGS.showSectionHeaderIcons;\n\n  const [realtimeUpdatesEnabled, setRealtimeUpdatesEnabled] = useState(initialRealtimeEnabled);\n  const [legacyTagIconsEnabled, setLegacyTagIconsEnabled] = useState(initialLegacyTagIconsEnabled);\n  const [hiddenTagIds, setHiddenTagIds] = useState(() => normalizeIds(initialHiddenTagIds));\n  const [hiddenTagGroupIds, setHiddenTagGroupIds] = useState(() => normalizeIds(initialHiddenTagGroupIds));\n  const [hiddenTagById, setHiddenTagById] = useState<Record<number, TagHit>>({});\n  const [hiddenGroupById, setHiddenGroupById] = useState<Record<number, TagGroupHit>>({});\n\n  const [hideQuery, setHideQuery] = useState('');\n  const [hideOptions, setHideOptions] = useState<TokenOption[]>([]);\n  const [loadingHideOptions, setLoadingHideOptions] = useState(false);\n  const [hiddenImpact, setHiddenImpact] = useState<HiddenImpactRow | null>(null);\n  const [loadingHiddenImpact, setLoadingHiddenImpact] = useState(false);\n  const [hiddenImpactError, setHiddenImpactError] = useState('');\n\n  const [savingSettings, setSavingSettings] = useState(false);\n  const [savingHiddenFilters, setSavingHiddenFilters] = useState(false);\n  const [settingsError, setSettingsError] = useState('');\n  const [settingsSuccess, setSettingsSuccess] = useState('');\n\n  const saveHiddenFilters = async (nextTagIds: number[], nextGroupIds: number[]) => {\n    if (!currentUser) return;\n\n    const normalizedTagIds = normalizeIds(nextTagIds);\n    const normalizedGroupIds = normalizeIds(nextGroupIds);\n\n    setSavingHiddenFilters(true);\n    setSettingsError('');\n    setSettingsSuccess('');\n\n    try {\n      const { error } = await supabase\n        .from('profiles')\n        .update({\n          hidden_tag_ids: normalizedTagIds,\n          hidden_tag_group_ids: normalizedGroupIds,\n        })\n        .eq('id', currentUser.id);\n\n      if (error) throw error;\n\n      setHiddenTagIds(normalizedTagIds);\n      setHiddenTagGroupIds(normalizedGroupIds);\n      await refreshProfile();\n      setSettingsSuccess('Asetukset tallennettu!');\n    } catch (err: unknown) {\n      setSettingsError(toErrorMessage(err, 'Asetusten tallennus ep√§onnistui'));\n    } finally {\n      setSavingHiddenFilters(false);\n    }\n  };\n\n  const handleRealtimeToggle = async (nextValue: boolean) => {\n    if (!currentUser) return;\n\n    setSettingsError('');\n    setSettingsSuccess('');\n    setRealtimeUpdatesEnabled(nextValue);\n    setSavingSettings(true);\n\n    try {\n      const { error } = await supabase\n        .from('profiles')\n        .update({ realtime_updates_enabled: nextValue })\n        .eq('id', currentUser.id);\n\n      if (error) throw error;\n\n      await refreshProfile();\n      setSettingsSuccess('Asetukset tallennettu!');\n    } catch (err: unknown) {\n      setRealtimeUpdatesEnabled((prev) => !prev);\n      setSettingsError(toErrorMessage(err, 'Asetusten tallennus ep√§onnistui'));\n    } finally {\n      setSavingSettings(false);\n    }\n  };\n\n  const handleLegacyTagIconsToggle = async (nextValue: boolean) => {\n    if (!currentUser) return;\n\n    setSettingsError('');\n    setSettingsSuccess('');\n    setLegacyTagIconsEnabled(nextValue);\n    setSavingSettings(true);\n\n    try {\n      const { error } = await supabase\n        .from('profiles')\n        .update({ legacy_tag_icons_enabled: nextValue })\n        .eq('id', currentUser.id);\n\n      if (error) throw error;\n\n      await refreshProfile();\n      setSettingsSuccess('Asetukset tallennettu!');\n    } catch (err: unknown) {\n      setLegacyTagIconsEnabled((prev) => !prev);\n      setSettingsError(toErrorMessage(err, 'Asetusten tallennus ep√§onnistui'));\n    } finally {\n      setSavingSettings(false);\n    }\n  };\n\n  useEffect(() => {\n    const hydrateSelectedLabels = async () => {\n      if (hiddenTagIds.length > 0) {\n        const params = new URLSearchParams();\n        params.set('status', 'approved');\n        params.set('ids', hiddenTagIds.join(','));\n        params.set('limit', String(Math.max(20, hiddenTagIds.length + 5)));\n\n        const tagRes = await fetch(`/api/tags?${params.toString()}`, { cache: 'no-store' });\n        if (tagRes.ok) {\n          const payload = (await tagRes.json()) as { tags?: TagHit[] };\n          const next: Record<number, TagHit> = {};\n          for (const tag of payload.tags || []) {\n            next[tag.id] = tag;\n          }\n          setHiddenTagById((prev) => ({ ...prev, ...next }));\n        }\n      }\n\n      if (hiddenTagGroupIds.length > 0) {\n        const { data } = await supabase.rpc('get_tag_groups_with_members');\n        if (Array.isArray(data)) {\n          const next: Record<number, TagGroupHit> = {};\n          for (const row of data as Record<string, unknown>[]) {\n            const id = Number(row.group_id);\n            if (!hiddenTagGroupIds.includes(id)) continue;\n            next[id] = {\n              group_id: id,\n              group_name: String(row.group_name ?? ''),\n              group_slug: String(row.group_slug ?? ''),\n              member_count: Number(row.member_count ?? 0),\n            };\n          }\n          setHiddenGroupById((prev) => ({ ...prev, ...next }));\n        }\n      }\n    };\n\n    void hydrateSelectedLabels();\n  }, [hiddenTagIds, hiddenTagGroupIds, supabase]);\n\n  useEffect(() => {\n    const query = hideQuery.trim();\n    const timer = window.setTimeout(async () => {\n      if (!query) {\n        setHideOptions([]);\n        return;\n      }\n\n      setLoadingHideOptions(true);\n      try {\n        const [tagRes, groupRes] = await Promise.all([\n          fetch(`/api/tags?status=approved&query=${encodeURIComponent(query)}&limit=10`, { cache: 'no-store' }),\n          supabase.rpc('search_tag_groups', {\n            input_query: query,\n            input_limit: 8,\n          }),\n        ]);\n\n        const options: TokenOption[] = [];\n\n        if (tagRes.ok) {\n          const payload = (await tagRes.json()) as { tags?: TagHit[] };\n          for (const tag of payload.tags || []) {\n            if (hiddenTagIds.includes(tag.id)) continue;\n            options.push({\n              id: `tag:${tag.id}`,\n              label: tag.name,\n              icon: tag.icon || 'üè∑Ô∏è',\n            });\n          }\n        }\n\n        if (Array.isArray(groupRes.data)) {\n          for (const row of groupRes.data as Record<string, unknown>[]) {\n            const groupId = Number(row.group_id);\n            if (!Number.isFinite(groupId) || groupId <= 0) continue;\n            if (hiddenTagGroupIds.includes(groupId)) continue;\n            options.push({\n              id: `group:${groupId}`,\n              label: String(row.group_name ?? ''),\n              icon: 'üìö',\n              meta: `${Number(row.member_count ?? 0)} aihetta`,\n            });\n          }\n        }\n\n        setHideOptions(options);\n      } finally {\n        setLoadingHideOptions(false);\n      }\n    }, 180);\n\n    return () => window.clearTimeout(timer);\n  }, [hideQuery, hiddenTagIds, hiddenTagGroupIds, supabase]);\n\n  useEffect(() => {\n    const fetchImpact = async () => {\n      setLoadingHiddenImpact(true);\n      setHiddenImpactError('');\n      try {\n        const { data, error } = await supabase.rpc('get_hidden_topic_filter_impact', {\n          input_hidden_tag_ids: hiddenTagIds,\n          input_hidden_tag_group_ids: hiddenTagGroupIds,\n        });\n        if (!error) {\n          const parsed = parseImpactRow(data);\n          if (parsed) {\n            setHiddenImpact(parsed);\n            return;\n          }\n        }\n\n        const { data: canonicalDirectData, error: canonicalDirectError } = await supabase.rpc('resolve_canonical_tag_ids', {\n          input_tag_ids: hiddenTagIds,\n        });\n        if (canonicalDirectError) throw canonicalDirectError;\n\n        let groupMemberIds: number[] = [];\n        if (hiddenTagGroupIds.length > 0) {\n          const { data: membersData, error: membersError } = await supabase\n            .from('tag_group_members')\n            .select('tag_id')\n            .in('group_id', hiddenTagGroupIds);\n          if (membersError) throw membersError;\n          groupMemberIds = (membersData || [])\n            .map((row) => Number(row.tag_id))\n            .filter((value) => Number.isFinite(value) && value > 0);\n        }\n\n        const { data: canonicalGroupData, error: canonicalGroupError } = await supabase.rpc('resolve_canonical_tag_ids', {\n          input_tag_ids: groupMemberIds,\n        });\n        if (canonicalGroupError) throw canonicalGroupError;\n\n        const excludedTagIds = Array.from(\n          new Set([\n            ...(Array.isArray(canonicalDirectData) ? canonicalDirectData : []),\n            ...(Array.isArray(canonicalGroupData) ? canonicalGroupData : []),\n          ])\n        )\n          .map((value) => Number(value))\n          .filter((value) => Number.isFinite(value) && value > 0);\n\n        const { count: totalTopicCount, error: totalTopicError } = await supabase\n          .from('topics')\n          .select('id', { count: 'exact', head: true });\n        if (totalTopicError) throw totalTopicError;\n\n        const { count: totalMessageCount, error: totalMessageError } = await supabase\n          .from('posts')\n          .select('id', { count: 'exact', head: true })\n          .is('deleted_at', null);\n        if (totalMessageError) throw totalMessageError;\n\n        if (excludedTagIds.length === 0) {\n          setHiddenImpact({\n            hidden_topic_count: 0,\n            total_topic_count: totalTopicCount || 0,\n            hidden_message_count: 0,\n            total_message_count: totalMessageCount || 0,\n            hidden_message_percent: 0,\n          });\n          return;\n        }\n\n        const { data: topicTagRows, error: topicTagError } = await supabase\n          .from('topic_tags')\n          .select('topic_id')\n          .in('tag_id', excludedTagIds);\n        if (topicTagError) throw topicTagError;\n\n        const hiddenTopicIds = Array.from(\n          new Set(\n            (topicTagRows || [])\n              .map((row) => Number(row.topic_id))\n              .filter((value) => Number.isFinite(value) && value > 0)\n          )\n        );\n\n        let hiddenMessageCount = 0;\n        if (hiddenTopicIds.length > 0) {\n          const chunkSize = 500;\n          for (let i = 0; i < hiddenTopicIds.length; i += chunkSize) {\n            const chunk = hiddenTopicIds.slice(i, i + chunkSize);\n            const { count: chunkCount, error: chunkError } = await supabase\n              .from('posts')\n              .select('id', { count: 'exact', head: true })\n              .in('topic_id', chunk)\n              .is('deleted_at', null);\n            if (chunkError) throw chunkError;\n            hiddenMessageCount += chunkCount || 0;\n          }\n        }\n\n        const safeTotalMessageCount = totalMessageCount || 0;\n        const hiddenPercent = safeTotalMessageCount > 0\n          ? Number(((hiddenMessageCount / safeTotalMessageCount) * 100).toFixed(1))\n          : 0;\n\n        setHiddenImpact({\n          hidden_topic_count: hiddenTopicIds.length,\n          total_topic_count: totalTopicCount || 0,\n          hidden_message_count: hiddenMessageCount,\n          total_message_count: safeTotalMessageCount,\n          hidden_message_percent: hiddenPercent,\n        });\n      } catch (err: unknown) {\n        setHiddenImpactError(toErrorMessage(err, 'Piilotusvaikutuksen laskenta ep√§onnistui'));\n        setHiddenImpact({\n          hidden_topic_count: 0,\n          total_topic_count: 0,\n          hidden_message_count: 0,\n          total_message_count: 0,\n          hidden_message_percent: 0,\n        });\n      } finally {\n        setLoadingHiddenImpact(false);\n      }\n    };\n\n    void fetchImpact();\n  }, [hiddenTagIds, hiddenTagGroupIds, supabase]);\n\n  const hiddenTokens = useMemo<TokenItem[]>(() => {\n    const tagTokens = hiddenTagIds.map((tagId) => {\n      const tag = hiddenTagById[tagId];\n      return {\n        id: `tag:${tagId}`,\n        label: tag?.name || `Tagi #${tagId}`,\n        icon: tag?.icon || 'üè∑Ô∏è',\n      };\n    });\n\n    const groupTokens = hiddenTagGroupIds.map((groupId) => {\n      const group = hiddenGroupById[groupId];\n      return {\n        id: `group:${groupId}`,\n        label: group?.group_name || `Ryhm√§ #${groupId}`,\n        icon: 'üìö',\n      };\n    });\n\n    return [...tagTokens, ...groupTokens];\n  }, [hiddenTagById, hiddenGroupById, hiddenTagGroupIds, hiddenTagIds]);\n\n  const handleSelectHiddenOption = (option: TokenOption) => {\n    const [kind, rawId] = String(option.id).split(':');\n    const id = Number.parseInt(rawId, 10);\n    if (!Number.isFinite(id) || id <= 0) return;\n\n    setSettingsError('');\n    setSettingsSuccess('');\n    setHideQuery('');\n\n    if (kind === 'tag') {\n      void saveHiddenFilters([...hiddenTagIds, id], hiddenTagGroupIds);\n      return;\n    }\n\n    if (kind === 'group') {\n      void saveHiddenFilters(hiddenTagIds, [...hiddenTagGroupIds, id]);\n    }\n  };\n\n  const handleRemoveHiddenToken = (id: number | string) => {\n    const [kind, rawId] = String(id).split(':');\n    const numericId = Number.parseInt(rawId, 10);\n    if (!Number.isFinite(numericId) || numericId <= 0) return;\n\n    setSettingsError('');\n    setSettingsSuccess('');\n\n    if (kind === 'tag') {\n      void saveHiddenFilters(hiddenTagIds.filter((tagId) => tagId !== numericId), hiddenTagGroupIds);\n      return;\n    }\n\n    if (kind === 'group') {\n      void saveHiddenFilters(hiddenTagIds, hiddenTagGroupIds.filter((groupId) => groupId !== numericId));\n    }\n  };\n\n  return (\n    <Card className=\"mb-6\">\n      <h2 className=\"card-title flex items-center gap-2\">\n        {showHeaderIcons && <Settings2 size={20} className=\"text-yellow-600\" />}\n        Asetukset\n      </h2>\n\n      {settingsError && <Alert variant=\"error\">{settingsError}</Alert>}\n      {settingsSuccess && <Alert variant=\"success\">{settingsSuccess}</Alert>}\n\n      <div>\n\n      <section className=\"section-block\">\n          <div className=\"mb-4 flex items-center justify-between gap-3\">\n            <div className=\"flex items-center gap-3\">\n              {showSettingActionIcons && <Images size={20} className=\"text-gray-600\" />}\n              <div>\n                <p className=\"font-medium\">K√§yt√§ legacyikoneja</p>\n                <p className=\"text-muted-sm\">\n                  {legacyTagIconsEnabled ? '2004-ikonit k√§yt√∂ss√§' : '2026-ikonit k√§yt√∂ss√§'}\n                </p>\n              </div>\n            </div>\n            <button\n              id=\"legacyTagIconsEnabled\"\n              type=\"button\"\n              role=\"switch\"\n              aria-checked={legacyTagIconsEnabled}\n              aria-label=\"Aiheikonit 2004 / 2026\"\n              disabled={savingSettings}\n              onClick={() => handleLegacyTagIconsToggle(!legacyTagIconsEnabled)}\n              className={`relative inline-flex h-7 w-12 items-center rounded-full transition ${\n                legacyTagIconsEnabled ? 'bg-green-500' : 'bg-gray-300'\n              } ${savingSettings ? 'opacity-50 cursor-not-allowed' : ''}`}\n            >\n              <span\n                className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${\n                  legacyTagIconsEnabled ? 'translate-x-6' : 'translate-x-1'\n                }`}\n              />\n            </button>\n          </div>\n\n          <div className=\"flex items-center justify-between gap-3\">\n            <div className=\"flex items-center gap-3\">\n              {showSettingActionIcons && <RefreshCw size={20} className=\"text-gray-600\" />}\n              <div>\n                <p className=\"font-medium\">Reaaliaikaiset p√§ivitykset</p>\n                <p className=\"text-muted-sm\">\n                  {realtimeUpdatesEnabled\n                    ? 'Ketjut ja viestit p√§ivittyv√§t automaattisesti'\n                    : 'P√§ivitykset vain sivun latauksella'}\n                </p>\n              </div>\n            </div>\n            <button\n              id=\"realtimeUpdatesEnabled\"\n              type=\"button\"\n              role=\"switch\"\n              aria-checked={realtimeUpdatesEnabled}\n              aria-label=\"Reaaliaikaiset p√§ivitykset ketjuille ja viesteille\"\n              disabled={savingSettings}\n              onClick={() => handleRealtimeToggle(!realtimeUpdatesEnabled)}\n              className={`relative inline-flex h-7 w-12 items-center rounded-full transition ${\n                realtimeUpdatesEnabled ? 'bg-green-500' : 'bg-gray-300'\n              } ${savingSettings ? 'opacity-50 cursor-not-allowed' : ''}`}\n            >\n              <span\n                className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${\n                  realtimeUpdatesEnabled ? 'translate-x-6' : 'translate-x-1'\n                }`}\n              />\n            </button>\n          </div>\n        </section>\n\n        <section className=\"section-block\">\n          <h3 className=\"section-header\">\n            {showSectionHeaderIcons && <EyeOff size={16} className=\"text-yellow-600\" />}\n            Piilotetut aiheet\n          </h3>\n\n          <p className=\"mb-3 text-muted-sm\">\n            Valitse tagit tai tagiryhm√§t, joiden aiheet haluat piilottaa foorumin listauksesta.\n          </p>\n\n          <TokenInput\n            label=\"Piilota tagit / ryhm√§t\"\n            placeholder=\"Hae tageja tai ryhmi√§...\"\n            tokens={hiddenTokens}\n            query={hideQuery}\n            onQueryChange={setHideQuery}\n            onRemoveToken={handleRemoveHiddenToken}\n            options={hideOptions}\n            onSelectOption={handleSelectHiddenOption}\n            loading={loadingHideOptions || savingHiddenFilters}\n            emptyMessage=\"Ei osumia\"\n            disabled={savingHiddenFilters}\n          />\n\n          <p className=\"mt-3 text-muted-xs\">\n            {loadingHiddenImpact && 'Lasketaan piilotusvaikutusta...'}\n            {!loadingHiddenImpact && hiddenImpact && (\n              <>\n                {hiddenImpact.hidden_topic_count} ketjua piilossa ({hiddenImpact.hidden_message_percent.toFixed(1)} % kaikista viesteist√§).\n              </>\n            )}\n            {!loadingHiddenImpact && hiddenImpactError && ` ${hiddenImpactError}`}\n          </p>\n        </section>\n\n      \n      </div>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/profile/TopFiveCard.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'TopFiveCard' has a complexity of 13. Maximum allowed is 12.","line":47,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":47,"endColumn":28},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 22 to the 15 allowed.","line":61,"column":35,"nodeType":null,"messageId":"refactorFunction","endLine":61,"endColumn":37},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 18. Maximum allowed is 12.","line":61,"column":35,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":61,"endColumn":37},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":246,"column":21,"nodeType":"JSXOpeningElement","endLine":250,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport Link from 'next/link';\nimport { Card } from '@/components/ui/Card';\nimport { BarChart3, Heart, Star, Users } from 'lucide-react';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { profileThumb } from '@/lib/cloudinary';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\nimport { TagChip } from '@/components/ui/TagChip';\n\ninterface TopFiveCardProps {\n  profileId: string;\n  className?: string;\n}\n\ninterface TopTagStat {\n  tag_id: number;\n  tag_name: string;\n  tag_slug: string;\n  usage_count: number;\n  tag_icon?: string;\n  legacy_icon_path?: string | null;\n}\n\ninterface ViewedTopicStat {\n  id: number;\n  title: string;\n  views: number;\n}\n\ninterface TopLikedPost {\n  post_id: number;\n  topic_id: number;\n  topic_title: string;\n  content_preview: string;\n  likes_count: number;\n}\n\ninterface TopLikedAuthor {\n  author_id: string;\n  username: string;\n  profile_image_url: string | null;\n  likes_given: number;\n}\n\nexport function TopFiveCard({ profileId, className = '' }: TopFiveCardProps) {\n  const { supabase, profile } = useAuth();\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n  const showSectionHeaderIcons = UI_ICON_SETTINGS.showSectionHeaderIcons;\n  const [loading, setLoading] = useState(true);\n  const [topTags, setTopTags] = useState<TopTagStat[]>([]);\n  const [mostViewedThreads, setMostViewedThreads] = useState<ViewedTopicStat[]>([]);\n  const [topLikedPosts, setTopLikedPosts] = useState<TopLikedPost[]>([]);\n  const [likedAuthors, setLikedAuthors] = useState<TopLikedAuthor[]>([]);\n  const maxTagUsage = topTags.reduce((max, tag) => Math.max(max, tag.usage_count), 0);\n\n  useEffect(() => {\n    if (!profileId) return;\n\n    const fetchTopFive = async () => {\n      setLoading(true);\n\n      const [topTagsRes, viewedThreadsRes, likedPostsRes, likedAuthorsRes] = await Promise.all([\n        supabase.rpc('get_profile_top_tags', {\n          target_profile_id: profileId,\n          result_limit: 5,\n        }),\n        supabase\n          .from('topics')\n          .select('id, title, views')\n          .eq('author_id', profileId)\n          .order('views', { ascending: false })\n          .limit(5),\n        supabase.rpc('get_profile_top_liked_posts', {\n          target_profile_id: profileId,\n          result_limit: 5,\n        }),\n        supabase.rpc('get_profile_top_liked_authors', {\n          target_profile_id: profileId,\n          result_limit: 5,\n        }),\n      ]);\n\n      if (!topTagsRes.error && topTagsRes.data) {\n        const topTagRows = topTagsRes.data as TopTagStat[];\n        const tagIds = topTagRows.map((tag) => tag.tag_id).filter((id) => Number.isFinite(id) && id > 0);\n\n        if (tagIds.length > 0) {\n          const { data: iconRows } = await supabase\n            .from('tags')\n            .select('id, icon, legacy_icon_path')\n            .in('id', tagIds);\n\n          const legacyTagIconsEnabled =\n            (profile as { legacy_tag_icons_enabled?: boolean } | null)?.legacy_tag_icons_enabled !== false;\n          const iconById = new Map<number, string>();\n          for (const row of (iconRows || []) as { id: number; icon: string | null; legacy_icon_path: string | null }[]) {\n            const legacyIconPath = (row.legacy_icon_path || '').trim();\n            const icon = (row.icon || '').trim();\n            iconById.set(row.id, (legacyTagIconsEnabled ? legacyIconPath : '') || icon || 'üè∑Ô∏è');\n          }\n\n          setTopTags(topTagRows.map((tag) => ({ ...tag, tag_icon: iconById.get(tag.tag_id) || 'üè∑Ô∏è' })));\n        } else {\n          setTopTags(topTagRows);\n        }\n      } else {\n        setTopTags([]);\n      }\n\n      if (!viewedThreadsRes.error && viewedThreadsRes.data) {\n        setMostViewedThreads(viewedThreadsRes.data as ViewedTopicStat[]);\n      } else {\n        setMostViewedThreads([]);\n      }\n\n      if (!likedPostsRes.error && likedPostsRes.data) {\n        setTopLikedPosts(likedPostsRes.data as TopLikedPost[]);\n      } else {\n        setTopLikedPosts([]);\n      }\n\n      if (!likedAuthorsRes.error && likedAuthorsRes.data) {\n        setLikedAuthors(likedAuthorsRes.data as TopLikedAuthor[]);\n      } else {\n        setLikedAuthors([]);\n      }\n\n      setLoading(false);\n    };\n\n    fetchTopFive();\n  }, [profile, profileId, supabase]);\n\n  if (loading) {\n    return (\n      <Card className={className}>\n        <h2 className=\"card-title flex items-center gap-2\">\n          {showHeaderIcons && <Star size={20} className=\"text-yellow-600\" />}\n          Top 5\n        </h2>\n        <p className=\"text-muted-sm\">Ladataan...</p>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className={className}>\n      <h2 className=\"card-title mb-5 flex items-center gap-2\">\n        {showHeaderIcons && <Star size={20} className=\"text-yellow-600\" />}\n        Top 5\n      </h2>\n\n      <div>\n        <section className=\"section-block\">\n          <h3 className=\"section-header\">\n            {showSectionHeaderIcons && <Star size={14} className=\"text-yellow-600\" />}\n            K√§ytetyimm√§t tagit\n          </h3>\n          {topTags.length > 0 ? (\n            <div className=\"space-y-2\">\n              {topTags.map((tag) => (\n                <div key={tag.tag_id} className=\"text-sm\">\n                  <div className=\"h-8 w-full rounded-md\">\n                    <TagChip\n                      icon={tag.tag_icon || 'üè∑Ô∏è'}\n                      count={tag.usage_count}\n                      className=\"h-full justify-start overflow-hidden whitespace-nowrap\"\n                      style={{\n                        width: `${Math.round((tag.usage_count / Math.max(maxTagUsage, 1)) * 100)}%`,\n                      }}\n                    >\n                      {tag.tag_name}\n                    </TagChip>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-muted-sm\">Ei dataa viel√§.</p>\n          )}\n        </section>\n\n        <section className=\"section-block\">\n          <h3 className=\"section-header\">\n            {showSectionHeaderIcons && <Heart size={14} className=\"text-yellow-600\" />}\n            Eniten tyk√§tyt viestit\n          </h3>\n          {topLikedPosts.length > 0 ? (\n            <div className=\"space-y-2\">\n              {topLikedPosts.map((post) => (\n                <Link\n                  key={post.post_id}\n                  href={`/topic/${post.topic_id}`}\n                  className=\"list-row-card-compact block\"\n                >\n                  <p className=\"text-muted-xs truncate mb-1\">{post.topic_title}</p>\n                  <p className=\"text-sm text-gray-700 line-clamp-2\">{post.content_preview}</p>\n                  <p className=\"text-xs text-yellow-700 mt-1\">{post.likes_count} tykk√§yst√§</p>\n                </Link>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-muted-sm\">Ei tyk√§ttyj√§ viestej√§ viel√§.</p>\n          )}\n        </section>\n\n        <section className=\"section-block\">\n          <h3 className=\"section-header\">\n            {showSectionHeaderIcons && <BarChart3 size={14} className=\"text-yellow-600\" />}\n            Katsotuimmat aiheet\n          </h3>\n          {mostViewedThreads.length > 0 ? (\n            <div className=\"space-y-2\">\n              {mostViewedThreads.map((topic) => (\n                <Link\n                  key={topic.id}\n                  href={`/topic/${topic.id}`}\n                  className=\"list-row-card-compact flex items-center gap-2 text-sm\"\n                >\n                  <span className=\"flex-1 truncate font-medium\">{topic.title}</span>\n                  <span className=\"text-gray-500 whitespace-nowrap\">{topic.views} katselua</span>\n                </Link>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-muted-sm\">Ei aiheita viel√§.</p>\n          )}\n        </section>\n\n        <section className=\"section-block\">\n          <h3 className=\"section-header\">\n            {showSectionHeaderIcons && <Users size={14} className=\"text-yellow-600\" />}\n            K√§ytt√§j√§t joiden viesteist√§ olet tyk√§nnyt\n          </h3>\n          {likedAuthors.length > 0 ? (\n            <div className=\"space-y-2\">\n              {likedAuthors.map((author) => (\n                <Link\n                  key={author.author_id}\n                  href={`/profile/${author.author_id}`}\n                  className=\"list-row-card-compact flex items-center gap-2\"\n                >\n                  {author.profile_image_url ? (\n                    <img\n                      src={profileThumb(author.profile_image_url)}\n                      alt={author.username}\n                      className=\"avatar-inline-sm\"\n                    />\n                  ) : (\n                    <span className=\"avatar-inline-sm-fallback text-xs font-bold\">\n                      {author.username.slice(0, 1).toUpperCase()}\n                    </span>\n                  )}\n                  <span className=\"text-sm font-medium flex-1 truncate\">{author.username}</span>\n                  <span className=\"text-muted-xs whitespace-nowrap\">{author.likes_given} tykk√§yst√§</span>\n                </Link>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-muted-sm\">Et ole tyk√§nnyt viel√§ muiden viesteist√§.</p>\n          )}\n        </section>\n      </div>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/profile/TrophiesCard.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":29,"column":17,"nodeType":"JSXOpeningElement","endLine":33,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Card } from '@/components/ui/Card';\nimport { Trophy as TrophyIcon } from 'lucide-react';\nimport { trophyLocalIconUrl } from '@/lib/trophies';\nimport { UI_ICON_SETTINGS } from '@/lib/uiSettings';\nimport type { Trophy } from '@/lib/trophies';\n\ninterface TrophiesCardProps {\n  trophies: Trophy[];\n}\n\nexport function TrophiesCard({ trophies }: TrophiesCardProps) {\n  const showHeaderIcons = UI_ICON_SETTINGS.showHeaderIcons;\n\n  return (\n    <Card className=\"mb-6\">\n      <h2 className=\"card-title flex items-center gap-2\">\n        {showHeaderIcons && <TrophyIcon size={20} className=\"text-yellow-600\" />}\n        Kunniamerkit\n      </h2>\n      {trophies.length > 0 ? (\n        <div className=\"flex flex-wrap gap-2\">\n          {trophies.map((trophy) => (\n            <span\n              key={trophy.id}\n              className=\"inline-flex items-center rounded bg-yellow-100 text-yellow-800 px-2 py-1 text-xs font-medium\"\n              title={`${trophy.name} (${trophy.points} p)`}\n            >\n              {trophyLocalIconUrl(trophy.icon_path) && (\n                <img\n                  src={trophyLocalIconUrl(trophy.icon_path) as string}\n                  alt={trophy.name}\n                  className=\"w-4 h-5 object-contain mr-1\"\n                />\n              )}\n              {trophy.name}\n            </span>\n          ))}\n        </div>\n      ) : (\n        <p className=\"text-muted-sm\">Ei kunniamerkkej√§ viel√§.</p>\n      )}\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/AddItemPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/Alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/Input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/SearchInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/TagChip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/TagChipInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/TagChipLink.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/TagIcon.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":19,"column":12,"nodeType":"JSXOpeningElement","endLine":19,"endColumn":82}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { CSSProperties } from 'react';\n\ninterface TagIconProps {\n  icon?: string | null;\n  alt?: string;\n  className?: string;\n  style?: CSSProperties;\n}\n\nfunction isImagePath(value: string): boolean {\n  const normalized = value.trim().toLowerCase();\n  return normalized.startsWith('/') || normalized.startsWith('http://') || normalized.startsWith('https://');\n}\n\nexport function TagIcon({ icon, alt = 'Tag icon', className, style }: TagIconProps) {\n  const normalized = (icon || '').trim();\n\n  if (normalized && isImagePath(normalized)) {\n    return <img src={normalized} alt={alt} className={className} style={style} />;\n  }\n\n  return (\n    <span className={className} style={style} aria-label={alt}>\n      {normalized || 'üè∑Ô∏è'}\n    </span>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/TokenInput.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'TokenInput' has a complexity of 14. Maximum allowed is 12.","line":35,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":35,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useMemo, useRef, useState } from 'react';\nimport { X } from 'lucide-react';\n\nexport interface TokenItem {\n  id: number | string;\n  label: string;\n  icon?: string;\n}\n\nexport interface TokenOption {\n  id: number | string;\n  label: string;\n  icon?: string;\n  meta?: string;\n}\n\ninterface TokenInputProps {\n  label: string;\n  placeholder?: string;\n  tokens: TokenItem[];\n  query: string;\n  onQueryChange: (value: string) => void;\n  onRemoveToken: (id: number | string) => void;\n  options?: TokenOption[];\n  onSelectOption?: (option: TokenOption) => void;\n  onSubmitQuery?: (value: string) => void | Promise<void>;\n  submitLabel?: string;\n  loading?: boolean;\n  emptyMessage?: string;\n  disabled?: boolean;\n}\n\nexport function TokenInput({\n  label,\n  placeholder = '',\n  tokens,\n  query,\n  onQueryChange,\n  onRemoveToken,\n  options = [],\n  onSelectOption,\n  onSubmitQuery,\n  submitLabel = 'Lis√§√§',\n  loading = false,\n  emptyMessage = 'Ei osumia',\n  disabled = false,\n}: TokenInputProps) {\n  const [open, setOpen] = useState(false);\n  const rootRef = useRef<HTMLDivElement | null>(null);\n  const normalizedQuery = query.trim();\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (!rootRef.current) return;\n      if (!rootRef.current.contains(event.target as Node)) {\n        setOpen(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const canSubmitQuery = useMemo(\n    () => !!onSubmitQuery && normalizedQuery.length > 0 && !disabled,\n    [onSubmitQuery, normalizedQuery, disabled]\n  );\n\n  const visibleOptions = useMemo(() => options.slice(0, 8), [options]);\n\n  const handleSubmitQuery = () => {\n    if (!canSubmitQuery || !onSubmitQuery) return;\n    void onSubmitQuery(normalizedQuery);\n  };\n\n  return (\n    <div ref={rootRef}>\n      <label className=\"block text-xs text-gray-500 mb-1\">{label}</label>\n      <div className=\"relative\">\n        <div className=\"flex flex-wrap items-center gap-2 rounded-lg border-2 border-gray-300 bg-white px-2 py-2 focus-within:border-yellow-400\">\n          {tokens.map((token) => (\n            <span\n              key={token.id}\n              className=\"token-chip\"\n            >\n              {token.icon && <span>{token.icon}</span>}\n              <span>{token.label}</span>\n              <button\n                type=\"button\"\n                className=\"token-chip-remove\"\n                onClick={() => onRemoveToken(token.id)}\n                disabled={disabled}\n                aria-label={`Poista ${token.label}`}\n              >\n                <X size={11} />\n              </button>\n            </span>\n          ))}\n\n          <input\n            value={query}\n            onChange={(e) => {\n              onQueryChange(e.target.value);\n              setOpen(true);\n            }}\n            onFocus={() => setOpen(true)}\n            onKeyDown={(e) => {\n              if (e.key === 'Backspace' && query.length === 0 && tokens.length > 0) {\n                onRemoveToken(tokens[tokens.length - 1].id);\n                return;\n              }\n\n              if (e.key === 'Enter') {\n                e.preventDefault();\n                if (visibleOptions.length > 0 && onSelectOption) {\n                  onSelectOption(visibleOptions[0]);\n                  return;\n                }\n                if (canSubmitQuery) {\n                  handleSubmitQuery();\n                }\n              }\n            }}\n            placeholder={placeholder}\n            className=\"min-w-[180px] flex-1 border-0 bg-transparent p-1 text-sm outline-none focus:border-0 focus:outline-none\"\n            disabled={disabled}\n          />\n\n          {canSubmitQuery && (\n            <button\n              type=\"button\"\n              className=\"admin-compact-btn inline-flex items-center bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50\"\n              onClick={handleSubmitQuery}\n              disabled={disabled}\n            >\n              {submitLabel}\n            </button>\n          )}\n        </div>\n\n        {open && onSelectOption && (\n          <div className=\"menu-popover-panel\">\n            {loading && <div className=\"popover-state-row\">Haetaan...</div>}\n            {!loading && visibleOptions.length === 0 && (\n              <div className=\"popover-state-row\">{emptyMessage}</div>\n            )}\n            {!loading &&\n              visibleOptions.map((option) => (\n                <button\n                  key={option.id}\n                  type=\"button\"\n                  className=\"popover-option-row\"\n                  onClick={() => onSelectOption(option)}\n                  disabled={disabled}\n                >\n                  <span className=\"mr-1\">{option.icon || ''}</span>\n                  <span>{option.label}</span>\n                  {option.meta && <span className=\"ml-1 text-muted-xs\">{option.meta}</span>}\n                </button>\n              ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/components/ui/button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/contexts/AuthContext.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/contexts/AuthContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/topic/usePostLinkCopy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/topic/useTopicEditDelete.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 18. Maximum allowed is 12.","line":56,"column":84,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":56,"endColumn":86}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, type Dispatch, type SetStateAction } from 'react';\nimport { createClient } from '@/lib/supabase/client';\nimport { parsePostRow, type RawPostRow } from '@/lib/forum/parsers';\nimport type { Topic, TopicPrimaryTag } from '@/components/forum/types';\nimport type { TagOption } from '@/components/forum/AddTags';\nimport type { Post } from '@/components/forum/post';\n\ninterface EditTopicFirstPostRow {\n  topic_id: number;\n  topic_title: string;\n  post_id: number;\n  post_content: string;\n  post_image_url: string | null;\n  tag_id: number;\n  tag_name: string;\n  tag_slug: string;\n  tag_icon: string;\n}\n\ninterface UseTopicEditDeleteOptions {\n  topicId: number;\n  currentUser: { id: string } | null;\n  supabase: ReturnType<typeof createClient>;\n  topic: Topic | null;\n  topicPrimaryTag: TopicPrimaryTag | null;\n  firstPostId: number | null;\n  canEditTopicMeta: boolean;\n  setTopic: Dispatch<SetStateAction<Topic | null>>;\n  setTopicPrimaryTag: Dispatch<SetStateAction<TopicPrimaryTag | null>>;\n  setPosts: Dispatch<SetStateAction<Post[]>>;\n  setRefreshTick: Dispatch<SetStateAction<number>>;\n}\n\nexport function useTopicEditDelete({\n  topicId,\n  currentUser,\n  supabase,\n  topic,\n  topicPrimaryTag,\n  firstPostId,\n  canEditTopicMeta,\n  setTopic,\n  setTopicPrimaryTag,\n  setPosts,\n  setRefreshTick,\n}: UseTopicEditDeleteOptions) {\n  const [topicTitleDraft, setTopicTitleDraft] = useState('');\n  const [topicTagDraft, setTopicTagDraft] = useState<TagOption[]>([]);\n  const [topicEditError, setTopicEditError] = useState('');\n  const [editingPostId, setEditingPostId] = useState<number | null>(null);\n  const [editSaving, setEditSaving] = useState(false);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);\n\n  const handleEditSave = async (postId: number, content: string, imageUrl: string) => {\n    if (!content.trim() || !currentUser) return;\n\n    if (postId === firstPostId && canEditTopicMeta) {\n      const normalizedTitle = topicTitleDraft.trim();\n      if (normalizedTitle.length < 3) {\n        setTopicEditError('Otsikon pit√§√§ olla v√§hint√§√§n 3 merkki√§');\n        return;\n      }\n\n      setEditSaving(true);\n      setTopicEditError('');\n\n      const selectedTagId = topicTagDraft[0]?.id ?? null;\n      const { data, error } = await supabase.rpc('edit_topic_first_post_details', {\n        input_topic_id: topicId,\n        input_title: normalizedTitle,\n        input_content: content.trim(),\n        input_image_url: imageUrl || null,\n        input_tag_id: selectedTagId,\n      });\n\n      if (error) {\n        setTopicEditError(error.message || 'Langan p√§ivitys ep√§onnistui');\n        setEditSaving(false);\n        return;\n      }\n\n      const row = Array.isArray(data) && data.length > 0 ? (data[0] as EditTopicFirstPostRow) : null;\n      if (row) {\n        setTopic((prev) => (prev ? { ...prev, title: row.topic_title } : prev));\n        setTopicPrimaryTag({\n          id: row.tag_id,\n          name: row.tag_name,\n          slug: row.tag_slug,\n          icon: row.tag_icon || 'üè∑Ô∏è',\n        });\n        setPosts((prev) =>\n          prev.map((p) =>\n            p.id === row.post_id\n              ? { ...p, content: row.post_content, image_url: row.post_image_url, updated_at: new Date().toISOString() }\n              : p\n          )\n        );\n      } else {\n        setRefreshTick((prev) => prev + 1);\n      }\n\n      setEditingPostId(null);\n      setEditSaving(false);\n      return;\n    }\n\n    setEditSaving(true);\n\n    const { data, error } = await supabase\n      .from('posts')\n      .update({\n        content: content.trim(),\n        image_url: imageUrl || null,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', postId)\n      .eq('author_id', currentUser.id)\n      .select(`\n        id, content, created_at, updated_at, deleted_at, image_url,\n        author:profiles!author_id(id, username, profile_image_url, created_at)\n      `)\n      .single();\n\n    if (!error && data) {\n      setPosts((prev) => prev.map((p) => (p.id === postId ? parsePostRow(data as RawPostRow) : p)));\n      setEditingPostId(null);\n    }\n    setEditSaving(false);\n  };\n\n  const handleDelete = async (postId: number) => {\n    if (!currentUser) return;\n\n    const { data, error } = await supabase\n      .from('posts')\n      .update({ deleted_at: new Date().toISOString() })\n      .eq('id', postId)\n      .eq('author_id', currentUser.id)\n      .select(`\n        id, content, created_at, updated_at, deleted_at, image_url,\n        author:profiles!author_id(id, username, profile_image_url, created_at)\n      `)\n      .single();\n\n    if (!error && data) {\n      setPosts((prev) => prev.map((p) => (p.id === postId ? parsePostRow(data as RawPostRow) : p)));\n    }\n    setDeleteConfirmId(null);\n  };\n\n  const startEdit = (post: Post) => {\n    if (post.id === firstPostId && canEditTopicMeta && topic) {\n      setTopicTitleDraft(topic.title);\n      setTopicTagDraft(\n        topicPrimaryTag\n          ? [\n              {\n                id: topicPrimaryTag.id,\n                name: topicPrimaryTag.name,\n                slug: topicPrimaryTag.slug,\n                icon: topicPrimaryTag.icon,\n              },\n            ]\n          : []\n      );\n      setTopicEditError('');\n    }\n    setEditingPostId(post.id);\n  };\n\n  const cancelEdit = (post: Post) => {\n    setEditingPostId(null);\n    if (post.id === firstPostId) {\n      setTopicEditError('');\n    }\n  };\n\n  return {\n    topicTitleDraft,\n    setTopicTitleDraft,\n    topicTagDraft,\n    setTopicTagDraft,\n    topicEditError,\n    editingPostId,\n    editSaving,\n    deleteConfirmId,\n    setDeleteConfirmId,\n    handleEditSave,\n    handleDelete,\n    startEdit,\n    cancelEdit,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/topic/useTopicPageData.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/topic/useTopicPostActions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/topic/useTopicPostsWindow.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":167,"column":32,"nodeType":null,"messageId":"refactorFunction","endLine":167,"endColumn":34},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 23. Maximum allowed is 12.","line":167,"column":32,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":167,"endColumn":34},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (364). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":365,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport type { Post } from '@/components/forum/post';\nimport type { Topic, TopicPrimaryTag } from '@/components/forum/types';\nimport { UI_PAGING_SETTINGS } from '@/lib/uiSettings';\nimport { createClient } from '@/lib/supabase/client';\nimport { normalizeJoin } from '@/lib/supabase/normalizeJoin';\nimport {\n  parseAroundPostRow,\n  parsePostRow,\n  parseTopicRow,\n  type AroundPostRow,\n  type RawPostRow,\n  type RawTopicRow,\n} from '@/lib/forum/parsers';\n\ninterface TopicViewResponse {\n  views_total?: number;\n  views_unique?: number;\n}\n\nfunction parseTopicViewResponse(value: unknown): TopicViewResponse | null {\n  if (!value || typeof value !== 'object') return null;\n  return value as TopicViewResponse;\n}\n\ninterface RawTopicTagRow {\n  tag:\n    | {\n        id?: number | null;\n        name?: string | null;\n        slug?: string | null;\n        icon?: string | null;\n        legacy_icon_path?: string | null;\n        status?: string | null;\n        redirect_to_tag_id?: number | null;\n      }\n    | {\n        id?: number | null;\n        name?: string | null;\n        slug?: string | null;\n        icon?: string | null;\n        legacy_icon_path?: string | null;\n        status?: string | null;\n        redirect_to_tag_id?: number | null;\n      }[]\n    | null;\n}\n\ninterface UseTopicPostsWindowOptions {\n  topicId: number;\n  currentUser: { id: string } | null;\n  supabase: ReturnType<typeof createClient>;\n  profile: { realtime_updates_enabled?: boolean; legacy_tag_icons_enabled?: boolean } | null;\n}\n\nexport function useTopicPostsWindow({ topicId, currentUser, supabase, profile }: UseTopicPostsWindowOptions) {\n  const initialVisibleMessages = UI_PAGING_SETTINGS.threadInitialVisibleMessages;\n  const showMoreStep = UI_PAGING_SETTINGS.threadShowMoreStep;\n  const anchorBeforeBuffer = UI_PAGING_SETTINGS.threadAnchorBeforeBuffer;\n  const anchorAfterBuffer = UI_PAGING_SETTINGS.threadAnchorAfterBuffer;\n  const realtimeUpdatesEnabled = profile?.realtime_updates_enabled === true;\n  const legacyTagIconsEnabled = profile?.legacy_tag_icons_enabled ?? true;\n\n  const [topic, setTopic] = useState<Topic | null>(null);\n  const [topicPrimaryTag, setTopicPrimaryTag] = useState<TopicPrimaryTag | null>(null);\n  const [posts, setPosts] = useState<Post[]>([]);\n  const [totalPosts, setTotalPosts] = useState(0);\n  const [firstPostId, setFirstPostId] = useState<number | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [windowStartIndex, setWindowStartIndex] = useState(0);\n  const [windowEndIndex, setWindowEndIndex] = useState(0);\n  const [highlightedPostId, setHighlightedPostId] = useState<number | null>(null);\n  const [refreshTick, setRefreshTick] = useState(0);\n  const highlightTimeoutRef = useRef<number | null>(null);\n\n  const loadMorePosts = useCallback(\n    async (targetEndIndex?: number) => {\n      const desiredEnd = Math.min(\n        totalPosts,\n        Math.max(windowEndIndex + showMoreStep, targetEndIndex ?? windowEndIndex + showMoreStep)\n      );\n      if (desiredEnd <= windowEndIndex) return;\n\n      setLoadingMore(true);\n      const { data, error } = await supabase\n        .from('posts')\n        .select(`\n          id, content, created_at, updated_at, deleted_at, image_url,\n          author:profiles!author_id(id, username, profile_image_url, created_at, signature, show_signature)\n        `)\n        .eq('topic_id', topicId)\n        .order('created_at', { ascending: true })\n        .range(windowEndIndex, desiredEnd - 1);\n\n      if (!error && data && data.length > 0) {\n        const parsed = (data as RawPostRow[]).map(parsePostRow);\n        setPosts((prev) => [...prev, ...parsed]);\n        setWindowEndIndex((prev) => prev + parsed.length);\n      }\n      setLoadingMore(false);\n    },\n    [showMoreStep, supabase, topicId, totalPosts, windowEndIndex]\n  );\n\n  const loadOlderPosts = useCallback(async () => {\n    if (windowStartIndex <= 0) return;\n    const nextStart = Math.max(0, windowStartIndex - showMoreStep);\n    const nextEnd = windowStartIndex - 1;\n    if (nextEnd < nextStart) return;\n\n    setLoadingMore(true);\n    const { data, error } = await supabase\n      .from('posts')\n      .select(`\n        id, content, created_at, updated_at, deleted_at, image_url,\n        author:profiles!author_id(id, username, profile_image_url, created_at, signature, show_signature)\n      `)\n      .eq('topic_id', topicId)\n      .order('created_at', { ascending: true })\n      .range(nextStart, nextEnd);\n\n    if (!error && data && data.length > 0) {\n      const parsed = (data as RawPostRow[]).map(parsePostRow);\n      setPosts((prev) => [...parsed, ...prev]);\n      setWindowStartIndex(nextStart);\n    }\n    setLoadingMore(false);\n  }, [showMoreStep, supabase, topicId, windowStartIndex]);\n\n  const loadAroundPost = useCallback(\n    async (targetPostId: number) => {\n      if (!Number.isFinite(targetPostId) || targetPostId <= 0) return false;\n\n      setLoadingMore(true);\n      const { data, error } = await supabase.rpc('get_topic_posts_around', {\n        input_topic_id: topicId,\n        input_post_id: targetPostId,\n        input_before: anchorBeforeBuffer,\n        input_after: anchorAfterBuffer,\n      });\n\n      if (error || !data || data.length === 0) {\n        setLoadingMore(false);\n        return false;\n      }\n\n      const rows = data as AroundPostRow[];\n      const parsed = rows.map(parseAroundPostRow);\n      const firstRowNumber = rows[0]?.post_row_number ?? 1;\n      const lastRowNumber = rows[rows.length - 1]?.post_row_number ?? firstRowNumber;\n      const nextTotalPosts = rows[0]?.total_rows ?? totalPosts;\n\n      setPosts(parsed);\n      setWindowStartIndex(Math.max(0, firstRowNumber - 1));\n      setWindowEndIndex(lastRowNumber);\n      setTotalPosts(nextTotalPosts);\n      setLoadingMore(false);\n      return true;\n    },\n    [anchorAfterBuffer, anchorBeforeBuffer, supabase, topicId, totalPosts]\n  );\n\n  useEffect(() => {\n    const fetchData = async () => {\n      if (!Number.isFinite(topicId) || topicId <= 0) {\n        setLoading(false);\n        return;\n      }\n\n      setLoading(true);\n      const initialLoadCount = initialVisibleMessages;\n      const [topicRes, postsRes, countRes, firstPostRes, topicTagsRes] = await Promise.all([\n        supabase\n          .from('topics')\n          .select('id, title, author_id, views, views_total, views_unique')\n          .eq('id', topicId)\n          .single(),\n        supabase\n          .from('posts')\n          .select(`\n            id, content, created_at, updated_at, deleted_at, image_url,\n            author:profiles!author_id(id, username, profile_image_url, created_at, signature, show_signature)\n          `)\n          .eq('topic_id', topicId)\n          .order('created_at', { ascending: true })\n          .range(0, Math.max(initialLoadCount - 1, 0)),\n        supabase.from('posts').select('id', { count: 'exact', head: true }).eq('topic_id', topicId),\n        supabase.from('posts').select('id').eq('topic_id', topicId).order('created_at', { ascending: true }).limit(1),\n        supabase\n          .from('topic_tags')\n          .select('tag:tags(id, name, slug, icon, legacy_icon_path, status, redirect_to_tag_id)')\n          .eq('topic_id', topicId)\n          .order('created_at', { ascending: true }),\n      ]);\n\n      if (!topicRes.error && topicRes.data) {\n        setTopic(parseTopicRow(topicRes.data as RawTopicRow));\n      }\n      if (!postsRes.error && postsRes.data) {\n        const parsedPosts = (postsRes.data as RawPostRow[]).map(parsePostRow);\n        setPosts(parsedPosts);\n        setWindowStartIndex(0);\n        setWindowEndIndex(parsedPosts.length);\n      }\n      if (!countRes.error) {\n        setTotalPosts(countRes.count || 0);\n      }\n      if (!firstPostRes.error && firstPostRes.data && firstPostRes.data.length > 0) {\n        setFirstPostId(firstPostRes.data[0].id as number);\n      }\n      if (!topicTagsRes.error) {\n        const normalizedPrimaryTag = ((topicTagsRes.data || []) as RawTopicTagRow[])\n          .map((row) => normalizeJoin(row.tag))\n          .find((tag) => !!tag && tag.redirect_to_tag_id == null && tag.status !== 'hidden');\n\n        if (normalizedPrimaryTag && normalizedPrimaryTag.id) {\n          const legacyIconPath = String(normalizedPrimaryTag.legacy_icon_path || '').trim();\n          const icon = String(normalizedPrimaryTag.icon || '').trim();\n          setTopicPrimaryTag({\n            id: normalizedPrimaryTag.id,\n            name: normalizedPrimaryTag.name || 'Tagit',\n            slug: normalizedPrimaryTag.slug || '',\n            icon: (legacyTagIconsEnabled ? legacyIconPath : '') || icon || 'üè∑Ô∏è',\n          });\n        } else {\n          setTopicPrimaryTag(null);\n        }\n      }\n      setLoading(false);\n    };\n\n    void fetchData();\n  }, [supabase, topicId, refreshTick, initialVisibleMessages, legacyTagIconsEnabled]);\n\n  useEffect(() => {\n    if (!currentUser || !realtimeUpdatesEnabled || !Number.isFinite(topicId)) return;\n\n    const channel = supabase\n      .channel(`topic-live-${topicId}-${currentUser.id}`)\n      .on(\n        'postgres_changes',\n        { event: '*', schema: 'public', table: 'posts', filter: `topic_id=eq.${topicId}` },\n        () => {\n          setRefreshTick((prev) => prev + 1);\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [supabase, topicId, currentUser, realtimeUpdatesEnabled]);\n\n  useEffect(() => {\n    if (!Number.isFinite(topicId)) return;\n\n    const trackView = async () => {\n      const { data, error } = await supabase.rpc('record_topic_view', {\n        target_topic_id: topicId,\n      });\n\n      if (!error) {\n        const parsed = parseTopicViewResponse(data);\n        if (parsed) {\n          setTopic((prev) => {\n            if (!prev) return prev;\n            const nextUnique = typeof parsed.views_unique === 'number' ? parsed.views_unique : prev.views_unique;\n            const nextTotal = typeof parsed.views_total === 'number' ? parsed.views_total : prev.views_total;\n            return {\n              ...prev,\n              views_unique: nextUnique,\n              views_total: nextTotal,\n              views: nextUnique ?? prev.views,\n            };\n          });\n        }\n      }\n    };\n\n    void trackView();\n  }, [supabase, topicId]);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') return;\n\n    const clearHighlightTimer = () => {\n      if (highlightTimeoutRef.current) {\n        window.clearTimeout(highlightTimeoutRef.current);\n        highlightTimeoutRef.current = null;\n      }\n    };\n\n    const applyHashHighlight = () => {\n      const match = window.location.hash.match(/^#post-(\\d+)$/);\n      if (!match) return;\n\n      const postIdFromHash = Number(match[1]);\n      if (!Number.isFinite(postIdFromHash)) {\n        return;\n      }\n\n      if (!posts.some((post) => post.id === postIdFromHash)) {\n        void loadAroundPost(postIdFromHash);\n        return;\n      }\n\n      const targetElement = document.getElementById(`post-${postIdFromHash}`);\n      if (targetElement) {\n        targetElement.scrollIntoView({ block: 'center', behavior: 'auto' });\n      }\n\n      setHighlightedPostId(postIdFromHash);\n      clearHighlightTimer();\n      highlightTimeoutRef.current = window.setTimeout(() => {\n        setHighlightedPostId((prev) => (prev === postIdFromHash ? null : prev));\n        highlightTimeoutRef.current = null;\n      }, 1800);\n    };\n\n    applyHashHighlight();\n    window.addEventListener('hashchange', applyHashHighlight);\n\n    return () => {\n      window.removeEventListener('hashchange', applyHashHighlight);\n      clearHighlightTimer();\n    };\n  }, [posts, loadAroundPost]);\n\n  const displayedPostCount = posts.length;\n  const canLoadOlder = windowStartIndex > 0;\n  const canShowMore = windowEndIndex < totalPosts;\n\n  const handleShowMore = async () => {\n    await loadMorePosts();\n  };\n\n  return {\n    topic,\n    topicPrimaryTag,\n    posts,\n    totalPosts,\n    firstPostId,\n    loading,\n    loadingMore,\n    displayedPostCount,\n    canLoadOlder,\n    canShowMore,\n    highlightedPostId,\n    refreshTick,\n    windowEndIndex,\n    setTopic,\n    setTopicPrimaryTag,\n    setPosts,\n    setTotalPosts,\n    setWindowEndIndex,\n    setRefreshTick,\n    loadAroundPost,\n    loadOlderPosts,\n    handleShowMore,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/topic/useTopicReply.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/useForumQuote.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 13. Maximum allowed is 12.","line":61,"column":39,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":61,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { createClient } from '@/lib/supabase/client';\nimport { reportError } from '@/lib/reportError';\n\nexport interface RandomQuote {\n  post_id: number;\n  content: string;\n  created_at: string;\n  topic_id: number;\n  author_username: string | null;\n  likes_count: number;\n  liked_by_me: boolean;\n}\n\ninterface RawRandomQuoteRow {\n  id: number;\n  content: string;\n  created_at: string;\n  topic_id: number;\n  author: { username: string } | { username: string }[] | null;\n}\n\ninterface UseForumQuoteOptions {\n  supabase: ReturnType<typeof createClient>;\n  currentUser: { id: string } | null;\n  refreshKey?: number;\n}\n\nfunction extractAuthorUsername(author: RawRandomQuoteRow['author']): string | null {\n  if (!author) return null;\n  if (Array.isArray(author)) {\n    return author[0]?.username || null;\n  }\n  return author.username || null;\n}\n\nfunction getUtcHourStartIso(now: Date): string {\n  const hourStart = new Date(now);\n  hourStart.setUTCMinutes(0, 0, 0);\n  return hourStart.toISOString();\n}\n\nfunction getHourSeed(now: Date): number {\n  return Math.floor(now.getTime() / 3_600_000);\n}\n\nfunction deterministicOffset(seed: number, modulo: number): number {\n  if (modulo <= 0) return 0;\n  const mixed = (Math.imul(seed >>> 0, 1664525) + 1013904223) >>> 0;\n  return mixed % modulo;\n}\n\nexport function useForumQuote({ supabase, currentUser, refreshKey = 0 }: UseForumQuoteOptions) {\n  const [quote, setQuote] = useState<RandomQuote | null>(null);\n  const [quoteLikeSaving, setQuoteLikeSaving] = useState(false);\n  const [quoteError, setQuoteError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const fetchRandomQuote = async () => {\n      try {\n        setQuoteError(null);\n        const now = new Date();\n        const utcHourStartIso = getUtcHourStartIso(now);\n        const hourSeed = getHourSeed(now);\n\n        const { count } = await supabase\n          .from('posts')\n          .select('id', { count: 'exact', head: true })\n          .is('deleted_at', null)\n          .lt('created_at', utcHourStartIso)\n          .gte('content', '');\n\n        let eligibleCount = count || 0;\n        let useHourLimitedSet = true;\n\n        if (eligibleCount === 0) {\n          const fallbackCountRes = await supabase\n            .from('posts')\n            .select('id', { count: 'exact', head: true })\n            .is('deleted_at', null)\n            .gte('content', '');\n          eligibleCount = fallbackCountRes.count || 0;\n          useHourLimitedSet = false;\n        }\n\n        if (eligibleCount === 0) {\n          setQuote(null);\n          return;\n        }\n\n        const quoteOffset = deterministicOffset(hourSeed, eligibleCount);\n        let quoteQuery = supabase\n          .from('posts')\n          .select('id, content, created_at, topic_id, author:profiles!author_id(username)')\n          .is('deleted_at', null)\n          .order('id', { ascending: true })\n          .range(quoteOffset, quoteOffset);\n\n        if (useHourLimitedSet) {\n          quoteQuery = quoteQuery.lt('created_at', utcHourStartIso);\n        }\n\n        const { data } = await quoteQuery;\n\n        if (data && data.length > 0) {\n          const post = data[0] as RawRandomQuoteRow;\n          const [likesCountRes, myLikeRes] = await Promise.all([\n            supabase.from('quote_likes').select('profile_id', { count: 'exact', head: true }).eq('post_id', post.id),\n            currentUser\n              ? supabase\n                  .from('quote_likes')\n                  .select('post_id')\n                  .eq('post_id', post.id)\n                  .eq('profile_id', currentUser.id)\n                  .limit(1)\n              : Promise.resolve({ data: [], error: null }),\n          ]);\n\n          let snippet = post.content;\n          if (snippet.length > 150) {\n            snippet = snippet.substring(0, 150).replace(/\\s+\\S*$/, '') + '...';\n          }\n\n          setQuote({\n            post_id: post.id,\n            content: snippet,\n            created_at: post.created_at,\n            topic_id: post.topic_id,\n            author_username: extractAuthorUsername(post.author),\n            likes_count: likesCountRes.count || 0,\n            liked_by_me: !!myLikeRes.data && myLikeRes.data.length > 0,\n          });\n        }\n      } catch (error) {\n        reportError({ scope: 'forum.fetchRandomQuote', error });\n        setQuoteError('P√§iv√§n lainauksen lataus ep√§onnistui.');\n      }\n    };\n\n    void fetchRandomQuote();\n  }, [supabase, currentUser, refreshKey]);\n\n  const handleToggleQuoteLike = async () => {\n    if (!quote || quoteLikeSaving) return;\n    setQuoteLikeSaving(true);\n\n    const previous = quote;\n    setQuote({\n      ...quote,\n      liked_by_me: !quote.liked_by_me,\n      likes_count: Math.max(quote.likes_count + (quote.liked_by_me ? -1 : 1), 0),\n    });\n\n    const { data, error } = await supabase.rpc('toggle_quote_like', {\n      target_post_id: quote.post_id,\n    });\n\n    if (error) {\n      setQuote(previous);\n    } else if (data) {\n      setQuote((prev) => {\n        if (!prev) return prev;\n        return {\n          ...prev,\n          liked_by_me: typeof data.liked === 'boolean' ? data.liked : prev.liked_by_me,\n          likes_count: typeof data.likes_count === 'number' ? data.likes_count : prev.likes_count,\n        };\n      });\n    }\n\n    setQuoteLikeSaving(false);\n  };\n\n  return { quote, quoteLikeSaving, quoteError, handleToggleQuoteLike };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/useForumTopics.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/useForumTopics.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 17. Maximum allowed is 12.","line":239,"column":34,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":239,"endColumn":36},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (379). Maximum allowed is 350.","line":351,"column":1,"nodeType":null,"messageId":"exceed","endLine":380,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport { useRouter, useSearchParams } from 'next/navigation';\nimport { useShowMorePaging } from '@/hooks/useShowMorePaging';\nimport { UI_PAGING_SETTINGS } from '@/lib/uiSettings';\nimport { createClient } from '@/lib/supabase/client';\nimport { err, ok } from '@/lib/result';\nimport { reportError } from '@/lib/reportError';\n\nexport interface Topic {\n  id: number;\n  title: string;\n  views: number;\n  views_unique: number;\n  created_at: string;\n  category_name: string;\n  category_icon: string;\n  author_username: string;\n  replies_count: number;\n  last_post_id: number | null;\n  last_post_created_at: string | null;\n  jump_post_id: number | null;\n  unread_count: number;\n  has_new: boolean;\n}\n\ninterface RawTopicRow {\n  id: number;\n  title: string;\n  views: number;\n  views_unique: number;\n  created_at: string;\n  category_name: string;\n  category_icon: string;\n  author_username: string;\n  last_post_id: number | null;\n  last_post_created_at: string | null;\n  jump_post_id: number | null;\n  has_new: boolean;\n  replies_count?: number | null;\n  messages_count?: number | null;\n  unread_count?: number | null;\n}\n\ninterface TopicsApiResponse {\n  topics?: RawTopicRow[];\n  total_count?: number;\n  filter?: {\n    tag_ids?: number[];\n    match?: 'any' | 'all';\n  };\n}\n\ninterface UseForumTopicsOptions {\n  supabase: ReturnType<typeof createClient>;\n  currentUser: { id: string } | null;\n  realtimeUpdatesEnabled: boolean;\n}\n\nexport function useForumTopics({ supabase, currentUser, realtimeUpdatesEnabled }: UseForumTopicsOptions) {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n\n  const [topics, setTopics] = useState<Topic[]>([]);\n  const [threadCount, setThreadCount] = useState(0);\n  const [messageCount, setMessageCount] = useState(0);\n  const [loading, setLoading] = useState(true);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [dataError, setDataError] = useState<string | null>(null);\n  const [loadedPageCount, setLoadedPageCount] = useState(0);\n  const [refreshTick, setRefreshTick] = useState(0);\n\n  const forumBatchSize = UI_PAGING_SETTINGS.forumShowMoreStep;\n  const forumInitialVisible = UI_PAGING_SETTINGS.forumInitialVisibleThreads;\n  const forumUnreadBoostMax = UI_PAGING_SETTINGS.forumUnreadBoostMaxThreads;\n\n  const { visibleCount, setVisibleCount, resetVisibleCount } = useShowMorePaging({\n    initialVisible: forumInitialVisible,\n    step: forumBatchSize,\n  });\n\n  const requestedTagsParam = searchParams.get('tags') || '';\n  const requestedTagMatch = searchParams.get('match') === 'all' ? 'all' : 'any';\n  const unreadOnly = searchParams.get('unread') === '1';\n\n  const requestedTagIds = useMemo(\n    () =>\n      Array.from(\n        new Set(\n          requestedTagsParam\n            .split(',')\n            .map((part) => Number.parseInt(part.trim(), 10))\n            .filter((id) => Number.isFinite(id) && id > 0)\n        )\n      ),\n    [requestedTagsParam]\n  );\n\n  const pushFilterUrl = useCallback(\n    (nextTagIds: number[], nextMatch: 'any' | 'all') => {\n      const next = new URLSearchParams(searchParams.toString());\n      next.delete('page');\n      if (nextTagIds.length > 0) {\n        next.set('tags', nextTagIds.join(','));\n      } else {\n        next.delete('tags');\n      }\n      if (nextMatch === 'all' && nextTagIds.length > 1) {\n        next.set('match', 'all');\n      } else {\n        next.delete('match');\n      }\n      const query = next.toString();\n      router.push(query ? `/?${query}` : '/');\n    },\n    [router, searchParams]\n  );\n\n  const pushUnreadOnlyUrl = useCallback(\n    (nextUnreadOnly: boolean) => {\n      const next = new URLSearchParams(searchParams.toString());\n      next.delete('page');\n      if (nextUnreadOnly) {\n        next.set('unread', '1');\n      } else {\n        next.delete('unread');\n      }\n      const query = next.toString();\n      router.push(query ? `/?${query}` : '/');\n    },\n    [router, searchParams]\n  );\n\n  const normalizeTopics = useCallback((rows: RawTopicRow[]) => {\n    return rows.map((topic) => {\n      const repliesCount =\n        typeof topic.replies_count === 'number'\n          ? topic.replies_count\n          : Math.max((topic.messages_count || 0) - 1, 0);\n\n      return {\n        ...topic,\n        replies_count: repliesCount,\n        unread_count:\n          typeof topic.unread_count === 'number'\n            ? Math.max(0, topic.unread_count)\n            : topic.has_new\n              ? 1\n              : 0,\n      } as Topic;\n    });\n  }, []);\n\n  const fetchTopicsPage = useCallback(\n    async (page: number) => {\n      try {\n        const params = new URLSearchParams();\n        params.set('page', String(page));\n        params.set('page_size', String(forumBatchSize));\n        if (requestedTagIds.length > 0) {\n          params.set('tag_ids', requestedTagIds.join(','));\n          params.set('match', requestedTagMatch);\n        }\n\n        const res = await fetch(`/api/topics?${params.toString()}`, { cache: 'no-store' });\n        if (!res.ok) {\n          const fetchError = new Error(`Topics API failed (${res.status})`);\n          reportError({\n            scope: 'forum.fetchTopicsPage',\n            error: fetchError,\n            meta: { page, status: res.status, requestedTagIds, requestedTagMatch },\n          });\n          return err(fetchError);\n        }\n\n        const payload = (await res.json()) as TopicsApiResponse;\n        return ok(payload);\n      } catch (error) {\n        reportError({\n          scope: 'forum.fetchTopicsPage',\n          error,\n          meta: { page, requestedTagIds, requestedTagMatch },\n        });\n        return err(error instanceof Error ? error : new Error('Topics page fetch failed'));\n      }\n    },\n    [forumBatchSize, requestedTagIds, requestedTagMatch]\n  );\n\n  const loadMoreTopics = useCallback(\n    async (targetVisibleCount: number) => {\n      const nextTarget = Math.max(0, targetVisibleCount);\n      const requiredPages = Math.max(1, Math.ceil(nextTarget / forumBatchSize));\n      if (requiredPages <= loadedPageCount) {\n        setVisibleCount(Math.min(nextTarget, threadCount));\n        return;\n      }\n\n      setLoadingMore(true);\n      const collected = [...topics];\n      let totalCount = threadCount;\n      let fetchedPages = loadedPageCount;\n\n      for (let page = loadedPageCount + 1; page <= requiredPages; page += 1) {\n        const payloadResult = await fetchTopicsPage(page);\n        if (!payloadResult.ok) {\n          setDataError('Aiheiden lataus ep√§onnistui. P√§ivit√§ sivu ja yrit√§ uudelleen.');\n          break;\n        }\n        const payload = payloadResult.data;\n        const pageRows = normalizeTopics(payload.topics || []);\n        if (pageRows.length === 0) break;\n        collected.push(...pageRows);\n        totalCount = payload.total_count || totalCount;\n        fetchedPages = page;\n        if (collected.length >= totalCount) break;\n      }\n\n      setTopics(collected);\n      setThreadCount(totalCount);\n      setLoadedPageCount(fetchedPages);\n      setVisibleCount(Math.min(nextTarget, totalCount, collected.length));\n      setLoadingMore(false);\n    },\n    [fetchTopicsPage, forumBatchSize, loadedPageCount, normalizeTopics, setVisibleCount, threadCount, topics]\n  );\n\n  const handleShowMore = useCallback(async () => {\n    const nextVisibleTarget = visibleCount + forumBatchSize;\n    await loadMoreTopics(nextVisibleTarget);\n  }, [forumBatchSize, loadMoreTopics, visibleCount]);\n\n  const retryDataFetch = useCallback(() => {\n    setRefreshTick((prev) => prev + 1);\n  }, []);\n\n  useEffect(() => {\n    const fetchTopics = async () => {\n      setLoading(true);\n      setLoadingMore(false);\n      setDataError(null);\n      const preloadPages = Math.max(1, Math.ceil(forumUnreadBoostMax / forumBatchSize));\n      const collected: Topic[] = [];\n      let totalCount = 0;\n      let resolvedFilterTagIds: number[] | null = null;\n      let resolvedMatch: 'any' | 'all' = requestedTagMatch;\n\n      for (let page = 1; page <= preloadPages; page += 1) {\n        const payloadResult = await fetchTopicsPage(page);\n        if (!payloadResult.ok) {\n          setTopics([]);\n          setThreadCount(0);\n          setLoadedPageCount(0);\n          resetVisibleCount(forumInitialVisible);\n          setDataError('Aiheiden lataus ep√§onnistui. P√§ivit√§ sivu ja yrit√§ uudelleen.');\n          return err(payloadResult.error);\n        }\n        const payload = payloadResult.data;\n\n        const rows = payload.topics || [];\n        const normalizedRows = normalizeTopics(rows);\n        collected.push(...normalizedRows);\n        totalCount = payload.total_count || totalCount;\n        resolvedFilterTagIds = Array.isArray(payload.filter?.tag_ids)\n          ? payload.filter?.tag_ids.filter((id) => Number.isFinite(id) && id > 0)\n          : [];\n        resolvedMatch = payload.filter?.match === 'all' ? 'all' : 'any';\n\n        if (rows.length < forumBatchSize || collected.length >= totalCount || page >= preloadPages) {\n          setLoadedPageCount(page);\n          break;\n        }\n      }\n\n      if (\n        resolvedFilterTagIds\n        &&\n        (requestedTagIds.join(',') !== resolvedFilterTagIds.join(',') || requestedTagMatch !== resolvedMatch)\n      ) {\n        pushFilterUrl(resolvedFilterTagIds, resolvedMatch);\n      }\n\n      const unreadCount = collected.filter((topic) => topic.has_new).length;\n      const initialVisible =\n        unreadCount > forumInitialVisible\n          ? Math.min(Math.max(unreadCount, forumInitialVisible), forumUnreadBoostMax)\n          : forumInitialVisible;\n\n      setTopics(collected);\n      setThreadCount(totalCount);\n      resetVisibleCount(Math.min(initialVisible, Math.max(totalCount, 0)));\n      return ok(undefined);\n    };\n\n    const fetchMessageCount = async () => {\n      try {\n        const { count, error } = await supabase\n          .from('posts')\n          .select('id', { count: 'exact', head: true })\n          .is('deleted_at', null);\n\n        if (error) {\n          reportError({ scope: 'forum.fetchMessageCount', error });\n          return err(error);\n        }\n\n        setMessageCount(count || 0);\n        return ok(undefined);\n      } catch (error) {\n        reportError({ scope: 'forum.fetchMessageCount', error });\n        return err(error instanceof Error ? error : new Error('Message count fetch failed'));\n      }\n    };\n\n    const fetchAll = async () => {\n      const [topicsResult, messageCountResult] = await Promise.all([\n        fetchTopics(),\n        fetchMessageCount(),\n      ]);\n\n      if (!topicsResult.ok) {\n        setDataError('Aiheiden lataus ep√§onnistui. P√§ivit√§ sivu ja yrit√§ uudelleen.');\n      } else if (!messageCountResult.ok) {\n        setDataError('Viestim√§√§r√§n lataus ep√§onnistui. Osa tiedoista voi puuttua.');\n      }\n\n      setLoading(false);\n    };\n\n    void fetchAll();\n  }, [\n    fetchTopicsPage,\n    forumBatchSize,\n    forumInitialVisible,\n    forumUnreadBoostMax,\n    normalizeTopics,\n    pushFilterUrl,\n    refreshTick,\n    requestedTagIds,\n    requestedTagMatch,\n    resetVisibleCount,\n    supabase,\n  ]);\n\n  useEffect(() => {\n    if (!currentUser || !realtimeUpdatesEnabled) return;\n\n    const channel = supabase\n      .channel(`forum-live-${currentUser.id}`)\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'topics' }, () => {\n        setRefreshTick((prev) => prev + 1);\n      })\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, () => {\n        setRefreshTick((prev) => prev + 1);\n      })\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [supabase, currentUser, realtimeUpdatesEnabled]);\n\n  return {\n    topics,\n    threadCount,\n    messageCount,\n    dataError,\n    loading,\n    loadingMore,\n    requestedTagIds,\n    unreadOnly,\n    visibleCount,\n    handleShowMore,\n    pushUnreadOnlyUrl,\n    refreshTick,\n    retryDataFetch,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/usePostLikes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/useProfileStats.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/useShowMorePaging.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/hooks/useSupabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/cloudinary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/cloudinaryWidget.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/formatDate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/forum/parsers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/markdownShortcuts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/reportError.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/result.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/siteEvents.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'eventOccursOnDate' has a complexity of 13. Maximum allowed is 12.","line":31,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":31,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface RecurringSiteEvent {\n  id: number;\n  event_date: string;\n  repeats_yearly?: boolean;\n  date_range_enabled?: boolean;\n  range_start_date?: string | null;\n  range_end_date?: string | null;\n}\n\nfunction getMonthDayFromIsoDate(value: string | null | undefined): number | null {\n  if (!value || value.length < 10) return null;\n  const month = Number(value.slice(5, 7));\n  const day = Number(value.slice(8, 10));\n  if (!Number.isFinite(month) || !Number.isFinite(day) || month < 1 || month > 12 || day < 1 || day > 31) {\n    return null;\n  }\n  return month * 100 + day;\n}\n\nfunction getMonthDayFromDate(date: Date): number {\n  return (date.getMonth() + 1) * 100 + date.getDate();\n}\n\nfunction toIsoDateLocal(date: Date): string {\n  const y = date.getFullYear();\n  const m = String(date.getMonth() + 1).padStart(2, '0');\n  const d = String(date.getDate()).padStart(2, '0');\n  return `${y}-${m}-${d}`;\n}\n\nexport function eventOccursOnDate(event: RecurringSiteEvent, targetDate: Date): boolean {\n  const targetMonthDay = getMonthDayFromDate(targetDate);\n  const targetIso = toIsoDateLocal(targetDate);\n  const repeatsYearly = event.repeats_yearly !== false;\n\n  if (event.date_range_enabled) {\n    if (!event.range_start_date || !event.range_end_date) return false;\n\n    if (!repeatsYearly) {\n      return targetIso >= event.range_start_date && targetIso <= event.range_end_date;\n    }\n\n    const start = getMonthDayFromIsoDate(event.range_start_date);\n    const end = getMonthDayFromIsoDate(event.range_end_date);\n    if (start === null || end === null) return false;\n\n    // Recurring annual range. If start > end, the range wraps year-end.\n    if (start <= end) {\n      return targetMonthDay >= start && targetMonthDay <= end;\n    }\n    return targetMonthDay >= start || targetMonthDay <= end;\n  }\n\n  if (!repeatsYearly) {\n    return event.event_date === targetIso;\n  }\n\n  const singleDay = getMonthDayFromIsoDate(event.event_date);\n  return singleDay !== null && singleDay === targetMonthDay;\n}\n\nexport function getPreferredEventForDate<T extends RecurringSiteEvent>(\n  events: T[],\n  targetDate: Date\n): T | null {\n  const matches = events.filter((event) => eventOccursOnDate(event, targetDate));\n  if (matches.length === 0) return null;\n\n  const singleDayMatches = matches.filter((event) => !event.date_range_enabled);\n  const pool = singleDayMatches.length > 0 ? singleDayMatches : matches;\n\n  return [...pool].sort((a, b) => b.id - a.id)[0] ?? null;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/supabase/client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/supabase/middleware.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'isKnownLoggedInPath' has a complexity of 20. Maximum allowed is 12.","line":28,"column":1,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":28,"endColumn":29},{"ruleId":"complexity","severity":1,"message":"Async function 'updateSession' has a complexity of 16. Maximum allowed is 12.","line":53,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":53,"endColumn":36},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":53,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":53,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createServerClient } from '@supabase/ssr'\nimport { NextResponse, type NextRequest } from 'next/server'\n\nconst PUBLIC_PATHS = new Set(['/login', '/register'])\n\nfunction isLegacyForumPath(pathname: string): boolean {\n  return (\n    pathname === '/forum' ||\n    pathname === '/forum/' ||\n    pathname === '/forum/new' ||\n    pathname === '/forum/new/' ||\n    pathname === '/forum/search' ||\n    pathname === '/forum/search/' ||\n    pathname.startsWith('/forum/topic/')\n  )\n}\n\nfunction toCanonicalForumPath(pathname: string): string {\n  if (pathname === '/forum' || pathname === '/forum/') return '/'\n  if (pathname === '/forum/new' || pathname === '/forum/new/') return '/new'\n  if (pathname === '/forum/search' || pathname === '/forum/search/') return '/search'\n  if (pathname.startsWith('/forum/topic/')) {\n    return `/topic/${pathname.slice('/forum/topic/'.length)}`\n  }\n  return pathname\n}\n\nfunction isKnownLoggedInPath(pathname: string): boolean {\n  return (\n    pathname === '/' ||\n    pathname === '/members' ||\n    pathname.startsWith('/members/') ||\n    pathname === '/profile' ||\n    pathname.startsWith('/profile/') ||\n    pathname === '/admin' ||\n    pathname.startsWith('/admin/') ||\n    pathname === '/loki' ||\n    pathname.startsWith('/loki/') ||\n    pathname === '/pending-approval' ||\n    pathname.startsWith('/pending-approval/') ||\n    pathname === '/search' ||\n    pathname.startsWith('/search/') ||\n    pathname === '/new' ||\n    pathname.startsWith('/new/') ||\n    pathname.startsWith('/topic/') ||\n    pathname.startsWith('/api/') ||\n    pathname.startsWith('/midi/') ||\n    pathname === '/tags' ||\n    isLegacyForumPath(pathname)\n  )\n}\n\nexport async function updateSession(request: NextRequest) {\n  let supabaseResponse = NextResponse.next({\n    request,\n  })\n\n  const supabase = createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return request.cookies.getAll()\n        },\n        setAll(cookiesToSet) {\n          // Supabase SSR cookie bridge:\n          // write to request + response so refreshed session cookies are visible in this middleware pass\n          // and sent back to the browser. See docs/architecture.md.\n          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))\n          supabaseResponse = NextResponse.next({\n            request,\n          })\n          cookiesToSet.forEach(({ name, value, options }) =>\n            supabaseResponse.cookies.set(name, value, options)\n          )\n        },\n      },\n    }\n  )\n\n  const pathname = request.nextUrl.pathname\n\n  // Refresh session if expired\n  const { data: { user } } = await supabase.auth.getUser()\n\n  if (!user && !PUBLIC_PATHS.has(pathname)) {\n    return NextResponse.redirect(new URL('/login', request.url))\n  }\n\n  if (user) {\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('approval_status, is_admin')\n      .eq('id', user.id)\n      .single()\n\n    const approvalStatus = (profile?.approval_status ?? 'approved') as 'pending' | 'approved' | 'rejected'\n    const isAdmin = profile?.is_admin === true\n\n    if (approvalStatus !== 'approved' && pathname !== '/pending-approval') {\n      return NextResponse.redirect(new URL('/pending-approval', request.url))\n    }\n\n    if (pathname.startsWith('/pending-approval') && approvalStatus === 'approved') {\n      return NextResponse.redirect(new URL('/', request.url))\n    }\n\n    if (pathname.startsWith('/admin') && !isAdmin) {\n      return NextResponse.redirect(new URL('/', request.url))\n    }\n\n    if (isLegacyForumPath(pathname)) {\n      const redirectUrl = new URL(toCanonicalForumPath(pathname), request.url)\n      redirectUrl.search = request.nextUrl.search\n      return NextResponse.redirect(redirectUrl)\n    }\n\n    if (PUBLIC_PATHS.has(pathname) || !isKnownLoggedInPath(pathname)) {\n      return NextResponse.redirect(new URL('/', request.url))\n    }\n  }\n\n  return supabaseResponse\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/supabase/normalizeJoin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/supabase/server.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":18,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":27,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createServerClient, type CookieOptions } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        get(name: string) {\n          return cookieStore.get(name)?.value\n        },\n        set(name: string, value: string, options: CookieOptions) {\n          try {\n            cookieStore.set({ name, value, ...options })\n          } catch (error) {\n            // The `set` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n        remove(name: string, options: CookieOptions) {\n          try {\n            cookieStore.set({ name, value: '', ...options })\n          } catch (error) {\n            // The `delete` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/trophies.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/uiSettings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/lib/validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/test/setup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/src/types/linkify-it.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/eero/development/freakon/vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]